<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SISTEMA DE CAPTACI√ìN | MODO L√çDER</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        :root { --primary: #0f172a; --accent: #2563eb; --success: #059669; --bg: #f1f5f9; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); display: flex; justify-content: center; padding: 20px; text-transform: uppercase; }
        .card { background: white; padding: 30px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); width: 100%; max-width: 500px; text-align: center; }
        .input-group { text-align: left; margin-bottom: 12px; }
        label { display: block; font-size: 11px; font-weight: 800; margin-bottom: 4px; color: #64748b; }
        input { width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 10px; font-weight: 700; box-sizing: border-box; text-transform: uppercase; }
        button { width: 100%; padding: 15px; border: none; border-radius: 12px; font-weight: 900; cursor: pointer; transition: 0.3s; color: white; margin-top: 10px; text-transform: uppercase; }
        .btn-login { background: var(--primary); }
        .btn-save { background: var(--success); }
        .btn-excel { background: var(--accent); }
        .btn-template { background: #64748b; font-size: 11px; padding: 10px; margin-bottom: 5px; }
        #seccionFormulario { display: none; }
        .info-lider { background: #f8fafc; padding: 10px; border-radius: 10px; margin-bottom: 20px; border: 1px solid #e2e8f0; color: var(--accent); font-size: 12px; font-weight: 900; }
        #logErrores { background: #fff5f5; color: #c0392b; border: 1px solid #f5c6cb; padding: 15px; border-radius: 10px; margin-top: 15px; font-size: 11px; text-align: left; display: none; max-height: 200px; overflow-y: auto; }
    </style>
</head>
<body>

<div id="seccionLogin" class="card">
    <h2 style="font-weight: 900; letter-spacing: -1px;">üîê ACCESO DE L√çDER</h2>
    <input type="password" id="passLogin" placeholder="DIGITA TU C√âDULA" style="text-align: center;">
    <button class="btn-login" onclick="login()">INGRESAR AL SISTEMA</button>
</div>

<div id="seccionFormulario" class="card">
    <div id="txtBienvenida" class="info-lider"></div>

    <div style="text-align: left;">
        <h3 style="font-size: 14px; margin-bottom: 15px; border-left: 4px solid var(--success); padding-left: 10px;">CARGA INDIVIDUAL</h3>
        
        <div class="input-group">
            <label>C√âDULA (N√öMEROS) *</label>
            <input type="text" id="vCedula" oninput="this.value = this.value.replace(/[^0-9]/g, '')">
        </div>
        
        <div class="input-group">
            <label>NOMBRE COMPLETO (LETRAS) *</label>
            <input type="text" id="vNombre" oninput="this.value = this.value.toUpperCase().replace(/[^A-Z√ë√Å√â√ç√ì√ö ]/g, '')">
        </div>
        
        <div class="input-group">
            <label>TEL√âFONO (N√öMEROS) *</label>
            <input type="text" id="vTelefono" oninput="this.value = this.value.replace(/[^0-9]/g, '')">
        </div>
        
        <div class="input-group">
            <label>PUESTO DE VOTACI√ìN (OPCIONAL)</label>
            <input type="text" id="vPuesto" placeholder="ESCRIBE EL PUESTO" oninput="this.value = this.value.toUpperCase()">
        </div>
        
        <div class="input-group">
            <label>MESA</label>
            <input type="text" id="vMesa" oninput="this.value = this.value.replace(/[^0-9]/g, '')" placeholder="0">
        </div>

        <button class="btn-save" onclick="guardarManual()">GUARDAR EN NUBE</button>
    </div>

    <hr style="margin: 30px 0; border: 0; border-top: 2px dashed #e2e8f0;">

    <div style="text-align: left;">
        <h3 style="font-size: 14px; margin-bottom: 5px; border-left: 4px solid var(--accent); padding-left: 10px;">CARGA MASIVA EXCEL</h3>
        <button class="btn-template" onclick="descargarPlantilla()">üì• DESCARGAR PLANTILLA</button>
        <input type="file" id="inputExcel" accept=".xlsx, .xls">
        <button class="btn-excel" onclick="procesarExcel()">üöÄ PROCESAR EXCEL</button>
        <div id="progreso" style="font-weight: 900; color: var(--accent); margin-top: 10px; font-size: 12px;"></div>
    </div>

    <div id="logErrores"></div>
</div>

<script>
    const URL_S = 'https://pmwlkdariynhaqbqursp.supabase.co';
    const KEY_S = 'sb_publishable_zCu9cBa2qf9HqQuZ2YufzA_yTmwfiHv';
    const _supabase = supabase.createClient(URL_S, KEY_S);
    let usuarioActivo = null;

    async function login() {
        const pass = document.getElementById('passLogin').value;
        if(!pass) return;
        Swal.fire({ title: 'VALIDANDO...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });
        const { data } = await _supabase.from('VOTANTES').select('*').eq('cedula', pass).maybeSingle();
        Swal.close();
        if (data) {
            usuarioActivo = data;
            document.getElementById('seccionLogin').style.display = 'none';
            document.getElementById('seccionFormulario').style.display = 'block';
            document.getElementById('txtBienvenida').innerText = "üë§ L√çDER: " + data["Nombres y apellidos"].toUpperCase();
        } else {
            Swal.fire('ERROR', 'C√âDULA NO AUTORIZADA', 'error');
        }
    }

    // CARGA INDIVIDUAL CON DETECCI√ìN DE DUPLICADOS
    async function guardarManual() {
        const d = {
            cedula: document.getElementById('vCedula').value.trim(),
            "Nombres y apellidos": document.getElementById('vNombre').value.toUpperCase().trim(),
            telefono: document.getElementById('vTelefono').value.trim(),
            puesto: document.getElementById('vPuesto').value.toUpperCase().trim() || "POR ASIGNAR",
            mesa: document.getElementById('vMesa').value || "0",
            lider: usuarioActivo["Nombres y apellidos"].toUpperCase()
        };
        
        if(!d.cedula || !d["Nombres y apellidos"] || !d.telefono) {
            return Swal.fire('AVISO', 'LLENA LOS CAMPOS OBLIGATORIOS', 'warning');
        }

        const { error } = await _supabase.from('VOTANTES').insert([d]);
        
        if(error) {
            if(error.code === '23505') { // ERROR DE DUPLICADO EN POSTGRES
                Swal.fire('DUPLICADO', `LA C√âDULA ${d.cedula} YA EST√Å REGISTRADA`, 'error');
            } else {
                Swal.fire('ERROR', error.message, 'error');
            }
        } else {
            Swal.fire('√âXITO', 'GUARDADO', 'success'); 
            document.querySelectorAll('#seccionFormulario input:not([type="file"])').forEach(i => i.value = "");
        }
    }

    function descargarPlantilla() {
        const data = [["CEDULA", "NOMBRE", "TELEFONO", "PUESTO", "MESA"]];
        const ws = XLSX.utils.aoa_to_sheet(data);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "PLANTILLA");
        XLSX.writeFile(wb, "PLANTILLA_CARGA.xlsx");
    }

    // CARGA MASIVA CON DETECCI√ìN DE DUPLICADOS FILA POR FILA
    async function procesarExcel() {
        const file = document.getElementById('inputExcel').files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = async (e) => {
            const wb = XLSX.read(new Uint8Array(e.target.result), {type: 'array'});
            const registros = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
            Swal.fire({ title: 'CARGANDO...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });
            
            let exitos = 0, duplicados = 0, otrosErrores = 0;
            const log = document.getElementById('logErrores');
            log.style.display = 'none'; log.innerHTML = "<b>INFORME DE NO CARGADOS:</b><br>";

            for (let r of registros) {
                const cLimpia = String(r.cedula || r.CEDULA || "").replace(/[^0-9]/g, '');
                const tLimpio = String(r.telefono || r.TELEFONO || "").replace(/[^0-9]/g, '');
                const nLimpio = String(r.nombre || r.NOMBRE || r.nombre_completo || "").toUpperCase().replace(/[^A-Z√ë√Å√â√ç√ì√ö ]/g, '');

                if(!cLimpia || !nLimpio) { otrosErrores++; continue; }

                const fila = {
                    cedula: cLimpia,
                    "Nombres y apellidos": nLimpio,
                    telefono: tLimpio || "0",
                    puesto: String(r.puesto || r.PUESTO || "POR ASIGNAR").toUpperCase(),
                    mesa: String(r.mesa || r.MESA || "0").replace(/[^0-9]/g, ''),
                    lider: usuarioActivo["Nombres y apellidos"].toUpperCase()
                };

                const { error } = await _supabase.from('VOTANTES').insert([fila]);
                
                if(error) {
                    log.style.display = 'block';
                    if(error.code === '23505') {
                        duplicados++;
                        log.innerHTML += `‚ö†Ô∏è DUPLICADO: ${fila.cedula}<br>`;
                    } else {
                        otrosErrores++;
                        log.innerHTML += `‚ùå ERROR EN ${fila.cedula}: ${error.message}<br>`;
                    }
                } else {
                    exitos++;
                }
                document.getElementById('progreso').innerText = `PROCESANDO: ${exitos + duplicados + otrosErrores} / ${registros.length}`;
            }
            Swal.close();
            Swal.fire('CARGA FINALIZADA', `√âXITO: ${exitos}\nDUPLICADOS: ${duplicados}\nERRORES: ${otrosErrores}`, 'info');
        };
        reader.readAsArrayBuffer(file);
    }
</script>
</body>
</html>
