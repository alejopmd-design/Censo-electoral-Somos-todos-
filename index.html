<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gesti√≥n Electoral - Carga Pro</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        body { font-family: 'Segoe UI', Arial, sans-serif; background: #f0f4f8; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; }
        .card { background: white; padding: 30px; border-radius: 16px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); width: 100%; max-width: 480px; text-align: center; border-top: 5px solid #1a365d; }
        
        #seccionPanel { display: none; }
        
        h2 { color: #1a365d; margin-bottom: 15px; font-size: 22px; }
        input { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #d1d5db; border-radius: 8px; font-size: 15px; box-sizing: border-box; }
        input:required { border-left: 4px solid #e53e3e; } /* Marca visual para obligatorios */
        
        .btn { width: 100%; padding: 14px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 15px; transition: 0.3s; margin-top: 10px; }
        .btn-login { background: #1a365d; color: white; }
        .btn-manual { background: #2f855a; color: white; }
        .btn-masiva { background: #2c5282; color: white; }

        .drop-zone { border: 2px dashed #a0aec0; padding: 25px; border-radius: 12px; cursor: pointer; margin-top: 15px; color: #4a5568; transition: 0.3s; }
        .drop-zone:hover { border-color: #1a365d; background: #ebf4ff; }
        
        .divider { margin: 20px 0; border-bottom: 1px solid #e2e8f0; position: relative; }
        .divider span { position: absolute; top: -10px; left: 50%; transform: translateX(-50%); background: white; padding: 0 12px; color: #a0aec0; font-size: 11px; font-weight: bold; }
        
        .logout { margin-top: 15px; color: #718096; cursor: pointer; font-size: 13px; text-decoration: underline; background: none; border: none; }
        .required-hint { font-size: 12px; color: #e53e3e; text-align: left; margin-top: -5px; margin-bottom: 5px; }
    </style>
</head>
<body>

    <div id="seccionLogin" class="card">
        <h2>Acceso Administrativo</h2>
        <p style="color:#718096">Ingrese su c√©dula para autorizar el cargue</p>
        <input type="number" id="cedulaAuth" placeholder="N√∫mero de C√©dula">
        <button class="btn btn-login" onclick="validarIngreso()">Validar e Ingresar</button>
    </div>

    <div id="seccionPanel" class="card">
        <h2>Carga de Datos</h2>
        <p style="font-size: 13px; color: #718096;">* Nombre, C√©dula y Tel√©fono son obligatorios</p>
        
        <div id="formManual">
            <input type="text" id="campo1" placeholder="Nombre completo *" required>
            <input type="number" id="campo2" placeholder="C√©dula *" required>
            <input type="text" id="campo6" placeholder="Tel√©fono / Contacto *" required>
            
            <div class="divider"><span>DATOS OPCIONALES</span></div>
            
            <input type="text" id="campo3" placeholder="Puesto de Votaci√≥n">
            <input type="text" id="campo4" placeholder="Mesa">
            <input type="text" id="campo5" placeholder="L√≠der Responsable">
            
            <button class="btn btn-manual" onclick="ejecutarCargaManual()">Guardar Registro Manual</button>
        </div>

        <div class="divider"><span>O CARGA MASIVA</span></div>

        <div class="drop-zone" onclick="document.getElementById('inputExcel').click()">
            <span id="labelArchivo">üìÅ Seleccionar Excel (.xlsx, .xls, .csv)</span>
            <input type="file" id="inputExcel" hidden accept=".xlsx, .xls, .xlsm, .csv">
        </div>
        <button class="btn btn-masiva" onclick="ejecutarCargaMasiva()">Iniciar Carga Masiva</button>
        
        <button class="logout" onclick="location.reload()">Cerrar Sesi√≥n</button>
    </div>

<script>
    const SUPA_URL = 'https://pmwlkdariynhaqbqursp.supabase.co';
    const SUPA_KEY = 'sb_publishable_zCu9cBa2qf9HqQuZ2YufzA_yTmwfiHv';
    const _supabase = supabase.createClient(SUPA_URL, SUPA_KEY);

    async function validarIngreso() {
        const ced = document.getElementById('cedulaAuth').value;
        if(!ced) return Swal.fire('Error', 'Ingrese su c√©dula', 'error');

        const { data, error } = await _supabase.from('VOTANTES').select('*').eq('cedula', ced).single();

        if (data) {
            document.getElementById('seccionLogin').style.display = 'none';
            document.getElementById('seccionPanel').style.display = 'block';
        } else {
            Swal.fire('Acceso Denegado', 'C√©dula no autorizada', 'error');
        }
    }

    // CARGA MANUAL CON VALIDACI√ìN DE 3 OBLIGATORIOS
    async function ejecutarCargaManual() {
        const registro = {
            "Nombres y apellidos": document.getElementById('campo1').value,
            "cedula": document.getElementById('campo2').value,
            "contacto": document.getElementById('campo6').value, // Obligatorio
            "puesto": document.getElementById('campo3').value || null,
            "mesa": document.getElementById('campo4').value || null,
            "lider": document.getElementById('campo5').value || null
        };

        // Verificaci√≥n estricta de los 3 datos obligatorios
        if(!registro.cedula || !registro["Nombres y apellidos"] || !registro.contacto) {
            return Swal.fire('Faltan Datos', 'Nombre, C√©dula y Tel√©fono son obligatorios para guardar.', 'warning');
        }

        const { error } = await _supabase.from('VOTANTES').insert([registro]);
        
        if (error) {
            Swal.fire('Error', 'No se pudo guardar: ' + error.message, 'error');
        } else {
            Swal.fire('√âxito', 'Registro guardado correctamente', 'success');
            document.querySelectorAll('#formManual input').forEach(i => i.value = '');
        }
    }

    // CARGA MASIVA CON REPORTE DE ERRORES
    document.getElementById('inputExcel').addEventListener('change', e => {
        if(e.target.files[0]) document.getElementById('labelArchivo').innerText = "üìÑ " + e.target.files[0].name;
    });

    async function ejecutarCargaMasiva() {
        const file = document.getElementById('inputExcel').files[0];
        if(!file) return Swal.fire('Error', 'Seleccione un archivo', 'warning');

        Swal.fire({ title: 'Procesando...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });

        const reader = new FileReader();
        reader.onload = async (e) => {
            try {
                const workbook = XLSX.read(new Uint8Array(e.target.result), { type: 'array' });
                const registros = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);

                let ok = 0;
                let fallos = [];

                for (const fila of registros) {
                    const obj = {
                        "Nombres y apellidos": fila["Nombres y apellidos"] || fila["nombre"],
                        "cedula": fila["cedula"] || fila["CEDULA"],
                        "contacto": fila["contacto"] || fila["telefono"] || fila["TELEFONO"],
                        "puesto": fila["puesto"] || null,
                        "mesa": fila["mesa"] || null,
                        "lider": fila["lider"] || null
                    };

                    // Validaci√≥n de obligatorios en el Excel
                    if(!obj.cedula || !obj["Nombres y apellidos"] || !obj.contacto) {
                        fallos.push(`<li><b>Fila incompleta:</b> Falta Nombre, C√©dula o Tel√©fono</li>`);
                        continue;
                    }

                    const { error } = await _supabase.from('VOTANTES').insert([obj]);
                    if (error) {
                        let msg = error.code === '23505' ? 'C√©dula Duplicada' : 'Error de formato';
                        fallos.push(`<li><b>CC ${obj.cedula}:</b> ${msg}</li>`);
                    } else {
                        ok++;
                    }
                }

                Swal.fire({
                    title: fallos.length === 0 ? 'Carga Exitosa' : 'Reporte de Carga',
                    icon: fallos.length === 0 ? 'success' : 'warning',
                    html: `
                        <div style="text-align: left;">
                            <p style="color:green">‚úÖ Exitosos: ${ok}</p>
                            ${fallos.length > 0 ? `<p style="color:red">‚ùå Fallidos: ${fallos.length}</p><hr><ul style="max-height:150px; overflow-y:auto; background:#fff1f1; padding:10px; border-radius:8px; font-size:12px;">${fallos.join('')}</ul>` : ''}
                        </div>
                    `
                });
            } catch (err) {
                Swal.fire('Error', 'No se pudo leer el archivo', 'error');
            }
        };
        reader.readAsArrayBuffer(file);
    }
</script>
</body>
</html>
