<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gesti√≥n Electoral - Registro y Carga</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f0f2f5; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; }
        .card { background: white; padding: 30px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); width: 100%; max-width: 450px; text-align: center; }
        h2 { color: #1a365d; }
        input { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #ddd; border-radius: 10px; box-sizing: border-box; }
        .btn { width: 100%; padding: 15px; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; margin-top: 10px; color: white; }
        .btn-green { background: #2f855a; }
        .btn-blue { background: #1a365d; }
        .upload-box { border: 2px dashed #cbd5e0; padding: 25px; border-radius: 15px; cursor: pointer; margin-top: 20px; color: #718096; }
        .divider { margin: 25px 0; border-bottom: 1px solid #eee; position: relative; }
        .divider span { position: absolute; top: -10px; left: 50%; transform: translateX(-50%); background: white; padding: 0 10px; color: #999; font-size: 12px; }
    </style>
</head>
<body>

<div class="card">
    <h2>Registro de Votantes</h2>
    
    <div id="formManual">
        <input type="text" id="nombre" placeholder="Nombre completo *">
        <input type="number" id="cedula" placeholder="C√©dula *">
        <input type="text" id="telefono" placeholder="Tel√©fono *">
        <input type="text" id="puesto" placeholder="Puesto de votaci√≥n (Opcional)">
        <input type="text" id="mesa" placeholder="Mesa (Opcional)">
        <input type="text" id="observaciones" placeholder="Observaciones (Opcional)">
        <button class="btn btn-green" onclick="guardarManual()">Guardar Registro Manual</button>
    </div>

    <div class="divider"><span>O CARGA MASIVA</span></div>

    <div class="upload-box" onclick="document.getElementById('inputExcel').click()">
        <span id="fileTxt">üìÅ Seleccionar archivo Excel (.xlsx)</span>
        <input type="file" id="inputExcel" hidden accept=".xlsx, .xls, .csv">
    </div>
    <button class="btn btn-blue" onclick="procesarMasivo()">Iniciar Carga Masiva</button>
</div>

<script>
    const SB_URL = 'https://pmwlkdariynhaqbqursp.supabase.co';
    const SB_KEY = 'sb_publishable_zCu9cBa2qf9HqQuZ2YufzA_yTmwfiHv';
    const _supabase = supabase.createClient(SB_URL, SB_KEY);

    // Guardar Manual
    async function guardarManual() {
        const datos = {
            "Nombres y apellidos": document.getElementById('nombre').value,
            "cedula": document.getElementById('cedula').value,
            "contacto": document.getElementById('telefono').value,
            "puesto": document.getElementById('puesto').value || null,
            "mesa": document.getElementById('mesa').value || null,
            "observaciones": document.getElementById('observaciones').value || null
        };

        if(!datos.cedula || !datos["Nombres y apellidos"] || !datos.contacto) {
            return Swal.fire('Error', 'C√©dula, Nombre y Tel√©fono son obligatorios.', 'warning');
        }

        const { error } = await _supabase.from('VOTANTES').insert([datos]);
        if (error) {
            const msg = error.code === '23505' ? 'Esta c√©dula ya existe.' : error.message;
            Swal.fire('Error', msg, 'error');
        } else {
            Swal.fire('√âxito', 'Registrado correctamente', 'success');
            document.querySelectorAll('input').forEach(i => i.value = '');
        }
    }

    // Procesar Excel
    document.getElementById('inputExcel').addEventListener('change', e => {
        if(e.target.files[0]) document.getElementById('fileTxt').innerText = "üìÑ " + e.target.files[0].name;
    });

    async function procesarMasivo() {
        const file = document.getElementById('inputExcel').files[0];
        if(!file) return Swal.fire('Error', 'Selecciona un archivo', 'warning');

        Swal.fire({ title: 'Procesando...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });

        const reader = new FileReader();
        reader.onload = async (e) => {
            const workbook = XLSX.read(new Uint8Array(e.target.result), { type: 'array' });
            const registros = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
            
            let ok = 0, fallos = [];

            for (const r of registros) {
                // Mapeo flexible de nombres de columnas
                const item = {
                    "Nombres y apellidos": r["Nombres y apellidos"] || r["nombre"] || r["Nombre"],
                    "cedula": r["cedula"] || r["CEDULA"] || r["Cedula"],
                    "contacto": r["contacto"] || r["telefono"] || r["TELEFONO"] || r["Telefono"],
                    "puesto": r["puesto"] || r["Puesto"] || null,
                    "mesa": r["mesa"] || r["Mesa"] || null,
                    "observaciones": r["observaciones"] || r["Observaciones"] || r["lider"] || null
                };

                // Si faltan obligatorios
                if(!item.cedula || !item["Nombres y apellidos"] || !item.contacto) {
                    fallos.push(`<li><b>${item.cedula || 'Sin CC'}:</b> Faltan Datos Obligatorios</li>`);
                    continue;
                }

                const { error } = await _supabase.from('VOTANTES').insert([item]);
                
                if (error) {
                    // Si el error es c√≥digo 23505 significa que la c√©dula ya existe
                    let razon = error.code === '23505' ? 'Ya existe' : 'Error t√©cnico';
                    fallos.push(`<li><b>${item.cedula}:</b> ${razon}</li>`);
                } else {
                    ok++;
                }
            }

            Swal.fire({
                title: 'Resultado de Carga',
                html: `<div style="text-align:left">‚úÖ Exitosos: ${ok}<br>‚ùå No aceptados: ${fallos.length}<hr><ul style="font-size:12px; max-height:150px; overflow-y:auto; background:#fff5f5; padding:10px; border-radius:8px;">${fallos.join('')}</ul></div>`,
                icon: fallos.length > 0 ? 'warning' : 'success'
            });
        };
        reader.readAsArrayBuffer(file);
    }
</script>
</body>
</html>
