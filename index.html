<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gesti√≥n Electoral Pro</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        body { font-family: 'Segoe UI', Arial, sans-serif; background: #f0f4f8; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; }
        .card { background: white; padding: 30px; border-radius: 16px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); width: 100%; max-width: 480px; text-align: center; border-top: 5px solid #1a365d; }
        
        #seccionPanel { display: none; }
        
        h2 { color: #1a365d; margin-bottom: 15px; font-size: 22px; }
        input { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #d1d5db; border-radius: 8px; font-size: 15px; box-sizing: border-box; }
        
        .btn { width: 100%; padding: 14px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 15px; transition: 0.3s; margin-top: 10px; }
        .btn-login { background: #1a365d; color: white; }
        .btn-manual { background: #2f855a; color: white; }
        .btn-masiva { background: #2c5282; color: white; }

        .drop-zone { border: 2px dashed #a0aec0; padding: 25px; border-radius: 12px; cursor: pointer; margin-top: 15px; color: #4a5568; transition: 0.3s; }
        .drop-zone:hover { border-color: #1a365d; background: #ebf4ff; }
        
        .divider { margin: 20px 0; border-bottom: 1px solid #e2e8f0; position: relative; }
        .divider span { position: absolute; top: -10px; left: 50%; transform: translateX(-50%); background: white; padding: 0 12px; color: #a0aec0; font-size: 11px; font-weight: bold; }
        
        .logout { margin-top: 15px; color: #718096; cursor: pointer; font-size: 13px; text-decoration: underline; background: none; border: none; }
    </style>
</head>
<body>

    <div id="seccionLogin" class="card">
        <h2>Acceso Administrativo</h2>
        <p style="color:#718096">Ingrese su c√©dula para autorizar el cargue</p>
        <input type="number" id="cedulaAuth" placeholder="N√∫mero de C√©dula">
        <button class="btn btn-login" onclick="validarIngreso()">Validar e Ingresar</button>
    </div>

    <div id="seccionPanel" class="card">
        <h2>Carga de Datos (6 Campos)</h2>
        
        <div id="formManual">
            <input type="text" id="campo1" placeholder="Nombres y Apellidos">
            <input type="number" id="campo2" placeholder="C√©dula">
            <input type="text" id="campo3" placeholder="Puesto de Votaci√≥n">
            <input type="text" id="campo4" placeholder="Mesa">
            <input type="text" id="campo5" placeholder="L√≠der Responsable">
            <input type="text" id="campo6" placeholder="Tel√©fono / Contacto">
            <button class="btn btn-manual" onclick="ejecutarCargaManual()">Guardar Registro Manual</button>
        </div>

        <div class="divider"><span>O CARGA MASIVA MULTI-FORMATO</span></div>

        <div class="drop-zone" onclick="document.getElementById('inputExcel').click()">
            <span id="labelArchivo">üìÅ Seleccionar Excel (.xlsx, .xls, .xlsm, .csv)</span>
            <input type="file" id="inputExcel" hidden accept=".xlsx, .xls, .xlsm, .csv, .xlsb">
        </div>
        <button class="btn btn-masiva" onclick="ejecutarCargaMasiva()">Iniciar Carga Masiva</button>
        
        <button class="logout" onclick="location.reload()">Cerrar Sesi√≥n</button>
    </div>

<script>
    // Configuraci√≥n Base de Datos
    const SUPA_URL = 'https://pmwlkdariynhaqbqursp.supabase.co';
    const SUPA_KEY = 'sb_publishable_zCu9cBa2qf9HqQuZ2YufzA_yTmwfiHv';
    const _supabase = supabase.createClient(SUPA_URL, SUPA_KEY);

    // 1. VALIDACI√ìN DE ENTRADA
    async function validarIngreso() {
        const ced = document.getElementById('cedulaAuth').value;
        if(!ced) return Swal.fire('Error', 'Ingrese su c√©dula', 'error');

        // Busca en la tabla VOTANTES si el admin existe
        const { data, error } = await _supabase.from('VOTANTES').select('*').eq('cedula', ced).single();

        if (data) {
            document.getElementById('seccionLogin').style.display = 'none';
            document.getElementById('seccionPanel').style.display = 'block';
        } else {
            Swal.fire('Acceso Denegado', 'Usted no tiene permisos de administrador', 'error');
        }
    }

    // 2. CARGA MANUAL (6 CAMPOS)
    async function ejecutarCargaManual() {
        const registro = {
            "Nombres y apellidos": document.getElementById('campo1').value,
            "cedula": document.getElementById('campo2').value,
            "puesto": document.getElementById('campo3').value,
            "mesa": document.getElementById('campo4').value,
            "lider": document.getElementById('campo5').value,
            "contacto": document.getElementById('campo6').value
        };

        if(!registro.cedula || !registro["Nombres y apellidos"]) {
            return Swal.fire('Error', 'Nombre y C√©dula son obligatorios', 'warning');
        }

        const { error } = await _supabase.from('VOTANTES').insert([registro]);
        
        if (error) {
            Swal.fire('Error', 'No se pudo guardar: ' + error.message, 'error');
        } else {
            Swal.fire('√âxito', 'Registro manual guardado', 'success');
            document.querySelectorAll('#formManual input').forEach(i => i.value = '');
        }
    }

    // 3. CARGA MASIVA MULTI-FORMATO Y REPORTE DE ERRORES
    document.getElementById('inputExcel').addEventListener('change', e => {
        if(e.target.files[0]) document.getElementById('labelArchivo').innerText = "‚úÖ " + e.target.files[0].name;
    });

    async function ejecutarCargaMasiva() {
        const file = document.getElementById('inputExcel').files[0];
        if(!file) return Swal.fire('Error', 'Suba un archivo de Excel', 'warning');

        Swal.fire({ title: 'Procesando Archivo...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });

        const reader = new FileReader();
        reader.onload = async (e) => {
            try {
                const data = new Uint8Array(e.target.result);
                // Carga el libro detectando cualquier formato (xlsx, xls, csv, etc)
                const workbook = XLSX.read(data, { type: 'array' });
                const nombreHoja = workbook.SheetNames[0];
                const registros = XLSX.utils.sheet_to_json(workbook.Sheets[nombreHoja]);

                let correctos = 0;
                let fallidos = [];

                for (const fila of registros) {
                    // Mapeo din√°mico de los 6 campos
                    const objetoInsert = {
                        "Nombres y apellidos": fila["Nombres y apellidos"] || fila["NOMBRE"] || fila["nombre"],
                        "cedula": fila["cedula"] || fila["CEDULA"] || fila["Cedula"],
                        "puesto": fila["puesto"] || fila["PUESTO"],
                        "mesa": fila["mesa"] || fila["MESA"],
                        "lider": fila["lider"] || fila["LIDER"],
                        "contacto": fila["contacto"] || fila["telefono"] || fila["TELEFONO"]
                    };

                    const { error } = await _supabase.from('VOTANTES').insert([objetoInsert]);
                    
                    if (error) {
                        let motivo = error.code === '23505' ? 'C√©dula Repetida' : 'Faltan Datos';
                        fallidos.push(`<li><b>${objetoInsert.cedula || 'Sin ID'}:</b> ${motivo}</li>`);
                    } else {
                        correctos++;
                    }
                }

                if (fallidos.length === 0) {
                    Swal.fire('Carga Completada', `Se cargaron ${correctos} registros exitosamente.`, 'success');
                } else {
                    Swal.fire({
                        title: 'Reporte de Carga',
                        icon: 'warning',
                        html: `
                            <div style="text-align: left; font-size: 14px;">
                                <p style="color:green">‚úÖ Exitosos: ${correctos}</p>
                                <p style="color:red">‚ùå No aceptados: ${fallidos.length}</p>
                                <hr>
                                <p><b>Detalle de errores:</b></p>
                                <ul style="max-height: 150px; overflow-y: auto; background:#fff1f1; padding:10px; border-radius:8px;">
                                    ${fallidos.join('')}
                                </ul>
                            </div>
                        `
                    });
                }
            } catch (err) {
                Swal.fire('Error', 'El formato del archivo no es legible.', 'error');
            }
        };
        reader.readAsArrayBuffer(file);
    }
</script>
</body>
</html>
