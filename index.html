<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema Electoral - Gesti√≥n Integral</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root { --primary: #1a365d; --secondary: #2d3748; --accent: #38a169; }
        body { font-family: 'Segoe UI', sans-serif; background: #f4f7f6; margin: 0; padding: 20px; display: flex; justify-content: center; }
        .main-card { background: white; padding: 30px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); width: 100%; max-width: 500px; }
        h2 { text-align: center; color: var(--primary); margin-bottom: 25px; }
        
        /* Tabs para navegar */
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid #eee; padding-bottom: 10px; }
        .tab-btn { flex: 1; padding: 10px; border: none; background: none; cursor: pointer; font-weight: bold; color: #718096; }
        .tab-btn.active { color: var(--primary); border-bottom: 3px solid var(--primary); }

        .section { display: none; }
        .section.active { display: block; }

        input, select { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #cbd5e0; border-radius: 8px; box-sizing: border-box; }
        .btn { width: 100%; padding: 15px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; transition: 0.3s; margin-top: 10px; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-accent { background: var(--accent); color: white; }

        .upload-area { border: 2px dashed #cbd5e0; padding: 30px; text-align: center; border-radius: 12px; cursor: pointer; margin: 15px 0; }
        .upload-area:hover { background: #f8fafc; border-color: var(--primary); }
    </style>
</head>
<body>

<div class="main-card">
    <h2>Control Electoral 2026</h2>

    <div class="tabs">
        <button class="tab-btn active" onclick="showSection('consulta')">CONSULTA</button>
        <button class="tab-btn" onclick="showSection('manual')">MANUAL</button>
        <button class="tab-btn" onclick="showSection('masiva')">EXCEL</button>
    </div>

    <div id="consulta" class="section active">
        <p style="text-align:center; color:#666;">Ingrese la c√©dula para verificar registro</p>
        <input type="number" id="cedulaBusqueda" placeholder="N√∫mero de C√©dula">
        <button class="btn btn-primary" onclick="buscarCedula()">Buscar Votante</button>
    </div>

    <div id="manual" class="section">
        <input type="text" id="m_nombre" placeholder="Nombres y apellidos">
        <input type="number" id="m_cedula" placeholder="C√©dula">
        <input type="text" id="m_puesto" placeholder="Puesto de Votaci√≥n">
        <input type="text" id="m_lider" placeholder="L√≠der responsable">
        <button class="btn btn-accent" onclick="cargarManual()">Guardar Registro</button>
    </div>

    <div id="masiva" class="section">
        <div class="upload-area" onclick="document.getElementById('archivoExcel').click()">
            <span id="fileName">üìÇ Seleccionar Excel (.xlsx)</span>
            <input type="file" id="archivoExcel" hidden accept=".xlsx">
        </div>
        <button class="btn btn-primary" onclick="procesarMasivo()">Iniciar Carga Masiva</button>
    </div>
</div>

<script>
    const SB_URL = 'https://pmwlkdariynhaqbqursp.supabase.co';
    const SB_KEY = 'sb_publishable_zCu9cBa2qf9HqQuZ2YufzA_yTmwfiHv';
    const _supabase = supabase.createClient(SB_URL, SB_KEY);

    function showSection(id) {
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        event.target.classList.add('active');
    }

    // --- L√ìGICA DE CONSULTA ---
    async function buscarCedula() {
        const ced = document.getElementById('cedulaBusqueda').value;
        if(!ced) return Swal.fire('Error', 'Ingrese una c√©dula', 'error');
        
        const { data, error } = await _supabase.from('VOTANTES').select('*').eq('cedula', ced).single();
        if (data) {
            Swal.fire('Registrado', `Votante: ${data["Nombres y apellidos"]}\nPuesto: ${data.puesto}`, 'success');
        } else {
            Swal.fire('No encontrado', 'La c√©dula no est√° en la base de datos', 'info');
        }
    }

    // --- L√ìGICA CARGA MANUAL ---
    async function cargarManual() {
        const nuevo = {
            "Nombres y apellidos": document.getElementById('m_nombre').value,
            cedula: document.getElementById('m_cedula').value,
            puesto: document.getElementById('m_puesto').value,
            lider: document.getElementById('m_lider').value
        };

        const { error } = await _supabase.from('VOTANTES').insert([nuevo]);
        if (error) {
            Swal.fire('Error', 'La c√©dula ya existe o faltan datos', 'error');
        } else {
            Swal.fire('√âxito', 'Registro guardado', 'success');
            document.querySelectorAll('#manual input').forEach(i => i.value = '');
        }
    }

    // --- L√ìGICA CARGA MASIVA CON REPORTE DE ERRORES ---
    document.getElementById('archivoExcel').addEventListener('change', e => {
        document.getElementById('fileName').innerText = e.target.files[0].name;
    });

    async function procesarMasivo() {
        const file = document.getElementById('archivoExcel').files[0];
        if (!file) return Swal.fire('Error', 'Suba un archivo', 'error');

        Swal.fire({ title: 'Procesando...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });

        const reader = new FileReader();
        reader.onload = async (e) => {
            const workbook = XLSX.read(new Uint8Array(e.target.result), { type: 'array' });
            const registros = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);

            let ok = 0, fallos = [];

            for (const r of registros) {
                const { error } = await _supabase.from('VOTANTES').insert([r]);
                if (error) {
                    fallos.push(`<li><b>${r["Nombres y apellidos"] || 'Sin nombre'}:</b> ${error.code === '23505' ? 'C√©dula Duplicada' : error.message}</li>`);
                } else {
                    ok++;
                }
            }

            if (fallos.length === 0) {
                Swal.fire('√âxito', `Se cargaron ${ok} registros correctamente.`, 'success');
            } else {
                Swal.fire({
                    title: 'Carga con Errores',
                    icon: 'warning',
                    html: `<div style="text-align:left">‚úÖ Exitosos: ${ok}<br>‚ùå Fallidos: ${fallos.length}<hr><ul style="font-size:0.8rem; max-height:150px; overflow-y:auto">${fallos.join('')}</ul></div>`
                });
            }
        };
        reader.readAsArrayBuffer(file);
    }
</script>
</body>
</html>

