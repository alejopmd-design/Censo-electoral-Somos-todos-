<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Censo Electoral Pro</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        :root { --primary: #1a73e8; --success: #28a745; --bg: #f0f2f5; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); display: flex; justify-content: center; padding: 20px; margin: 0; }
        .card { background: white; padding: 30px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); width: 100%; max-width: 550px; text-align: center; }
        .section-title { background: #e8f0fe; padding: 12px; border-radius: 8px; margin: 25px 0 15px 0; font-size: 16px; font-weight: bold; color: var(--primary); border-left: 5px solid var(--primary); text-align: left; }
        .input-group { text-align: left; margin-bottom: 15px; }
        label { display: block; font-size: 13px; font-weight: 600; margin-bottom: 5px; color: #444; }
        input, textarea { width: 100%; padding: 12px; border: 2px solid #edeff2; border-radius: 10px; box-sizing: border-box; font-size: 15px; }
        button { width: 100%; padding: 14px; border: none; border-radius: 12px; font-size: 16px; font-weight: bold; cursor: pointer; margin-top: 10px; color: white; }
        .btn-login { background: var(--primary); }
        .btn-save { background: var(--success); }
        .btn-template { background: #6c757d; font-size: 13px; }
        #seccionFormulario, #logErrores { display: none; }
        #logErrores { background: #fff5f5; color: #c0392b; border: 1px solid #f5c6cb; padding: 15px; border-radius: 10px; margin-top: 20px; text-align: left; max-height: 200px; overflow-y: auto; }
        .user-info { font-size: 14px; background: #f8f9fa; padding: 10px 20px; border-radius: 50px; display: inline-block; margin-bottom: 20px; font-weight: bold; color: var(--primary); }
    </style>
</head>
<body>

<div id="seccionLogin" class="card">
    <h2>üîê Acceso al Censo</h2>
    <div class="input-group">
        <label>N√∫mero de C√©dula</label>
        <input type="password" id="passLogin" placeholder="Ingresa tu c√©dula">
    </div>
    <button class="btn-login" onclick="login()">INGRESAR</button>
</div>

<div id="seccionFormulario" class="card">
    <div class="user-info" id="txtBienvenida"></div>
    
    <div class="section-title">üìù Registro Individual</div>
    <div class="input-group"><label>C√©dula * (Obligatorio)</label><input type="text" id="vCedula"></div>
    <div class="input-group"><label>Nombre Completo * (Obligatorio)</label><input type="text" id="vNombre"></div>
    <div class="input-group"><label>Tel√©fono * (Obligatorio)</label><input type="text" id="vTelefono"></div>
    
    <div class="input-group"><label>Direcci√≥n (Opcional)</label><input type="text" id="vDireccion"></div>
    <div class="input-group"><label>Puesto de Votaci√≥n (Opcional)</label><input type="text" id="vPuesto"></div>
    <div class="input-group"><label>Observaciones (Opcional)</label><textarea id="vObs"></textarea></div>
    
    <button class="btn-save" onclick="procesarRegistroManual()">üíæ GUARDAR INDIVIDUAL</button>

    <hr style="margin:30px 0; border:0; border-top:1px solid #eee;">

    <div class="section-title">üìÇ Carga Masiva (Excel)</div>
    <p style="font-size: 12px; color: #666; margin-bottom: 10px;">Solo C√©dula, Nombre y Tel√©fono son requeridos en el archivo.</p>
    <button class="btn-template" onclick="descargarPlantilla()">‚¨áÔ∏è DESCARGAR PLANTILLA</button>
    <input type="file" id="inputExcel" accept=".xlsx, .xls, .csv" style="margin-top:20px;">
    <button style="background: var(--primary);" onclick="cargarExcel()">üöÄ SUBIR EXCEL</button>
    
    <div id="progresoCarga" style="margin-top:15px; font-weight:bold; color:var(--primary);"></div>
    <div id="logErrores"></div>

    <button onclick="location.reload()" style="background:none; color:gray; text-decoration:underline; border:none; margin-top:30px;">Cerrar Sesi√≥n</button>
</div>

<script>
    const URL_SUPA = 'https://pmwlkdariynhaqbqursp.supabase.co';
    const KEY_SUPA = 'sb_publishable_zCu9cBa2qf9HqQuZ2YufzA_yTmwfiHv';
    const _supabase = supabase.createClient(URL_SUPA, KEY_SUPA);
    let usuarioActivo = null;

    async function login() {
        const pass = document.getElementById('passLogin').value.trim();
        if (!pass) return Swal.fire('Aviso', 'Ingresa tu c√©dula', 'warning');

        const { data, error } = await _supabase.from('VOTANTES').select('*').eq('cedula', pass).maybeSingle();

        if (data) {
            usuarioActivo = data;
            document.getElementById('txtBienvenida').innerText = "üë§ L√çDER: " + data["Nombres y apellidos"].toUpperCase();
            document.getElementById('seccionLogin').style.display = 'none';
            document.getElementById('seccionFormulario').style.display = 'block';
        } else {
            Swal.fire('Error', 'C√©dula no encontrada en la base de datos.', 'error');
        }
    }

    async function procesarRegistroManual() {
        const d = {
            cedula: document.getElementById('vCedula').value.trim(),
            "Nombres y apellidos": document.getElementById('vNombre').value.trim(),
            direccion: document.getElementById('vDireccion').value.trim() || "No aplica",
            telefono: document.getElementById('vTelefono').value.trim(),
            puesto: document.getElementById('vPuesto').value.trim() || "No aplica",
            observaciones: document.getElementById('vObs').value.trim() || "",
            lider: usuarioActivo["Nombres y apellidos"]
        };

        // Solo validamos C√©dula, Nombre y Tel√©fono
        if(!d.cedula || !d["Nombres y apellidos"] || !d.telefono) {
            return Swal.fire('Atenci√≥n', 'C√©dula, Nombre y Tel√©fono son obligatorios', 'warning');
        }

        const { data: existe } = await _supabase.from('VOTANTES').select('cedula').eq('cedula', d.cedula).maybeSingle();
        if (existe) return Swal.fire('Error', 'Esta c√©dula ya existe.', 'error');

        const { error } = await _supabase.from('VOTANTES').insert([d]);
        if(!error) {
            Swal.fire('√âxito', 'Registrado correctamente', 'success');
            document.querySelectorAll('#seccionFormulario input, textarea').forEach(i => i.value = "");
        }
