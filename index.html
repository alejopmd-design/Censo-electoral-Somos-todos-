<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Carga Masiva de Votantes</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background-color: #f4f7f6; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            height: 100vh; 
            margin: 0; 
        }
        .card { 
            background: white; 
            padding: 40px; 
            border-radius: 15px; 
            box-shadow: 0 10px 25px rgba(0,0,0,0.05); 
            width: 100%; 
            max-width: 450px; 
            text-align: center; 
        }
        h2 { color: #1a202c; margin-bottom: 10px; font-size: 24px; }
        p { color: #718096; margin-bottom: 30px; }
        
        /* √Årea de carga igual a tu imagen */
        .upload-area { 
            border: 2px dashed #cbd5e0; 
            padding: 50px 20px; 
            border-radius: 12px; 
            cursor: pointer; 
            margin-bottom: 30px; 
            transition: all 0.3s;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }
        .upload-area:hover { border-color: #2d3748; background-color: #f8fafc; }
        .upload-area span { color: #4a5568; font-size: 16px; }
        
        .btn-cargar { 
            background-color: #1a365d; 
            color: white; 
            border: none; 
            padding: 15px; 
            border-radius: 8px; 
            font-weight: bold; 
            width: 100%; 
            cursor: pointer; 
            font-size: 16px;
            transition: background 0.3s;
        }
        .btn-cargar:hover { background-color: #2c5282; }
    </style>
</head>
<body>

<div class="card">
    <h2>Carga Masiva de Votantes</h2>
    <p>Selecciona tu archivo Excel (.xlsx)</p>
    
    <div class="upload-area" id="dropZone" onclick="document.getElementById('archivoExcel').click()">
        <span id="fileNameDisplay">üìÇ Haz clic para subir archivo</span>
        <input type="file" id="archivoExcel" hidden accept=".xlsx, .xls">
    </div>

    <button onclick="procesarCarga()" class="btn-cargar">Iniciar Carga en Base de Datos</button>
</div>

<script>
    // Configuraci√≥n de Conexi√≥n
    const SB_URL = 'https://pmwlkdariynhaqbqursp.supabase.co';
    const SB_KEY = 'sb_publishable_zCu9cBa2qf9HqQuZ2YufzA_yTmwfiHv';
    const _supabase = supabase.createClient(SB_URL, SB_KEY);

    // Mostrar el nombre del archivo seleccionado
    document.getElementById('archivoExcel').addEventListener('change', function(e) {
        const name = e.target.files[0]?.name || "Haz clic para subir archivo";
        document.getElementById('fileNameDisplay').innerText = "üìÑ " + name;
    });

    async function procesarCarga() {
        const fileInput = document.getElementById('archivoExcel');
        if (!fileInput.files[0]) {
            return Swal.fire('Atenci√≥n', 'Por favor, selecciona un archivo Excel primero.', 'info');
        }

        Swal.fire({
            title: 'Procesando registros',
            text: 'Por favor espera...',
            allowOutsideClick: false,
            didOpen: () => { Swal.showLoading(); }
        });

        const reader = new FileReader();
        reader.onload = async (e) => {
            try {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const sheet = workbook.Sheets[workbook.SheetNames[0]];
                const registros = XLSX.utils.sheet_to_json(sheet);

                let exitosos = 0;
                let errores = [];

                // Procesar uno por uno para capturar el error exacto
                for (const fila of registros) {
                    // Validamos que tenga c√©dula (ajusta el nombre si en tu excel es diferente)
                    if (!fila.cedula) {
                        errores.push({ nombre: fila["Nombres y apellidos"] || "Fila sin nombre", motivo: "Falta la c√©dula" });
                        continue;
                    }

                    const { error } = await _supabase.from('VOTANTES').insert([fila]);

                    if (error) {
                        let razon = error.message;
                        if (error.code === '23505') razon = "C√©dula ya registrada (Duplicado)";
                        
                        errores.push({ 
                            nombre: `${fila["Nombres y apellidos"] || 'Desconocido'} (CC: ${fila.cedula})`, 
                            motivo: razon 
                        });
                    } else {
                        exitosos++;
                    }
                }

                // Mostrar reporte final
                if (errores.length === 0) {
                    Swal.fire('¬°Carga Exitosa!', `Se subieron ${exitosos} registros correctamente.`, 'success');
                } else {
                    let listaHtml = errores.map(err => `<li><b>${err.nombre}:</b> ${err.motivo}</li>`).join('');
                    
                    Swal.fire({
                        title: 'Carga Completada con Errores',
                        icon: 'warning',
                        html: `
                            <div style="text-align: left; font-size: 0.9rem;">
                                <p style="color: green;">‚úÖ Exitosos: ${exitosos}</p>
                                <p style="color: red;">‚ùå Fallidos: ${errores.length}</p>
                                <hr>
                                <p><b>Detalle de fallos:</b></p>
                                <ul style="max-height: 200px; overflow-y: auto; background: #fff5f5; border-radius: 5px; padding: 10px; list-style: none;">
                                    ${listaHtml}
                                </ul>
                            </div>
                        `,
                        confirmButtonText: 'Entendido',
                        confirmButtonColor: '#1a365d'
                    });
                }
            } catch (err) {
                Swal.fire('Error Cr√≠tico', 'El archivo no tiene el formato correcto.', 'error');
            }
        };
        reader.readAsArrayBuffer(fileInput.files[0]);
    }
</script>

</body>
</html>
