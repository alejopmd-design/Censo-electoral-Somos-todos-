<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Acceso Seguro - Sistema Electoral</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f0f2f5; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; }
        .card { background: white; padding: 40px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); width: 100%; max-width: 450px; text-align: center; }
        
        /* Pantallas */
        #pantallaCarga { display: none; }
        
        h2 { color: #1a365d; margin-bottom: 20px; }
        input { width: 100%; padding: 15px; margin: 10px 0; border: 1px solid #ddd; border-radius: 10px; font-size: 16px; box-sizing: border-box; }
        
        .btn { width: 100%; padding: 15px; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; font-size: 16px; transition: 0.3s; margin-top: 10px; }
        .btn-blue { background: #1a365d; color: white; }
        .btn-green { background: #2f855a; color: white; margin-top: 20px; }

        .upload-box { border: 2px dashed #cbd5e0; padding: 30px; border-radius: 15px; cursor: pointer; margin-top: 20px; color: #718096; }
        .upload-box:hover { background: #f8fafc; border-color: #1a365d; }
        
        .divider { margin: 25px 0; border-bottom: 1px solid #eee; position: relative; }
        .divider span { position: absolute; top: -10px; left: 50%; transform: translateX(-50%); background: white; padding: 0 10px; color: #999; font-size: 12px; }
    </style>
</head>
<body>

    <div id="pantallaSeguridad" class="card">
        <h2>Verificaci√≥n de Seguridad</h2>
        <p>Ingrese su c√©dula para acceder al sistema de carga</p>
        <input type="number" id="cedulaAdmin" placeholder="N√∫mero de C√©dula">
        <button class="btn btn-blue" onclick="verificarAcceso()">Ingresar al Panel</button>
    </div>

    <div id="pantallaCarga" class="card">
        <h2>Panel de Carga de Votantes</h2>
        
        <div id="formManual">
            <input type="text" id="nombre" placeholder="Nombre completo">
            <input type="number" id="cedulaVotante" placeholder="C√©dula del votante">
            <input type="text" id="puesto" placeholder="Puesto de votaci√≥n">
            <input type="text" id="lider" placeholder="L√≠der responsable">
            <button class="btn btn-green" onclick="guardarManual()">Guardar Registro Manual</button>
        </div>

        <div class="divider"><span>O CARGA MASIVA</span></div>

        <div class="upload-box" onclick="document.getElementById('archivoExcel').click()">
            <span id="fileTxt">üìÇ Seleccionar archivo Excel (.xlsx)</span>
            <input type="file" id="archivoExcel" hidden accept=".xlsx">
        </div>
        <button class="btn btn-blue" onclick="procesarExcel()">Iniciar Carga Masiva</button>
        
        <button onclick="location.reload()" style="background:none; border:none; color:#999; margin-top:20px; cursor:pointer;">Cerrar Sesi√≥n</button>
    </div>

<script>
    const SB_URL = 'https://pmwlkdariynhaqbqursp.supabase.co';
    const SB_KEY = 'sb_publishable_zCu9cBa2qf9HqQuZ2YufzA_yTmwfiHv';
    const _supabase = supabase.createClient(SB_URL, SB_KEY);

    // 1. VERIFICACI√ìN DE SEGURIDAD
    async function verificarAcceso() {
        const ced = document.getElementById('cedulaAdmin').value;
        if(!ced) return Swal.fire('Error', 'Debe ingresar una c√©dula', 'error');

        // Buscamos si la c√©dula existe en la tabla VOTANTES (puedes ajustarlo a una tabla de ADMINS si prefieres)
        const { data, error } = await _supabase.from('VOTANTES').select('*').eq('cedula', ced).single();

        if (data) {
            document.getElementById('pantallaSeguridad').style.display = 'none';
            document.getElementById('pantallaCarga').style.display = 'block';
        } else {
            Swal.fire('Acceso Denegado', 'C√©dula no autorizada para cargar datos', 'error');
        }
    }

    // 2. CARGA MANUAL
    async function guardarManual() {
        const registro = {
            "Nombres y apellidos": document.getElementById('nombre').value,
            cedula: document.getElementById('cedulaVotante').value,
            puesto: document.getElementById('puesto').value,
            lider: document.getElementById('lider').value
        };

        const { error } = await _supabase.from('VOTANTES').insert([registro]);
        
        if (error) {
            Swal.fire('Error', 'La c√©dula ya existe o faltan datos obligatorios', 'error');
        } else {
            Swal.fire('√âxito', 'Votante registrado correctamente', 'success');
            document.querySelectorAll('#formManual input').forEach(i => i.value = '');
        }
    }

    // 3. CARGA MASIVA CON REPORTE DE ERRORES
    document.getElementById('archivoExcel').addEventListener('change', e => {
        if(e.target.files[0]) document.getElementById('fileTxt').innerText = "üìÑ " + e.target.files[0].name;
    });

    async function procesarExcel() {
        const file = document.getElementById('archivoExcel').files[0];
        if(!file) return Swal.fire('Error', 'Seleccione un archivo Excel', 'warning');

        Swal.fire({ title: 'Procesando...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });

        const reader = new FileReader();
        reader.onload = async (e) => {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: 'array' });
            const registros = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);

            let exitosos = 0;
            let errores = [];

            for (const item of registros) {
                const { error } = await _supabase.from('VOTANTES').insert([item]);
                if (error) {
                    let causa = error.code === '23505' ? 'C√©dula Duplicada' : 'Datos incompletos/Formato error';
                    errores.push(`<li><b>${item["Nombres y apellidos"] || 'Sin nombre'}:</b> ${causa}</li>`);
                } else {
                    exitosos++;
                }
            }

            if (errores.length === 0) {
                Swal.fire('¬°√âxito!', `Se cargaron ${exitosos} registros sin errores.`, 'success');
            } else {
                Swal.fire({
                    title: 'Resultado de la Carga',
                    icon: 'warning',
                    html: `
                        <div style="text-align: left;">
                            <p style="color: green;">‚úÖ Exitosos: ${exitosos}</p>
                            <p style="color: red;">‚ùå Fallidos: ${errores.length}</p>
                            <hr>
                            <p><b>Detalle de registros no aceptados:</b></p>
                            <ul style="font-size: 0.8rem; max-height: 150px; overflow-y: auto; background: #fff5f5; padding: 10px; border-radius: 8px;">
                                ${errores.join('')}
                            </ul>
                        </div>
                    `
                });
            }
        };
        reader.readAsArrayBuffer(file);
    }
</script>
</body>
</html>
