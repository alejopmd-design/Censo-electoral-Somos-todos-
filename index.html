<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Censo Electoral - Alto Rendimiento</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root { --primary: #1a73e8; --success: #28a745; --grey: #6c757d; }
        body { font-family: 'Segoe UI', sans-serif; background: #f0f2f5; display: flex; justify-content: center; padding: 20px; }
        .card { background: white; padding: 30px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); width: 100%; max-width: 500px; text-align: center; }
        .input-group { text-align: left; margin-bottom: 12px; }
        label { display: block; font-size: 13px; font-weight: 600; margin-bottom: 4px; color: #444; }
        input, textarea { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 8px; box-sizing: border-box; }
        button { width: 100%; padding: 12px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; margin-top: 10px; color: white; transition: 0.3s; }
        .btn-save { background: var(--success); }
        .btn-excel { background: var(--primary); }
        .btn-template { background: var(--grey); font-size: 13px; margin-bottom: 15px; }
        #logErrores { background: #fff5f5; color: #c0392b; border: 1px solid #f5c6cb; padding: 10px; border-radius: 8px; margin-top: 15px; font-size: 12px; text-align: left; display: none; max-height: 200px; overflow-y: auto; }
        #seccionFormulario { display: none; }
        .progreso { margin-top: 10px; font-size: 14px; color: var(--primary); font-weight: bold; }
        hr { margin: 25px 0; border: 0; border-top: 1px solid #eee; }
    </style>
</head>
<body>

<div id="seccionLogin" class="card">
    <h2>üîë Acceso L√≠der</h2>
    <input type="password" id="passLogin" placeholder="Tu C√©dula">
    <button style="background: var(--primary);" onclick="login()">ENTRAR</button>
</div>

<div id="seccionFormulario" class="card">
    <div id="txtBienvenida" style="font-weight: bold; margin-bottom: 15px;"></div>
    
    <h3>Registro Individual</h3>
    <div class="input-group"><label>C√©dula *</label><input type="text" id="vCedula"></div>
    <div class="input-group"><label>Nombre *</label><input type="text" id="vNombre"></div>
    <div class="input-group"><label>Direcci√≥n *</label><input type="text" id="vDireccion"></div>
    <div class="input-group"><label>Tel√©fono *</label><input type="text" id="vTelefono"></div>
    <div class="input-group"><label>Puesto *</label><input type="text" id="vPuesto"></div>
    <div class="input-group"><label>Observaciones</label><textarea id="vObs"></textarea></div>
    <button class="btn-save" onclick="procesarRegistro()">GUARDAR INDIVIDUAL</button>

    <hr>

    <h3>Carga Masiva (Excel)</h3>
    <p style="font-size: 12px; color: #666; margin-bottom: 15px;">Usa la plantilla oficial para evitar errores</p>
    
    <button class="btn-template" onclick="descargarPlantilla()">‚¨áÔ∏è Descargar Plantilla Excel</button>
    
    <input type="file" id="inputExcel" accept=".xlsx, .xls, .csv">
    <button class="btn-excel" onclick="cargarExcel()">üöÄ INICIAR CARGA MASIVA</button>
    <div id="progresoCarga" class="progreso"></div>

    <div id="logErrores"></div>
    <button onclick="location.reload()" style="background:none; color:gray; text-decoration:underline; font-size: 12px; margin-top: 20px;">Cerrar Sesi√≥n</button>
</div>

<script>
    const URL_SUPA = 'https://pmwlkdariynhaqbqursp.supabase.co';
    const KEY_SUPA = 'sb_publishable_zCu9cBa2qf9HqQuZ2YufzA_yTmwfiHv';
    const _supabase = supabase.createClient(URL_SUPA, KEY_SUPA);
    let usuarioActivo = null;

    async function login() {
        const pass = document.getElementById('passLogin').value;
        const { data } = await _supabase.from('VOTANTES').select('*').eq('cedula', pass).single();
        if (data) {
            usuarioActivo = data;
            document.getElementById('txtBienvenida').innerText = "üë§ L√çDER: " + data["Nombres y apellidos"].toUpperCase();
            document.getElementById('seccionLogin').style.display = 'none';
            document.getElementById('seccionFormulario').style.display = 'block';
        } else { Swal.fire('Error', 'C√©dula no registrada.', 'error'); }
    }

    async function procesarRegistro() {
        const datos = {
            cedula: document.getElementById('vCedula').value.trim(),
            "Nombres y apellidos": document.getElementById('vNombre').value.trim(),
            direccion: document.getElementById('vDireccion').value.trim(),
            telefono: document.getElementById('vTelefono').value.trim(),
            puesto: document.getElementById('vPuesto').value.trim(),
            observaciones: document.getElementById('vObs').value.trim(),
            lider: usuarioActivo["Nombres y apellidos"]
        };

        if(!datos.cedula || !datos["Nombres y apellidos"] || !datos.direccion || !datos.telefono || !datos.puesto) {
            return Swal.fire('Atenci√≥n', 'Llena todos los campos obligatorios', 'warning');
        }

        const { error } = await _supabase.from('VOTANTES').insert([datos]);
        if(error) Swal.fire('Error', 'C√©dula duplicada', 'error');
        else { Swal.fire('√âxito', 'Guardado', 'success'); limpiar(); }
    }

    // --- FUNCI√ìN DE DESCARGA DE PLANTILLA ---
    function descargarPlantilla() {
        const headers = [["cedula", "nombre_completo", "direccion", "telefono", "puesto", "observaciones"]];
        const ws = XLSX.utils.aoa_to_sheet(headers);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Censo");
        XLSX.writeFile(wb, "Plantilla_Carga_Masiva.xlsx");
    }

    async function cargarExcel() {
        const file = document.getElementById('inputExcel').files[0];
        if(!file) return alert("Selecciona un archivo");

        const reader = new FileReader();
        reader.onload = async (e) => {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, {type: 'array'});
            const registros = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
            
            const logBox = document.getElementById('logErrores');
            const prog = document.getElementById('progresoCarga');
            logBox.style.display = 'none';
            logBox.innerHTML = "<b>Errores detectados:</b><br>";

            Swal.fire({title: 'Preparando motor de carga...', allowOutsideClick: false, didOpen: () => Swal.showLoading()});

            const tamanoLote = 50; // Bajamos a 50 para mayor estabilidad en archivos muy grandes
            let subidos = 0;
            let fallidos = 0;

            for (let i = 0; i < registros.length; i += tamanoLote) {
                const lote = registros.slice(i, i + tamanoLote).map(r => ({
                    cedula: String(r.cedula),
                    "Nombres y apellidos": r.nombre_completo,
                    direccion: r.direccion,
                    telefono: String(r.telefono),
                    puesto: r.puesto,
                    observaciones: r.observaciones || "",
                    lider: usuarioActivo["Nombres y apellidos"]
                }));

                const { error } = await _supabase.from('VOTANTES').insert(lote);

                if (error) {
                    fallidos += lote.length;
                    logBox.style.display = 'block';
                    logBox.innerHTML += `‚Ä¢ Bloque ${Math.floor(i/tamanoLote) + 1}: Error (posibles duplicados o datos vac√≠os).<br>`;
                } else {
                    subidos += lote.length;
                }
                
                prog.innerText = `Procesando: ${subidos + fallidos} de ${registros.length}`;
            }

            Swal.close();
            Swal.fire('Proceso Terminado', `√âxito: ${subidos} | Fallidos: ${fallidos}`, 'info');
        };
        reader.readAsArrayBuffer(file);
    }

    function limpiar() { document.querySelectorAll('#seccionFormulario input, textarea').forEach(i => i.value = ""); }
</script>
</body>
</html>
