<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Carga Masiva - Censo Electoral</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f4f7f6; padding: 20px; display: flex; justify-content: center; }
        .card { background: white; padding: 30px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); max-width: 500px; width: 100%; text-align: center; }
        .upload-area { border: 2px dashed #cbd5e0; padding: 40px; border-radius: 10px; cursor: pointer; margin-bottom: 20px; }
        .upload-area:hover { border-color: #1a365d; background: #f8fafc; }
        .btn-cargar { background: #1a365d; color: white; border: none; padding: 12px 25px; border-radius: 8px; font-weight: bold; cursor: pointer; width: 100%; }
        #listaErrores { text-align: left; font-size: 0.85rem; max-height: 200px; overflow-y: auto; background: #fff5f5; padding: 10px; border-radius: 5px; display: none; margin-top: 15px; color: #c53030; }
    </style>
</head>
<body>

<div class="card">
    <h2>Carga Masiva de Votantes</h2>
    <p>Selecciona tu archivo Excel (.xlsx)</p>
    
    <div class="upload-area" onclick="document.getElementById('archivoExcel').click()">
        <span>üìÅ Haz clic para subir archivo</span>
        <input type="file" id="archivoExcel" hidden accept=".xlsx, .xls">
    </div>

    <button onclick="procesarCarga()" class="btn-cargar">Iniciar Carga en Base de Datos</button>
    
    <div id="listaErrores"></div>
</div>

<script>
    const SB_URL = 'https://pmwlkdariynhaqbqursp.supabase.co';
    const SB_KEY = 'sb_publishable_zCu9cBa2qf9HqQuZ2YufzA_yTmwfiHv';
    const _supabase = supabase.createClient(SB_URL, SB_KEY);

    async function procesarCarga() {
        const fileInput = document.getElementById('archivoExcel');
        if (!fileInput.files[0]) return Swal.fire('Error', 'Selecciona un archivo primero', 'error');

        Swal.fire({ title: 'Procesando...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });

        const reader = new FileReader();
        reader.onload = async (e) => {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: 'array' });
            const sheet = workbook.Sheets[workbook.SheetNames[0]];
            const registros = XLSX.utils.sheet_to_json(sheet);

            let exitosos = 0;
            let errores = [];

            // Procesamos uno por uno para identificar exactamente cu√°l falla
            for (const registro of registros) {
                try {
                    // Verificaci√≥n b√°sica antes de enviar
                    if (!registro.cedula || !registro["Nombres y apellidos"]) {
                        errores.push({ 
                            dato: registro["Nombres y apellidos"] || "Sin nombre", 
                            motivo: "Faltan campos obligatorios (C√©dula o Nombre)" 
                        });
                        continue;
                    }

                    const { error } = await _supabase.from('VOTANTES').insert([registro]);

                    if (error) {
                        // Capturamos el error espec√≠fico de Supabase (ej: duplicado)
                        let mensajeError = error.message;
                        if (error.code === '23505') mensajeError = "La c√©dula ya existe en la base de datos";
                        
                        errores.push({ 
                            dato: `${registro["Nombres y apellidos"]} (CC: ${registro.cedula})`, 
                            motivo: mensajeError 
                        });
                    } else {
                        exitosos++;
                    }
                } catch (err) {
                    errores.push({ dato: registro["Nombres y apellidos"], motivo: "Error inesperado de conexi√≥n" });
                }
            }

            // --- RESULTADOS FINALES ---
            if (errores.length === 0) {
                Swal.fire('¬°√âxito Total!', `Se cargaron ${exitosos} registros correctamente.`, 'success');
            } else {
                // Construimos el listado de errores para mostrar al usuario
                let detalleErrores = errores.map(err => `<li><b>${err.dato}:</b> ${err.motivo}</li>`).join('');
                
                Swal.fire({
                    title: 'Carga Finalizada con Observaciones',
                    html: `
                        <div style="text-align: left;">
                            <p style="color: green;">‚úÖ Exitosos: ${exitosos}</p>
                            <p style="color: red;">‚ùå Fallidos: ${errores.length}</p>
                            <hr>
                            <p><b>Detalle de errores:</b></p>
                            <ul style="font-size: 0.8rem; max-height: 150px; overflow-y: auto;">
                                ${detalleErrores}
                            </ul>
                        </div>
                    `,
                    icon: 'warning',
                    confirmButtonText: 'Entendido'
                });
            }
        };
        reader.readAsArrayBuffer(fileInput.files[0]);
    }
</script>

</body>
</html>
