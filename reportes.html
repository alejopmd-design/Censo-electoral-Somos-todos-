<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>COMMAND CENTER CALI 2026</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&family=JetBrains+Mono&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        :root { --primary: #0f172a; --accent: #2563eb; --danger: #be123c; --bg: #f1f5f9; --panel: #ffffff; }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); padding: 15px; text-transform: uppercase; font-size: 12px; }
        .container { display: none; }
        .header { background: var(--primary); color: white; padding: 20px; border-radius: 12px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 5px solid var(--accent); }
        .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 20px; }
        .stat-card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); border-top: 5px solid var(--accent); }
        .stat-val { font-size: 2.5rem; font-weight: 900; display: block; color: var(--primary); }
        .dashboard-main { display: grid; grid-template-columns: 1.1fr 0.9fr; gap: 20px; }
        .panel { background: white; padding: 20px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
        .panel-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        #map { height: 450px; border-radius: 12px; }
        .scroll { overflow-y: auto; max-height: 400px; }
        table { width: 100%; border-collapse: collapse; }
        th { background: #f8fafc; padding: 10px; text-align: left; cursor: pointer; position: sticky; top: 0; border-bottom: 2px solid #e2e8f0; }
        th:hover { background: #e2e8f0; }
        td { padding: 10px; border-bottom: 1px solid #f1f5f9; font-weight: 700; }
        .row-comuna { background: #f8fafc; cursor: pointer; }
        .row-puesto { display: none; background: #ffffff; cursor: pointer; color: var(--accent); }
        .row-mesa { display: none; background: #fafafa; font-size: 11px; color: #64748b; }
        .alert-box { padding: 10px; border-radius: 8px; margin-bottom: 8px; font-weight: 900; display: flex; justify-content: space-between; }
        .alert-red { background: #fff1f2; color: #9f1239; border-left: 5px solid #be123c; }
        .alert-orange { background: #fff7ed; color: #9a3412; border-left: 5px solid #f59e0b; }
        .search-input { width: 100%; padding: 10px; border-radius: 8px; border: 2px solid #e2e8f0; margin-bottom: 10px; font-weight: 700; }
        .legend-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 10px; }
        .legend-item { display: flex; justify-content: space-between; padding: 5px; background: #f8fafc; border-radius: 4px; font-size: 10px; }
    </style>
</head>
<body>
    <div id="app" class="container">
        <header class="header">
            <h1 style="letter-spacing:2px">COMMAND CENTER 2026</h1>
            <div id="reloj" style="font-family:monospace"></div>
        </header>

        <div class="stats-grid">
            <div class="stat-card"><span>TOTAL CENSO</span><span class="stat-val" id="tV">0</span></div>
            <div class="stat-card" style="border-top-color:var(--danger)"><span>ALERTAS</span><span class="stat-val" id="tA" style="color:var(--danger)">0</span></div>
            <div class="stat-card" style="border-top-color:#059669"><span>ROSSE MARY CABAL</span><span class="stat-val" id="tL" style="color:#059669">0</span></div>
            <div class="stat-card"><canvas id="chartGen" height="50"></canvas></div>
        </div>

        <div class="dashboard-main">
            <div class="left">
                <div class="panel"><div id="map"></div></div>
                <div class="panel">
                    <div class="panel-header"><h3>ESTRUCTURA TERRITORIAL</h3></div>
                    <div class="scroll">
                        <table id="tJer">
                            <thead><tr><th>UBICACIÓN</th><th>VOTOS</th><th>%</th></tr></thead>
                            <tbody id="bJer"></tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div class="right">
                <div class="panel">
                    <canvas id="chartDona" height="250"></canvas>
                    <div id="dLeg" class="legend-grid"></div>
                </div>
                <div class="panel"><h3>ZONAS CRÍTICAS</h3><div id="aCont"></div></div>
            </div>
        </div>

        <div class="panel" style="margin-top:20px">
            <div class="panel-header">
                <h3>CONSOLIDADO GENERAL</h3>
                <input type="text" id="busG" onkeyup="filtrar()" placeholder="BUSCAR..." class="search-input" style="width:300px; margin-bottom:0">
            </div>
            <div class="scroll" style="max-height:500px">
                <table id="tGen">
                    <thead>
                        <tr>
                            <th onclick="sortT('tGen', 0)">NOMBRE <i class="fas fa-sort"></i></th>
                            <th onclick="sortT('tGen', 1)">CÉDULA <i class="fas fa-sort"></i></th>
                            <th onclick="sortT('tGen', 2)">PUESTO <i class="fas fa-sort"></i></th>
                            <th onclick="sortT('tGen', 3)">LÍDER <i class="fas fa-sort"></i></th>
                        </tr>
                    </thead>
                    <tbody id="bGen"></tbody>
                </table>
            </div>
        </div>
    </div>

<script>
    const S_URL = 'https://pmwlkdariynhaqbqursp.supabase.co';
    const S_KEY = 'sb_publishable_zCu9cBa2qf9HqQuZ2YufzA_yTmwfiHv';
    const _sb = supabase.createClient(S_URL, S_KEY);
    let vots = [], psts = [], map, burbujas, cDona, cGen;
    const GPS = {"1":[3.450,-76.550],"2":[3.475,-76.525],"3":[3.452,-76.533],"4":[3.468,-76.508],"5":[3.478,-76.492],"6":[3.485,-76.485],"7":[3.458,-76.488],"8":[3.445,-76.500],"9":[3.440,-76.515],"10":[3.428,-76.520],"11":[3.415,-76.510],"12":[3.428,-76.495],"13":[3.410,-76.485],"14":[3.415,-76.470],"15":[3.400,-76.475],"16":[3.410,-76.500],"17":[3.385,-76.520],"18":[3.375,-76.545],"19":[3.425,-76.545],"20":[3.415,-76.555],"21":[3.425,-76.465],"22":[3.355,-76.535],"24":[3.350,-76.510],"25":[3.370,-76.570],"33":[3.480,-76.570]};

    async function init() {
        const { value: p } = await Swal.fire({ title:'PASSWORD', input:'password', allowOutsideClick:false });
        if(p==='ADMIN2026'){ 
            document.getElementById('app').style.display='block';
            map = L.map('map').setView([3.42, -76.52], 12);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png').addTo(map);
            burbujas = L.layerGroup().addTo(map);
            getData(); setInterval(getData, 30000);
            setInterval(() => { document.getElementById('reloj').innerText = new Date().toLocaleString(); }, 1000);
        } else { init(); }
    }

    async function getData() {
        const { data: p } = await _sb.from('PUESTOS_VOTACION').select('*');
        const { data: v } = await _sb.from('VOTANTES').select('*');
        psts = p; vots = v; render();
    }

    function toggle(clase) {
        const rows = document.getElementsByClassName(clase);
        for(let r of rows) r.style.display = (r.style.display==='table-row')?'none':'table-row';
    }

    function render() {
        const total = vots.length || 1;
        const rosse = vots.filter(x => (x.lider||"").toUpperCase().includes("ROSSE")).length;
        document.getElementById('tV').innerText = vots.length;
        document.getElementById('tL').innerText = rosse;

        let cCom={}, cPue={}, h=0, m=0;
        vots.forEach(x => {
            if((x["Nombres y apellidos"]||"").toUpperCase().endsWith('A')) m++; else h++;
            const p = psts.find(pst => pst.nombre_puesto === x.puesto);
            if(p){
                cCom[p.comuna] = (cCom[p.comuna]||0)+1;
                cPue[p.comuna] = cPue[p.comuna] || {};
                cPue[p.comuna][x.puesto] = (cPue[p.comuna][x.puesto]||0)+1;
            }
        });

        // Jerarquia
        let hJer = "";
        Object.keys(GPS).forEach(c => {
            const vC = cCom[c]||0;
            hJer += `<tr class="row-comuna" onclick="toggle('c${c}')"><td>COMUNA ${c}</td><td>${vC}</td><td>${((vC/total)*100).toFixed(1)}%</td></tr>`;
            if(cPue[c]) Object.entries(cPue[c]).forEach(([p, vP]) => {
                hJer += `<tr class="row-puesto c${c}"><td>-- ${p}</td><td>${vP}</td><td>${((vP/total)*100).toFixed(1)}%</td></tr>`;
            });
        });
        document.getElementById('bJer').innerHTML = hJer;

        // General
        document.getElementById('bGen').innerHTML = vots.map(x => `<tr><td>${x["Nombres y apellidos"]}</td><td>${x.cedula}</td><td>${x.puesto}</td><td>${x.lider}</td></tr>`).join('');

        // Alertas
        const al = Object.keys(GPS).map(c => ({c, v:cCom[c]||0})).sort((a,b)=>a.v-b.v).slice(0,5);
        document.getElementById('tA').innerText = al.filter(x=>x.v===0).length;
        document.getElementById('aCont').innerHTML = al.map(x => `<div class="alert-box ${x.v===0?'alert-red':'alert-orange'}"><span>COMUNA ${x.c}</span><span>${x.v} REGISTROS</span></div>`).join('');

        updateCharts(cCom, total, h, m);
    }

    function updateCharts(cCom, total, h, m) {
        burbujas.clearLayers();
        const labs = Object.keys(cCom), dat = Object.values(cCom);
        labs.forEach(c => { if(GPS[c]) L.circle(GPS[c], {radius:200+(cCom[c]*10), color:cCom[c]>0?'#2563eb':'#be123c'}).addTo(burbujas); });

        if(cDona) cDona.destroy();
        cDona = new Chart(document.getElementById('chartDona'), {
            type:'doughnut',
            data:{ labels:labs, datasets:[{data:dat, backgroundColor:['#2563eb','#10b981','#f59e0b','#be123c','#8b5cf6']}] },
            options:{ maintainAspectRatio:false, plugins:{ legend:{display:false} } }
        });

        document.getElementById('dLeg').innerHTML = labs.map((l,i) => `<div class="legend-item"><span>${l}</span><span class="legend-pct">${((dat[i]/total)*100).toFixed(1)}%</span></div>`).join('');
    }

    function sortT(id, n) {
        const table = document.getElementById(id);
        let rows = Array.from(table.rows).slice(1);
        rows.sort((a, b) => a.cells[n].innerText.localeCompare(b.cells[n].innerText, undefined, {numeric: true}));
        if (table.getAttribute('data-dir') === 'asc') { rows.reverse(); table.setAttribute('data-dir', 'desc'); }
        else { table.setAttribute('data-dir', 'asc'); }
        rows.forEach(r => table.tBodies[0].appendChild(r));
    }

    function filtrar() {
        const b = document.getElementById('busG').value.toUpperCase();
        const rows = document.getElementById('bGen').rows;
        for(let r of rows) r.style.display = r.innerText.toUpperCase().includes(b) ? '' : 'none';
    }

    window.onload = init;
</script>
</body>
</html>
