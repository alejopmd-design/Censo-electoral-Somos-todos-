<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SISTEMA ESTRAT√âGICO CALI 2026 - AUDITOR√çA DE ALTA FIDELIDAD</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        :root { 
            --primary: #0f172a; 
            --accent: #2563eb; 
            --success: #10b981; 
            --danger: #ef4444; 
            --warning: #f59e0b; 
            --bg: #cbd5e1; 
            --panel: #ffffff;
            --font-main: 'Inter', system-ui, -apple-system, sans-serif;
        }
        
        body { 
            font-family: var(--font-main); 
            background: var(--bg); 
            margin: 0; 
            padding: 20px; 
            color: var(--primary); 
            text-transform: uppercase; 
            font-size: 14px;
        }

        /* CONTENEDOR PRINCIPAL */
        .container { 
            max-width: 1800px; 
            margin: auto; 
            display: none; 
            animation: slideUp 0.6s cubic-bezier(0.23, 1, 0.32, 1); 
        }

        @keyframes slideUp { 
            from { opacity: 0; transform: translateY(30px); } 
            to { opacity: 1; transform: translateY(0); } 
        }

        /* HEADER MASTER */
        .master-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); 
            padding: 40px; 
            border-radius: 24px; 
            box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5); 
            color: white; 
            margin-bottom: 35px;
            border-bottom: 8px solid var(--accent);
            position: relative;
            overflow: hidden;
        }

        .master-header::after {
            content: '';
            position: absolute;
            top: 0; right: 0;
            width: 300px; height: 100%;
            background: linear-gradient(90deg, transparent, rgba(37, 99, 235, 0.1));
            skewX: -20deg;
        }

        .header-text h1 { margin: 0; font-size: 2.8rem; font-weight: 900; letter-spacing: -1.5px; }
        .header-text p { margin: 8px 0 0 0; color: var(--success); font-weight: 700; letter-spacing: 1px; }

        /* TARJETAS DE ESTAD√çSTICAS */
        .stats-grid { 
            display: grid; 
            grid-template-columns: repeat(4, 1fr); 
            gap: 25px; 
            margin-bottom: 35px; 
        }

        .stat-card { 
            background: var(--panel); 
            border-radius: 22px; 
            padding: 30px; 
            border-top: 10px solid var(--accent); 
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); 
            transition: all 0.4s ease;
        }

        .stat-card:hover { 
            transform: scale(1.03); 
            box-shadow: 0 20px 25px -5px rgba(0,0,0,0.2); 
        }

        .stat-val { 
            font-size: 3.8rem; 
            font-weight: 900; 
            display: block; 
            line-height: 0.9; 
            margin-bottom: 12px; 
            color: var(--primary);
        }

        .stat-label { 
            font-size: 0.9rem; 
            font-weight: 800; 
            color: #64748b; 
            text-transform: uppercase;
            letter-spacing: 1.2px;
        }

        /* BARRA DE PROGRESO META */
        .meta-box { margin-top: 20px; }
        .progress-container { 
            height: 18px; 
            background: #e2e8f0; 
            border-radius: 10px; 
            overflow: hidden; 
            border: 1px solid #cbd5e1; 
        }
        .progress-bar { 
            height: 100%; 
            background: linear-gradient(90deg, #2563eb, #10b981); 
            width: 0%; 
            transition: width 2s cubic-bezier(0.17, 0.67, 0.83, 0.67); 
        }

        /* DISE√ëO DE PANELES */
        .main-layout { 
            display: grid; 
            grid-template-columns: 1.2fr 0.8fr; 
            gap: 30px; 
        }

        .panel { 
            background: var(--panel); 
            border-radius: 28px; 
            padding: 35px; 
            margin-bottom: 30px; 
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); 
            border: 1px solid rgba(0,0,0,0.05);
        }

        .panel-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 25px; 
            padding-bottom: 20px;
            border-bottom: 2px solid #f1f5f9;
        }

        /* MAPA Y GR√ÅFICOS */
        .geo-grid { 
            display: grid; 
            grid-template-columns: 1fr 320px; 
            gap: 30px; 
        }
        #map { 
            height: 600px; 
            border-radius: 20px; 
            border: 5px solid #f1f5f9; 
        }

        /* ESTILOS DE TABLAS MASTER */
        .table-wrapper { 
            max-height: 500px; 
            overflow-y: auto; 
            border-radius: 16px; 
            border: 1px solid #e2e8f0; 
        }

        table { 
            width: 100%; 
            border-collapse: separate; 
            border-spacing: 0; 
        }

        th { 
            background: #f8fafc; 
            padding: 20px; 
            font-weight: 900; 
            font-size: 0.75rem; 
            position: sticky; 
            top: 0; 
            z-index: 10; 
            border-bottom: 4px solid #cbd5e1;
            cursor: pointer;
            transition: 0.2s;
        }

        th:hover { background: #e2e8f0; }

        td { 
            padding: 18px; 
            border-bottom: 1px solid #f1f5f9; 
            font-weight: 700; 
            color: #334155;
        }

        tr:hover td { background: #fdfdfd; }

        /* ALERTAS DE INTERVENCI√ìN */
        .alert-card { 
            padding: 20px; 
            border-radius: 16px; 
            margin-bottom: 15px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center;
            border-left: 10px solid;
            font-weight: 900;
        }

        .alert-critical { background: #fee2e2; color: #991b1b; border-color: var(--danger); }
        .alert-low { background: #ffedd5; color: #9a3412; border-color: var(--warning); }

        /* JERARQU√çA DESPLEGABLE */
        .row-comuna { background: #f1f5f9 !important; cursor: pointer; }
        .row-puesto { display: none; background: #ffffff !important; padding-left: 40px !important; }
        .row-mesa { display: none; background: #fffcf0 !important; font-size: 0.8rem; padding-left: 60px !important; }

        /* INPUTS Y BOTONES */
        .search-bar { 
            width: 100%; 
            padding: 20px; 
            border-radius: 15px; 
            border: 3px solid #e2e8f0; 
            margin-bottom: 25px; 
            font-weight: 800;
            font-size: 1.1rem;
        }

        .btn-action { 
            padding: 12px 25px; 
            border-radius: 12px; 
            border: none; 
            font-weight: 900; 
            cursor: pointer; 
            display: flex; 
            align-items: center; 
            gap: 10px; 
            transition: 0.3s;
        }

        .btn-xls { background: #16a34a; color: white; }
        .btn-xls:hover { background: #15803d; transform: translateY(-2px); }

        .select-filter { 
            padding: 15px; 
            border-radius: 12px; 
            background: rgba(255,255,255,0.1); 
            color: white; 
            border: 1px solid rgba(255,255,255,0.2);
            font-weight: 800;
        }
    </style>
</head>
<body>

<div id="app" class="container">
    <header class="master-header">
        <div class="header-text">
            <h1>SISTEMA ESTRAT√âGICO CALI 2026</h1>
            <p><i class="fas fa-shield-check"></i> AUDITOR√çA MASTER - MODO SEGURO ACTIVO</p>
        </div>
        <div style="display:flex; gap:20px; align-items:center;">
            <select id="timeFilter" class="select-filter" onchange="actualizarTodo()">
                <option value="all">TIEMPO TOTAL</option>
                <option value="hoy">REGISTROS HOY</option>
                <option value="ayer">REGISTROS AYER</option>
                <option value="semana">√öLTIMA SEMANA</option>
            </select>
            <div id="clock" style="font-size: 1.5rem; font-weight: 900; padding: 10px 20px; background: rgba(0,0,0,0.2); border-radius: 12px;"></div>
        </div>
    </header>

    <div class="stats-grid">
        <div class="stat-card">
            <span class="stat-label">CENSO TOTAL</span>
            <span class="stat-val" id="valTotal">0</span>
            <div class="meta-box">
                <div style="display:flex; justify-content:space-between; font-weight:900; font-size:0.75rem;">
                    <span>META: 7.000</span><span id="txtAvance">0%</span>
                </div>
                <div class="progress-container"><div id="barAvance" class="progress-bar"></div></div>
            </div>
        </div>
        <div class="stat-card" style="border-top-color: var(--danger)">
            <span class="stat-label">COMUNAS EN CERO</span>
            <span class="stat-val" id="valCriticas" style="color:var(--danger)">0</span>
            <span style="font-size:0.75rem; font-weight:900;">REQUIEREN INTERVENCI√ìN</span>
        </div>
        <div class="stat-card" style="border-top-color: var(--success)">
            <span class="stat-label">L√çDERES ACTIVOS</span>
            <span class="stat-val" id="valLideres" style="color:var(--success)">0</span>
            <span style="font-size:0.75rem; font-weight:900;">FUERZA OPERATIVA ACTUAL</span>
        </div>
        <div class="stat-card" style="border-top-color: #e91e63">
            <span class="stat-label">EQUILIBRIO G√âNERO</span>
            <div style="height: 60px;"><canvas id="chartGen"></canvas></div>
            <div style="display:flex; justify-content:space-between; font-weight:900; margin-top:10px;">
                <span id="txtH" style="color:var(--accent)">H: 0</span>
                <span id="txtM" style="color:#e91e63">M: 0</span>
            </div>
        </div>
    </div>

    <div class="main-layout">
        <div class="left-col">
            <div class="panel">
                <div class="panel-header">
                    <h3><i class="fas fa-map-location-dot"></i> GEORREFERENCIACI√ìN ESTRAT√âGICA</h3>
                </div>
                <div class="geo-grid">
                    <div id="map"></div>
                    <div>
                        <canvas id="chartDona"></canvas>
                        <div id="legendDona" class="table-wrapper" style="margin-top:20px; border:none;"></div>
                    </div>
                </div>
            </div>

            <div class="panel">
                <div class="panel-header">
                    <h3><i class="fas fa-network-wired"></i> ESTRUCTURA JER√ÅRQUICA (COMUNA > PUESTO)</h3>
                    <button class="btn-action btn-xls" onclick="exportarExcel('tableJerarquia', 'JERARQUIA_CALI')"><i class="fas fa-file-excel"></i> XLS</button>
                </div>
                <div class="table-wrapper">
                    <table id="tableJerarquia">
                        <thead>
                            <tr>
                                <th onclick="ordenarTabla('tableJerarquia', 0)">LOCALIZACI√ìN</th>
                                <th onclick="ordenarTabla('tableJerarquia', 1)" style="text-align:center">VOTOS</th>
                                <th onclick="ordenarTabla('tableJerarquia', 2)" style="text-align:center">% PART.</th>
                            </tr>
                        </thead>
                        <tbody id="bodyJerarquia"></tbody>
                    </table>
                </div>
            </div>

            <div class="panel">
                <div class="panel-header">
                    <h3><i class="fas fa-database"></i> BASE DE DATOS AUDITADA</h3>
                    <button class="btn-action btn-xls" onclick="exportarExcel('tableMain', 'BASE_GENERAL_2026')"><i class="fas fa-file-excel"></i> DESCARGAR</button>
                </div>
                <input type="text" id="mainSearch" onkeyup="buscarGlobal()" class="search-bar" placeholder="BUSCAR POR NOMBRE, C√âDULA O PUESTO...">
                <div class="table-wrapper">
                    <table id="tableMain">
                        <thead>
                            <tr>
                                <th onclick="ordenarTabla('tableMain', 0)">NOMBRE COMPLETO</th>
                                <th onclick="ordenarTabla('tableMain', 1)">IDENTIFICACI√ìN</th>
                                <th onclick="ordenarTabla('tableMain', 2)">PUESTO</th>
                                <th onclick="ordenarTabla('tableMain', 3)" style="text-align:center">MESA</th>
                                <th onclick="ordenarTabla('tableMain', 4)" style="text-align:center">C.</th>
                            </tr>
                        </thead>
                        <tbody id="bodyMain"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="right-col">
            <div class="panel">
                <div class="panel-header"><h3><i class="fas fa-triangle-exclamation"></i> ALERTAS DE INTERVENCI√ìN</h3></div>
                <div id="alertContainer"></div>
            </div>

            <div class="panel">
                <div class="panel-header"><h3><i class="fas fa-history"></i> √öLTIMOS REGISTROS</h3></div>
                <div id="recentContainer"></div>
            </div>

            <div class="panel">
                <div class="panel-header"><h3><i class="fas fa-trophy"></i> RANKING L√çDERES</h3></div>
                <div class="table-wrapper">
                    <table id="tableLid">
                        <thead>
                            <tr>
                                <th>L√çDER</th>
                                <th style="text-align:center">VOTOS</th>
                                <th style="text-align:center">%</th>
                            </tr>
                        </thead>
                        <tbody id="bodyLid"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // 1. CONFIGURACI√ìN Y VARIABLES GLOBALES (L√çNEAS 380+)
    const SB_URL = 'https://pmwlkdariynhaqbqursp.supabase.co';
    const SB_KEY = 'sb_publishable_zCu9cBa2qf9HqQuZ2YufzA_yTmwfiHv';
    const _supabase = supabase.createClient(SB_URL, SB_KEY);

    let baseVotantes = [], puestosData = [], mainMap, burbujasLayer, donaChart, genChart;

    const COORDS_COMUNAS = {
        "1":[3.450,-76.550],"2":[3.475,-76.525],"3":[3.452,-76.533],"4":[3.468,-76.508],"5":[3.478,-76.492],
        "6":[3.485,-76.485],"7":[3.458,-76.488],"8":[3.445,-76.500],"9":[3.440,-76.515],"10":[3.428,-76.520],
        "11":[3.415,-76.510],"12":[3.428,-76.495],"13":[3.410,-76.485],"14":[3.415,-76.470],"15":[3.400,-76.475],
        "16":[3.410,-76.500],"17":[3.385,-76.520],"18":[3.375,-76.545],"19":[3.425,-76.545],"20":[3.415,-76.555],
        "21":[3.425,-76.465],"22":[3.355,-76.535],"24":[3.350,-76.510],"25":[3.370,-76.570],"33":[3.480,-76.570]
    };

    // 2. SISTEMA DE LOGIN Y ARRANQUE
    async function iniciar() {
        const { value: pass } = await Swal.fire({
            title: 'ACCESO MASTER 2026',
            input: 'password',
            confirmButtonColor: '#0f172a',
            allowOutsideClick: false
        });

        if(pass === 'ADMIN2026') {
            document.getElementById('app').style.display = 'block';
            initMap();
            fetchData();
            setInterval(updateClock, 1000);
        } else { iniciar(); }
    }

    function updateClock() {
        const now = new Date();
        document.getElementById('clock').innerText = now.toLocaleTimeString();
    }

    function initMap() {
        mainMap = L.map('map').setView([3.42, -76.52], 12);
        L.tileLayer('https://{s}.tile.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png').addTo(mainMap);
        burbujasLayer = L.layerGroup().addTo(mainMap);
    }

    // 3. CARGA DE DATOS (L√çNEAS 450+)
    async function fetchData() {
        try {
            const { data: v } = await _supabase.from('VOTANTES').select('*').order('created_at', { ascending: false });
            const { data: p } = await _supabase.from('PUESTOS_VOTACION').select('*');
            baseVotantes = v || [];
            puestosData = p || [];
            actualizarTodo();
        } catch (e) {
            Swal.fire('Error', 'No se pudo conectar con la base de datos', 'error');
        }
    }

    // 4. L√ìGICA DE PROCESAMIENTO (L√çNEAS 480-550)
    function actualizarTodo() {
        const filter = document.getElementById('timeFilter').value;
        const hoy = new Date();
        
        const filtrados = baseVotantes.filter(item => {
            const f = new Date(item.created_at);
            if(filter === 'all') return true;
            if(filter === 'hoy') return f.toDateString() === hoy.toDateString();
            if(filter === 'ayer') {
                const ayer = new Date(); ayer.setDate(ayer.getDate() - 1);
                return f.toDateString() === ayer.toDateString();
            }
            if(filter === 'semana') {
                const sem = new Date(); sem.setDate(sem.getDate() - 7);
                return f >= sem;
            }
        });

        const total = filtrados.length;
        document.getElementById('valTotal').innerText = total;
        
        // Avance Meta
        const pMeta = Math.min((total/7000)*100, 100).toFixed(1);
        document.getElementById('txtAvance').innerText = pMeta + '%';
        document.getElementById('barAvance').style.width = pMeta + '%';

        // Procesar Conteos
        let m = 0, f = 0, cCom = {}, cLid = {}, jerar = {};

        filtrados.forEach(v => {
            // Sexo (Inferencia por nombres comunes)
            const n = (v["Nombres y apellidos"] || "").toUpperCase();
            if(n.includes('MARIA') || n.includes('LUZ') || n.endsWith('A')) f++; else m++;

            // L√≠deres
            const l = (v.lider || "DIRECTO").toUpperCase();
            cLid[l] = (cLid[l] || 0) + 1;

            // Geograf√≠a
            const po = puestosData.find(p => p.nombre_puesto.trim().toUpperCase() === (v.puesto||"").trim().toUpperCase());
            const c = po ? po.comuna : "OTRA";
            const p = po ? po.nombre_puesto : (v.puesto || "SIN PUESTO");
            const ms = v.mesa || "0";

            if(c !== "OTRA") cCom[c] = (cCom[c] || 0) + 1;
            
            if(!jerar[c]) jerar[c] = { t: 0, p: {} };
            if(!jerar[c].p[p]) jerar[c].p[p] = { t: 0, m: {} };
            if(!jerar[c].p[p].m[ms]) jerar[c].p[p].m[ms] = 0;
            jerar[c].t++; jerar[c].p[p].t++; jerar[c].p[p].m[ms]++;
        });

        // Actualizar UI
        document.getElementById('valLideres').innerText = Object.keys(cLid).length;
        document.getElementById('txtH').innerText = `H: ${m}`;
        document.getElementById('txtM').innerText = `M: ${f}`;
        
        renderGeneros(m, f);
        renderMapa(cCom, total);
        renderDona(cCom, total);
        renderAlertas(cCom, total);
        renderRecientes(filtrados.slice(0, 10));
        renderJerarquia(jerar, total);
        renderLideres(cLid, total);
        renderMain(filtrados);
    }

    // 5. RENDERIZADO DE TABLAS Y GR√ÅFICOS
    function renderJerarquia(data, total) {
        const b = document.getElementById('bodyJerarquia');
        b.innerHTML = "";
        Object.keys(data).sort((x,y)=>x-y).forEach((com, i) => {
            const idC = `c-${i}`;
            const perc = ((data[com].t/total)*100).toFixed(1);
            b.innerHTML += `<tr class="row-comuna" onclick="toggleRow('${idC}')"><td>üìÇ COMUNA ${com}</td><td align="center">${data[com].t}</td><td align="center">${perc}%</td></tr>`;
            
            Object.keys(data[com].p).forEach((pue, j) => {
                const idP = `${idC}-p-${j}`;
                b.innerHTML += `<tr class="row-puesto ${idC}" onclick="toggleRow('${idP}')"><td>üìç ${pue}</td><td align="center">${data[com].p[pue].t}</td><td align="center">${((data[com].p[pue].t/total)*100).toFixed(1)}%</td></tr>`;
            });
        });
    }

    function toggleRow(clase) {
        const rows = document.getElementsByClassName(clase);
        for(let r of rows) r.style.display = (r.style.display === 'table-row' ? 'none' : 'table-row');
    }

    function renderAlertas(cCom, total) {
        const criticas = Object.keys(COORDS_COMUNAS).filter(c => !cCom[c]);
        document.getElementById('valCriticas').innerText = criticas.length;
        
        let html = criticas.map(c => `<div class="alert-card alert-critical"><span>COMUNA ${c}</span> <span>0 REGISTROS</span></div>`).join('');
        
        // Las 5 m√°s bajas (Instrucci√≥n guardada)
        const bajas = Object.entries(cCom).sort((a,b)=>a[1]-b[1]).slice(0, 5);
        html += bajas.map(([c, v]) => `<div class="alert-card alert-low"><span>COMUNA ${c}</span> <span>BAJA PRODUCTIVIDAD (${v})</span></div>`).join('');
        
        document.getElementById('alertContainer').innerHTML = html;
    }

    function renderMapa(cCom, total) {
        burbujasLayer.clearLayers();
        Object.keys(COORDS_COMUNAS).forEach(c => {
            const v = cCom[c] || 0;
            const r = 500 + (v * 10);
            const col = v === 0 ? '#ef4444' : (v < 20 ? '#f59e0b' : '#10b981');
            L.circle(COORDS_COMUNAS[c], { radius: r, color: col, fillOpacity: 0.5 }).addTo(burbujasLayer).bindTooltip(`COMUNA ${c}: ${v} VOTOS`);
        });
    }

    function exportarExcel(id, nombre) {
        const table = document.getElementById(id);
        const wb = XLSX.utils.table_to_book(table);
        XLSX.writeFile(wb, `${nombre}.xlsx`);
    }

    function ordenarTabla(id, col) {
        const table = document.getElementById(id);
        const rows = Array.from(table.tBodies[0].rows);
        const isAsc = table.getAttribute('data-asc') === 'true';
        rows.sort((a, b) => {
            const vA = a.cells[col].innerText;
            const vB = b.cells[col].innerText;
            return isAsc ? vA.localeCompare(vB, undefined, {numeric: true}) : vB.localeCompare(vA, undefined, {numeric: true});
        });
        table.setAttribute('data-asc', !isAsc);
        rows.forEach(r => table.tBodies[0].appendChild(r));
    }

    function renderMain(data) {
        document.getElementById('bodyMain').innerHTML = data.map(v => `
            <tr>
                <td>${v["Nombres y apellidos"]}</td>
                <td>${v.cedula}</td>
                <td>${v.puesto}</td>
                <td align="center">${v.mesa || 0}</td>
                <td align="center">${(puestosData.find(p=>p.nombre_puesto===v.puesto)||{}).comuna || '-'}</td>
            </tr>
        `).join('');
    }

    // GR√ÅFICOS CHART.JS
    function renderGeneros(h, m) {
        if(genChart) genChart.destroy();
        genChart = new Chart(document.getElementById('chartGen'), {
            type: 'bar',
            data: { labels: ['H','M'], datasets:[{ data:[h,m], backgroundColor:['#2563eb','#e91e63'] }] },
            options: { indexAxis: 'y', plugins: { legend: { display: false } }, scales: { x: { display: false }, y: { display: false } } }
        });
    }

    function renderDona(cCom, total) {
        const labels = Object.keys(cCom).map(c => 'C'+c);
        const data = Object.values(cCom);
        if(donaChart) donaChart.destroy();
        donaChart = new Chart(document.getElementById('chartDona'), {
            type: 'doughnut',
            data: { labels, datasets: [{ data, backgroundColor: ['#2563eb','#8b5cf6','#06b6d4','#d946ef','#f97316','#a3e635','#2dd4bf','#fbbf24','#475569','#0f172a'] }] },
            options: { plugins: { legend: { display: false } }, cutout: '70%' }
        });
    }

    function buscarGlobal() {
        const q = document.getElementById('mainSearch').value.toUpperCase();
        const rows = document.getElementById('bodyMain').rows;
        for(let r of rows) r.style.display = r.innerText.toUpperCase().includes(q) ? '' : 'none';
    }

    window.onload = iniciar;
</script>
</body>
</html>
