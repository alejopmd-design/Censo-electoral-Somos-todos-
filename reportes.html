<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DASHBOARD ELECTORAL CALI 2026 - FULL RESOLUCI√ìN</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        :root { --blue: #0f172a; --green: #10b981; --bg: #f8fafc; --white: #ffffff; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); margin: 0; padding: 20px; color: #1e293b; text-transform: uppercase; }
        .container { max-width: 1550px; margin: auto; display: none; }
        .card { background: var(--white); border-radius: 16px; padding: 24px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); margin-bottom: 24px; border: 1px solid #e2e8f0; }
        .top-grid { display: grid; grid-template-columns: 1.5fr 1fr 1fr; gap: 24px; }
        .mid-grid { display: grid; grid-template-columns: 1.2fr 0.8fr; gap: 24px; }
        .stat-num { font-size: 3rem; font-weight: 800; color: var(--blue); text-align: center; }
        .stat-label { text-align: center; color: #64748b; font-size: 0.8rem; font-weight: 700; margin-bottom: 10px; }
        .progress-bg { background: #f1f5f9; height: 16px; border-radius: 8px; overflow: hidden; margin: 15px 0; }
        .progress-fill { background: linear-gradient(90deg, #10b981, #34d399); height: 100%; width: 0%; transition: 1.5s; }
        table { width: 100%; border-collapse: collapse; }
        th { background: #f1f5f9; padding: 14px; text-align: left; font-size: 0.75rem; color: #475569; border-bottom: 2px solid #e2e8f0; cursor: pointer; position: sticky; top: 0; z-index: 10; }
        th:hover { background: #e2e8f0; }
        td { padding: 12px 14px; border-bottom: 1px solid #f1f5f9; font-size: 0.85rem; font-weight: 500; }
        .scroll-area { max-height: 550px; overflow-y: auto; border-radius: 12px; border: 1px solid #e2e8f0; background: white; }
        .badge { padding: 5px 10px; border-radius: 8px; font-weight: 800; font-size: 0.7rem; display: inline-block; }
        .bg-blue { background: #eff6ff; color: #1e40af; border: 1px solid #bfdbfe; }
        .bg-green { background: #ecfdf5; color: #065f46; border: 1px solid #a7f3d0; }
        .bg-rural { background: #fff7ed; color: #9a3412; border: 1px solid #ffedd5; }
        .btn-excel { background: #1D6F42; color: white; padding: 12px; border-radius: 10px; border: none; cursor: pointer; width: 100%; font-weight: 700; margin-top: 10px; }
        input#buscador { width: 100%; padding: 18px; border-radius: 15px; border: 2px solid #cbd5e1; font-size: 1.1rem; color: #0f172a; font-weight: 700; }
    </style>
</head>
<body>

<div id="app" class="container">
    <div class="top-grid">
        <div class="card">
            <strong>üìä AVANCE META 2026</strong>
            <div class="stat-num" id="totalCenso">0</div>
            <div class="progress-bg"><div id="barraMeta" class="progress-fill"></div></div>
            <div id="porcLabel" style="text-align:right; font-weight:800; color:var(--green)">0%</div>
        </div>
        <div class="card"><div class="stat-label">VOTOS DIRECTOS</div><div class="stat-num" id="totalD" style="color:var(--green)">0</div></div>
        <div class="card"><div class="stat-label">ESTRUCTURA INDIRECTA</div><div class="stat-num" id="totalI" style="color:#6366f1">0</div></div>
    </div>

    <div class="card">
        <input type="text" id="buscador" onkeyup="filtrar()" placeholder="üîç BUSCADOR DE RESOLUCI√ìN: ESCRIBE NOMBRE, C√âDULA O CUALQUIER PARTE DEL PUESTO...">
    </div>

    <div class="mid-grid">
        <div class="card">
            <h4 style="margin-top:0">‚≠ê RANKING DE L√çDERES</h4>
            <div class="scroll-area" style="max-height:450px">
                <table>
                    <thead>
                        <tr>
                            <th onclick="ordenarLideres('nombre')">NOMBRE L√çDER ‚Üï</th>
                            <th style="text-align:center" onclick="ordenarLideres('cantidad')">CANTIDAD ‚Üï</th>
                        </tr>
                    </thead>
                    <tbody id="cuerpoLideres"></tbody>
                </table>
            </div>
        </div>
        <div class="card">
            <h4 style="margin-top:0">üìç DISTRIBUCI√ìN POR ZONAS</h4>
            <div style="height:380px"><canvas id="chartDona"></canvas></div>
        </div>
    </div>

    <div class="card">
        <h4 style="margin-top:0">üìã BASE MAESTRA INTEGRAL (ORDENABLE)</h4>
        <div class="scroll-area">
            <table id="tablaMaestra">
                <thead>
                    <tr>
                        <th onclick="ordenarMaestra('Nombres y apellidos')">VOTANTE ‚Üï</th>
                        <th onclick="ordenarMaestra('cedula')">C√âDULA ‚Üï</th>
                        <th onclick="ordenarMaestra('puesto')">PUESTO ‚Üï</th>
                        <th onclick="ordenarMaestra('comuna')">UBICACI√ìN ‚Üï</th>
                        <th onclick="ordenarMaestra('relacion')">ORIGEN ‚Üï</th>
                    </tr>
                </thead>
                <tbody id="cuerpoDetalle"></tbody>
            </table>
        </div>
        <button onclick="exportarTodo()" class="btn-excel" style="background:#0f172a; margin-top:20px">üì• EXPORTAR CENSO CLASIFICADO (EXCEL)</button>
    </div>
</div>

<script>
    const SB_URL = 'https://pmwlkdariynhaqbqursp.supabase.co';
    const SB_KEY = 'sb_publishable_zCu9cBa2qf9HqQuZ2YufzA_yTmwfiHv';
    const _supabase = supabase.createClient(SB_URL, SB_KEY);

    let baseDatos = [];
    let lideresRosse = [];
    let myChart;
    let sM = { col: null, asc: true };
    let sL = { col: 'cantidad', asc: false };

    // MATRIZ DEFINITIVA BASADA EN LA RESOLUCI√ìN 2026
    const MATRIZ_CALI = {
        "1": ["ACEVEDO", "GOMEZ", "MUTIS", "CELESTINO", "HOLGUIN", "GARCES", "DELFINA", "TERRON", "VISTA HERMOSA", "AGUACATAL", "ESTRELLA", "BAJO AGUACATAL", "CD 12", "SANTUARIO"],
        "2": ["NAVIA VARON", "FRANCIA", "LA MERCED", "VIPASA", "LA FLORA", "ALAMOS", "GONZAGA", "GRANADA", "VERSALLES", "JUANAMBU", "CHIPICHAPE", "MENA", "ATENAS", "CENTENARIO", "NORMANDIA", "BENALCAZAR", "SAGRADA FAMILIA", "LANS", "SENA SALOMIA", "ESTACION", "PRADOS DEL NORTE", "VALLE DEL LILI 2"],
        "3": ["SANTA LIBRADA", "LIBRADA", "SAN ANTONIO", "SAN PASCUAL", "SAN NICOLAS", "ELOY", "PILOTO", "FRAY DAMIAN", "PE√ëON", "MERCED", "SANTA ROSA", "CORAJE", "JUSTICIA", "SENA SEDE"],
        "4": ["JORGE ISAACS", "SANTANDER", "PAULA SANTANDER", "OLAYA", "PORVENIR", "POPULAR", "VALENCIA", "GUILLERMO VALENCIA", "METROPOLITANO SEDE", "FLORENCIA", "BERLIN", "MANUELA BELTRAN 2"],
        "5": ["INEM", "CAYZEDO", "CAICEDO Y CUERO", "VIVAS BALCAZAR", "ZAMORANO", "RIVERA", "VILLAS DE VERACRUZ", "CONFENALCO", "CHIMINANGOS 1", "SALOMIA SEDE", "BARRANQUILLA", "TORRES DE COMFANDI"],
        "6": ["FLORALIA", "CALIMA", "GUAYACANES", "CHIMINANGOS", "ALCAZARES", "PETECUY", "COMFANDI CALIMA", "PUEBLO NUEVO", "GAITAN", "JORGE ELIECER", "PASO DEL COMERCIO"],
        "7": ["ALFONSO LOPEZ", "PUMAREJO", "10 DE MAYO", "DIEZ DE MAYO", "MALLARINO", "PUERTO MALLARINO", "FUENMAYOR", "VILLAMAGRE", "BELISARIO", "SIETE DE AGOSTO", "LUIS CARLOS GALAN", "FE Y ALEGRIA"],
        "8": ["MARIANO RAMOS", "CAMACHO", "AMERICAS", "INDUSTRIAL", "MUNICIPAL", "PRIMAVERAS", "SANTA MONICA", "URIBE", "BENJAMIN HERRERA", "LUIS LOPEZ DE MESA", "LAS ACACIAS", "VILLA COLOMBIA"],
        "9": ["CALDAS", "FRANCISCO JOSE", "AMPUDIA", "JUAN DE AMPUDIA", "TAFUR", "ARANJUEZ", "GUAYAQUIL", "BRETA√ëA", "JUNIN", "ALAMEDA", "CHAMPAGNAT", "MANUELA CA√ëIZARES", "CENTRO"],
        "10": ["DEPARTAMENTAL", "GUABAL", "SAN CRISTOBAL", "LLOREDA", "PASOANCHO", "COLSEGUROS", "SELVA", "PANAMERICANO", "SANTA HELENA", "SANTO DOMINGO"],
        "11": ["ISRAEL", "REPUBLICA DE ISRAEL", "CIUDAD DE CALI", "SAN CARLOS", "HOLGUIN", "ESPERANZA", "INDEPENDENCIA", "CASCADA", "PRADOS DE ORIENTE", "LA LUISA", "MARIANO MOLINA"],
        "12": ["VILLA DEL SUR", "SANTA FE", "SINDICAL", "VILLANUEVA", "RODEO", "FLORESTA", "ASTURIAS", "FENALCO", "EDUARDO SANTOS", "PROVIVIENDA", "DOCE DE OCTUBRE"],
        "13": ["EL DIAMANTE", "RICARDO NIETO", "TRIANA", "POBLADO", "CHARCO AZUL", "PONDAJE", "VILLACOLOMBIA", "CALIPSO", "AMAZONAS", "VILLA DEL LAGO", "RODRIGO LLOREDA"],
        "14": ["CALIXTO", "ALVAREZ", "CALISTO", "TALANGA", "ALIRIO MORA", "PUERTA DEL SOL", "ORQUIDEAS", "MANUELA BELTRAN", "PROSPERO", "MARROQUIN", "RETIRO"],
        "15": ["LLANO VERDE", "LLANOVERDE", "ISAURA", "RODRIGUEZ", "RETIRO", "MOJICA", "VALLADO", "LAUREANO", "MORICHAL", "CORDOBA", "CDI LLANO", "EL DIAMANTE 2"],
        "16": ["ESTEBAN ROJAS", "HERNANDO NAVIA", "CRISTOBAL COLON", "UNION DE VIVIENDA", "GRAN COLOMBIA", "MARIANO RAMOS PRINCIPAL"],
        "17": ["UNIVALLE", "NUEVO LATIR", "INGENIO", "CANEY", "LIMONAR", "CAPRI", "MAYOTTE", "LACORDAIRE", "LILI", "VALLE DEL LILI", "CIUDADELA", "LA HACIENDA", "QUINTAS", "BOCHALEMA"],
        "18": ["POLITECNICO", "CARVAJAL", "MELENDEZ", "JORDAN", "ALTOS", "CUARTA BRIGADA", "SANTA ANITA", "CHORROS", "MAMPUESTO"],
        "19": ["CIEGOS", "SORDOS", "COLISEO", "PASCUAL GUERRERO", "ESTADIO", "EUSTAQUIO", "LIDO", "TEQUENDAMA", "SANTIAGO", "CUARTO DE LEGUA", "CA√ëAVERALEJO", "SAN FERNANDO", "PUEBLO", "NUEVA TEQUENDAMA", "ALAMEDA"],
        "20": ["MULTIPROPOSITO", "SILOE", "LLERAS", "BELISARIO", "BRISAS DE MAYO", "LA SULTANA"],
        "21": ["DESEPAZ", "CALIMIO", "SANTA ISABEL", "HUNGRIA", "COMPARTIR", "VALLE GRANDE", "POTRERO GRANDE", "REMIGIO", "CIUDADELA DESEPAZ", "TALANGA 2"],
        "22": ["ICESI", "JAVERIANA", "PANCE", "JARDIN", "SAN BUENAVENTURA", "ALEMAN", "LUMEN", "BERCHMANS", "BENNETT", "CANDELARIA", "CA√ëASGORDAS", "ALFEREZ REAL"],
        "RURAL": ["MONTEBELLO", "FELIDIA", "SALADITO", "KM 18", "ELVIRA", "LEONERA", "PICHINDE", "LOS ANDES", "VILLACARMELO", "BUITRERA", "NAVARRO", "HORMIGUERO", "CASCAJAL", "GOLONDRINAS", "LA PAZ", "CASEY", "KM 30", "LA VORAGINE", "PANCE RURAL", "SAN FRANCISCO", "LA REFORMA"]
    };

    function normalizar(t) { return t ? t.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toUpperCase().trim() : ""; }

    function obtenerUbicacion(puesto) {
        const t = normalizar(puesto);
        if(!t) return "SIN DATO";
        for(let [c, claves] of Object.entries(MATRIZ_CALI)) {
            if(claves.some(k => t.includes(k))) return c === "RURAL" ? "RURAL" : "COMUNA " + c;
        }
        return "OTRA / REVISAR";
    }

    async function iniciar() {
        const { value: pass } = await Swal.fire({ title: 'PANEL ESTRUCTURA 2026', input: 'password', confirmButtonColor: '#0f172a' });
        if(pass === 'ADMIN2026') { document.getElementById('app').style.display = 'block'; await cargar(); }
    }

    async function cargar() {
        const { data } = await _supabase.from('VOTANTES').select('*');
        baseDatos = data.map(v => ({
            ...v,
            comuna: obtenerUbicacion(v.puesto),
            relacion: v.lider === "Rosse Mary Cabal Franco" ? "DIRECTO" : "INDIRECTO"
        }));
        procesarRosse();
        actualizar();
    }

    function procesarRosse() {
        const hijos = baseDatos.filter(v => v.lider === "Rosse Mary Cabal Franco");
        lideresRosse = hijos.map(h => ({ 
            nombre: h["Nombres y apellidos"], 
            cantidad: baseDatos.filter(v => v.lider === h["Nombres y apellidos"]).length 
        }));
    }

    function actualizar() {
        document.getElementById('totalCenso').innerText = baseDatos.length.toLocaleString();
        document.getElementById('totalD').innerText = baseDatos.filter(v => v.relacion === "DIRECTO").length;
        document.getElementById('totalI').innerText = baseDatos.filter(v => v.relacion === "INDIRECTO").length;
        const p = (baseDatos.length / 5000) * 100;
        document.getElementById('barraMeta').style.width = Math.min(p, 100) + '%';
        document.getElementById('porcLabel').innerText = `${p.toFixed(1)}%`;
        renderLideres(); renderDona(); renderDetalle();
    }

    // SISTEMA DE ORDENAMIENTO (MAESTRA)
    function ordenarMaestra(col) {
        sM.asc = sM.col === col ? !sM.asc : true;
        sM.col = col;
        baseDatos.sort((a, b) => {
            let v1 = a[col] || ""; let v2 = b[col] || "";
            return sM.asc ? v1.toString().localeCompare(v2) : v2.toString().localeCompare(v1);
        });
        renderDetalle();
    }

    // SISTEMA DE ORDENAMIENTO (L√çDERES)
    function ordenarLideres(col) {
        sL.asc = sL.col === col ? !sL.asc : true;
        sL.col = col;
        lideresRosse.sort((a, b) => {
            if (col === 'cantidad') return sL.asc ? a.cantidad - b.cantidad : b.cantidad - a.cantidad;
            return sL.asc ? a.nombre.localeCompare(b.nombre) : b.nombre.localeCompare(a.nombre);
        });
        renderLideres();
    }

    function renderLideres() {
        const tbody = document.getElementById('cuerpoLideres');
        tbody.innerHTML = lideresRosse.map(l => `<tr><td><b>${l.nombre}</b></td><td style="text-align:center"><span class="badge bg-green">${l.cantidad}</span></td></tr>`).join('');
    }

    function renderDetalle() {
        const tbody = document.getElementById('cuerpoDetalle');
        tbody.innerHTML = baseDatos.map(v => {
            const esR = v.comuna === "RURAL";
            return `<tr><td><b>${v["Nombres y apellidos"]}</b></td><td>${v.cedula}</td><td>${v.puesto||'S.D'}</td><td><span class="badge ${esR?'bg-rural':'bg-blue'}">${v.comuna}</span></td><td><span class="badge ${v.relacion==='DIRECTO'?'bg-green':''}">${v.relacion}</span></td></tr>`
        }).join('');
    }

    function renderDona() {
        const ctx = document.getElementById('chartDona');
        const cont = {};
        baseDatos.forEach(v => cont[v.comuna] = (cont[v.comuna] || 0) + 1);
        if(myChart) myChart.destroy();
        myChart = new Chart(ctx, { type: 'doughnut', data: { labels: Object.keys(cont), datasets: [{ data: Object.values(cont), backgroundColor: ['#0f172a', '#10b981', '#6366f1', '#f59e0b', '#ec4899', '#ef4444', '#8b5cf6', '#06b6d4', '#94a3b8', '#1e293b'], borderWidth: 0 }] }, options: { maintainAspectRatio: false, cutout: '75%', plugins: { legend: { position: 'right', labels: { boxWidth: 10, font: { size: 9 } } } } } });
    }

    function filtrar() {
        const val = normalizar(document.getElementById('buscador').value);
        const filas = document.getElementById('cuerpoDetalle').getElementsByTagName('tr');
        for(let f of filas) f.style.display = normalizar(f.innerText).includes(val) ? '' : 'none';
    }

    function exportarTodo() { 
        const ws = XLSX.utils.json_to_sheet(baseDatos); 
        const wb = XLSX.utils.book_new(); 
        XLSX.utils.book_append_sheet(wb, ws, "DATOS_2026"); 
        XLSX.writeFile(wb, "CENSO_DETALLADO_CALI.xlsx"); 
    }
    
    iniciar();
</script>
</body>
</html>
