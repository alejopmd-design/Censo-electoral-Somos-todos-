<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CALI 2026 | CORE ESTRATÉGICO DE ALTA DISPONIBILIDAD</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&family=JetBrains+Mono:wght@500&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        /* ==========================================================================================
        CAPA DE ESTILOS DE ALTA DENSIDAD (UI/UX FRAMEWORK)
        ==========================================================================================
        */
        :root { 
            --primary-bg: #f1f5f9; 
            --panel-bg: #ffffff;
            --core-dark: #020617; 
            --accent-blue: #2563eb; 
            --accent-soft: rgba(37, 99, 235, 0.1);
            --success-green: #059669; 
            --danger-red: #be123c; 
            --warning-amber: #f59e0b;
            --border-color: #e2e8f0;
            --text-primary: #0f172a;
            --text-secondary: #64748b;
            --shadow-strategy: 0 25px 50px -12px rgba(0, 0, 0, 0.15);
            --transition-speed: 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        /* RESET OPERATIVO */
        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
        
        body { 
            font-family: 'Inter', sans-serif; 
            background: var(--primary-bg); 
            padding: 30px; 
            color: var(--text-primary); 
            text-transform: uppercase; 
            letter-spacing: 1px;
            line-height: 1.4;
        }

        .main-application-wrapper { 
            max-width: 1800px; 
            margin: auto; 
            display: none; 
            animation: systemBootSeq 1.2s ease-out; 
        }

        @keyframes systemBootSeq { 
            0% { opacity: 0; transform: translateY(30px) scale(0.98); } 
            100% { opacity: 1; transform: translateY(0) scale(1); } 
        }

        /* HEADER ESTRATÉGICO */
        .master-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            background: var(--core-dark); 
            padding: 50px 70px; 
            border-radius: 40px; 
            color: white; 
            margin-bottom: 50px; 
            box-shadow: var(--shadow-strategy); 
            border-bottom: 12px solid var(--accent-blue);
            position: relative;
            overflow: hidden;
        }

        .master-header::after {
            content: '';
            position: absolute;
            top: 0; right: 0; bottom: 0; left: 0;
            background: linear-gradient(45deg, transparent, rgba(255,255,255,0.03));
            pointer-events: none;
        }
        
        .brand-container { display: flex; align-items: center; gap: 35px; z-index: 2; }
        .brand-container h1 { font-size: 2.8rem; font-weight: 900; letter-spacing: 15px; margin: 0; }

        .time-engine {
            font-family: 'JetBrains Mono', monospace;
            background: rgba(255,255,255,0.08);
            padding: 22px 45px;
            border-radius: 20px;
            font-size: 1.4rem;
            color: #60a5fa;
            border: 1px solid rgba(255,255,255,0.15);
            box-shadow: 0 0 20px rgba(37,99,235,0.2);
            z-index: 2;
        }

        /* GRID DE INDICADORES (KPI ANALYTICS) */
        .kpi-dashboard-grid { 
            display: grid; 
            grid-template-columns: repeat(4, 1fr); 
            gap: 35px; 
            margin-bottom: 50px; 
        }

        .kpi-module { 
            background: var(--panel-bg); 
            border-radius: 35px; 
            padding: 45px; 
            box-shadow: var(--shadow-strategy); 
            border-top: 10px solid var(--accent-blue); 
            transition: var(--transition-speed);
            position: relative;
        }
        .kpi-module:hover { transform: translateY(-12px); border-top-width: 15px; }

        .kpi-data-value { 
            font-size: 5.2rem; 
            font-weight: 950; 
            display: block; 
            margin-top: 25px; 
            letter-spacing: -6px;
            color: var(--core-dark);
            line-height: 0.9;
        }
        .kpi-data-label { 
            font-size: 1rem; 
            font-weight: 800; 
            color: var(--text-secondary); 
            display: flex;
            align-items: center;
            gap: 15px;
        }

        /* ESTRUCTURA OPERATIVA (GRID PRINCIPAL) */
        .operations-matrix { 
            display: grid; 
            grid-template-columns: 1.15fr 0.85fr; 
            gap: 40px; 
        }

        .ops-card-container { 
            background: var(--panel-bg); 
            border-radius: 40px; 
            padding: 45px; 
            margin-bottom: 40px; 
            box-shadow: var(--shadow-strategy); 
            border: 1px solid var(--border-color);
            transition: var(--transition-speed);
        }

        .ops-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 6px solid #f8fafc; 
            padding-bottom: 35px; 
            margin-bottom: 40px;
        }
        
        .ops-card-title { 
            font-size: 1.4rem; 
            font-weight: 900; 
            display: flex; 
            align-items: center; 
            gap: 22px; 
            color: var(--core-dark);
        }

        /* GIS ENGINE CLUSTER */
        #map-strategic-engine { 
            height: 650px; 
            width: 100%; 
            border-radius: 30px; 
            border: 4px solid var(--border-color); 
            z-index: 10;
        }

        /* MOTOR DE TABLAS PRO */
        .table-viewport-engine { 
            overflow-y: auto; 
            scrollbar-width: thin;
            scrollbar-color: var(--accent-blue) #f1f5f9;
        }
        .table-viewport-engine::-webkit-scrollbar { width: 10px; }
        .table-viewport-engine::-webkit-scrollbar-thumb { background: var(--accent-blue); border-radius: 20px; }

        .data-table-pro { width: 100%; border-collapse: separate; border-spacing: 0; }
        .data-table-pro th { 
            background: #f8fafc; 
            padding: 25px; 
            text-align: left; 
            font-size: 0.9rem; 
            color: var(--text-secondary); 
            border-bottom: 6px solid var(--border-color); 
            position: sticky; 
            top: 0; 
            z-index: 100;
            cursor: pointer;
            transition: 0.2s;
        }
        .data-table-pro th:hover { color: var(--accent-blue); background: #f1f5f9; }
        
        .data-table-pro td { 
            padding: 25px; 
            border-bottom: 1px solid #f1f5f9; 
            font-size: 1.05rem; 
            font-weight: 700; 
        }

        /* JERARQUÍA VISUAL DINÁMICA */
        .row-lvl-1 { background: #f8fafc; cursor: pointer; border-left: 14px solid var(--core-dark); }
        .row-lvl-2 { display: none; background: #ffffff; cursor: pointer; border-left: 24px solid var(--accent-blue); }
        .row-lvl-3 { display: none; background: #fafafa; border-left: 40px solid #cbd5e1; font-size: 0.9rem; color: var(--text-secondary); }

        /* ALERTAS TÁCTICAS */
        .alert-tactical-box { 
            padding: 30px 40px; 
            border-radius: 25px; 
            margin-bottom: 25px; 
            font-size: 1.1rem; 
            font-weight: 900; 
            border-left: 18px solid; 
            display: flex; 
            justify-content: space-between; 
            align-items: center;
            box-shadow: 0 10px 25px rgba(0,0,0,0.05);
            animation: pulseAlert 2s infinite;
        }
        @keyframes pulseAlert { 
            0% { transform: scale(1); } 
            50% { transform: scale(1.02); } 
            100% { transform: scale(1); } 
        }
        .alert-crit { background: #fff1f2; color: #9f1239; border-color: #be123c; }
        .alert-warn { background: #fff7ed; color: #9a3412; border-color: #f59e0b; }

        /* BUSCADOR AVANZADO */
        .search-engine-input { 
            width: 100%; 
            padding: 30px 45px; 
            border-radius: 25px; 
            border: 5px solid var(--border-color); 
            margin-bottom: 45px; 
            font-weight: 800; 
            font-size: 1.3rem; 
            transition: all 0.3s;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.05);
        }
        .search-engine-input:focus { border-color: var(--accent-blue); outline: none; box-shadow: 0 0 20px var(--accent-soft); }

        /* BOTONES DE COMANDO */
        .btn-command {
            padding: 22px 45px;
            font-size: 1rem;
            font-weight: 900;
            border-radius: 20px;
            cursor: pointer;
            border: 3px solid var(--border-color);
            background: #ffffff;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 18px;
        }
        .btn-command:hover { background: var(--core-dark); color: white; transform: translateY(-5px); border-color: var(--core-dark); }

        /* ==========================================================================================
        RESPONSIVE ENGINE (MOBILE OPTIMIZATION)
        ==========================================================================================
        */
        @media (max-width: 1200px) {
            .kpi-dashboard-grid { grid-template-columns: repeat(2, 1fr); }
            .operations-matrix { grid-template-columns: 1fr; }
            .footer-matrix-grid { grid-template-columns: 1fr !important; }
        }

        @media (max-width: 768px) {
            body { padding: 15px; }
            .master-header { padding: 30px; flex-direction: column; gap: 25px; text-align: center; }
            .brand-container h1 { font-size: 1.8rem; letter-spacing: 8px; }
            .kpi-dashboard-grid { grid-template-columns: 1fr; }
            .kpi-data-value { font-size: 4rem; }
            .ops-card-container { padding: 25px; border-radius: 30px; }
            #map-strategic-engine { height: 450px; }
            .search-engine-input { padding: 20px; font-size: 1rem; }
        }

        /* ÚLTIMA CAPA DE DISEÑO PARA ELIMINAR BLANCOS */
        .footer-matrix-grid { 
            display: grid; 
            grid-template-columns: 1fr 1.1fr; 
            gap: 40px; 
            grid-column: span 2; 
        }
    </style>
</head>
<body>

<div id="applicationRoot" class="main-application-wrapper">
    <header class="master-header">
        <div class="brand-container">
            <i class="fas fa-fingerprint fa-4x" style="color: var(--accent-blue)"></i>
            <h1>CALI 2026</h1>
        </div>
        <div class="time-engine" id="digitalClock">SISTEMA INICIANDO...</div>
    </header>

    <div class="kpi-dashboard-grid">
        <div class="kpi-module">
            <span class="kpi-data-label"><i class="fas fa-database"></i> CENSO REGISTRADO</span>
            <span class="kpi-data-value" id="valCenso">0</span>
        </div>
        <div class="kpi-module" style="border-top-color: var(--danger-red)">
            <span class="kpi-data-label"><i class="fas fa-satellite-dish"></i> ALERTAS CRÍTICAS</span>
            <span class="kpi-data-value" id="valAlerts" style="color: var(--danger-red)">0</span>
        </div>
        <div class="kpi-module" style="border-top-color: var(--success-green)">
            <span class="kpi-data-label"><i class="fas fa-user-shield"></i> LÍDERES ACTIVOS</span>
            <span class="kpi-data-value" id="valLideres" style="color: var(--success-green)">0</span>
        </div>
        <div class="kpi-module" style="border-top-color: #d946ef">
            <span class="kpi-data-label"><i class="fas fa-venus-mars"></i> BALANCE GÉNERO</span>
            <div style="height: 85px; margin-top: 25px;"><canvas id="genderAnalytics"></canvas></div>
        </div>
    </div>

    <div class="operations-matrix">
        <div class="matrix-left">
            <div class="ops-card-container">
                <div class="ops-card-header">
                    <span class="ops-card-title"><i class="fas fa-map-marked-alt"></i> DESPLIEGUE GEOGRÁFICO</span>
                </div>
                <div id="map-strategic-engine"></div>
            </div>

            <div class="ops-card-container">
                <div class="ops-card-header">
                    <span class="ops-card-title"><i class="fas fa-sitemap"></i> JERARQUÍA DE PODER</span>
                    <button class="btn-command" onclick="executeMegaExport()">
                        <i class="fas fa-file-excel" style="color: #059669"></i> EXPORTAR ESTRUCTURA
                    </button>
                </div>
                <div class="table-viewport-engine" style="height: 940px;">
                    <table class="data-table-pro" id="tblHierarchy">
                        <thead>
                            <tr>
                                <th style="width: 60%">LOCALIZACIÓN</th>
                                <th style="text-align:center">VOTOS</th>
                                <th style="text-align:center">% PESO</th>
                            </tr>
                        </thead>
                        <tbody id="bodyHierarchy"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="matrix-right">
            <div class="ops-card-container">
                <div class="ops-card-header"><span class="ops-card-title"><i class="fas fa-chart-pie"></i> DISTRIBUCIÓN COMUNAL</span></div>
                <div style="height: 440px;"><canvas id="donaAnalytics"></canvas></div>
                <div id="customLegend" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-top: 35px;"></div>
            </div>

            <div class="ops-card-container">
                <div class="ops-card-header"><span class="ops-card-title"><i class="fas fa-bolt"></i> ZONAS DE INTERVENCIÓN</span></div>
                <div id="alertTerminal"></div>
            </div>

            <div class="ops-card-container">
                <div class="ops-card-header"><span class="ops-card-title"><i class="fas fa-satellite"></i> LOG DE ACTIVIDAD REAL</span></div>
                <div class="table-viewport-engine" style="height: 520px;">
                    <table class="data-table-pro">
                        <tbody id="bodyRealTime"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="footer-matrix-grid">
            <div class="ops-card-container">
                <div class="ops-card-header"><span class="ops-card-title"><i class="fas fa-trophy"></i> RANKING DE LIDERAZGO</span></div>
                <div class="table-viewport-engine" style="height: 580px;">
                    <table class="data-table-pro" id="tblRanking" style="text-align: center;">
                        <thead>
                            <tr><th>OPERADOR / LÍDER</th><th>VOTOS CONSOLIDADOS</th><th>EFECTIVIDAD %</th></tr>
                        </thead>
                        <tbody id="bodyRanking"></tbody>
                    </table>
                </div>
            </div>

            <div class="ops-card-container">
                <div class="ops-card-header"><span class="ops-card-title"><i class="fas fa-search-location"></i> CONSOLIDADO MAESTRO</span></div>
                <input type="text" id="globalSearch" onkeyup="performGlobalSearch()" placeholder="FILTRAR POR NOMBRE, CÉDULA O TELÉFONO..." class="search-engine-input">
                <div class="table-viewport-engine" style="height: 480px;">
                    <table class="data-table-pro" id="tblMaster">
                        <thead>
                            <tr><th>NOMBRE COMPLETO</th><th>CÉDULA</th><th>TELÉFONO</th><th>PUESTO</th><th>C.</th></tr>
                        </thead>
                        <tbody id="bodyMaster"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    /* ==========================================================================================
    CAPA DE LÓGICA CORE v9.0 (HYPER-ROBUST)
    ==========================================================================================
    */
    const DB_URL = 'https://pmwlkdariynhaqbqursp.supabase.co';
    const DB_KEY = 'sb_publishable_zCu9cBa2qf9HqQuZ2YufzA_yTmwfiHv';
    const _SUPA = supabase.createClient(DB_URL, DB_KEY);
    Chart.register(ChartDataLabels);

    let GLOBAL_DATA = [], PUESTOS_REF = [], MAP_INS, LAYER_MARKERS, CH_DONA, CH_GENDER;

    // COORDENADAS ESTRATÉGICAS CALI
    const GEOPOS = { 
        "1":[3.450,-76.550],"2":[3.475,-76.525],"3":[3.452,-76.533],"4":[3.468,-76.508],"5":[3.478,-76.492],
        "6":[3.485,-76.485],"7":[3.458,-76.488],"8":[3.445,-76.500],"9":[3.440,-76.515],"10":[3.428,-76.520],
        "11":[3.415,-76.510],"12":[3.428,-76.495],"13":[3.410,-76.485],"14":[3.415,-76.470],"15":[3.400,-76.475],
        "16":[3.410,-76.500],"17":[3.385,-76.520],"18":[3.375,-76.545],"19":[3.425,-76.545],"20":[3.415,-76.555],
        "21":[3.425,-76.465],"22":[3.355,-76.535],"24":[3.350,-76.510],"25":[3.370,-76.570],"33":[3.480,-76.570] 
    };

    const CORE_COLORS = ['#2563eb', '#10b981', '#f59e0b', '#7c3aed', '#db2777', '#0891b2', '#ea580c', '#4f46e5', '#14b8a6', '#f97316'];

    // --- FUNCIONES DE AUDITORÍA Y SEGURIDAD ---
    
    /**
     * Valida la integridad del registro según los 3 datos obligatorios: Cédula, Nombre y Teléfono.
     * Implementa lógica de redundancia para evitar conteos erróneos.
     */
    function auditDataIntegrity(record) {
        if (!record.cedula || record.cedula.length < 5) return false;
        if (!record["Nombres y apellidos"] || record["Nombres y apellidos"].length < 3) return false;
        if (!record.telefono || record.telefono.length < 7) return false;
        return true;
    }

    async function initializeSystem() {
        const { value: access_key } = await Swal.fire({
            title: 'AUTENTICACIÓN REQUERIDA',
            text: 'INGRESE LA CLAVE MAESTRA DE OPERACIÓN',
            input: 'password',
            confirmButtonColor: '#020617',
            allowOutsideClick: false
        });
        
        if(access_key === 'ADMIN2026') {
            document.getElementById('applicationRoot').style.display = 'block';
            MAP_INS = L.map('map-strategic-engine').setView([3.42, -76.52], 12);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png').addTo(MAP_INS);
            LAYER_MARKERS = L.layerGroup().addTo(MAP_INS);
            
            await triggerDataSync();
            setInterval(() => {
                document.getElementById('digitalClock').innerText = new Date().toLocaleString();
            }, 1000);
        } else {
            Swal.fire('ACCESO DENEGADO', 'CLAVE INCORRECTA', 'error').then(() => initializeSystem());
        }
    }

    /**
     * Sincronización masiva con Supabase con gestión de errores extendida
     */
    async function triggerDataSync() {
        try {
            const [resPuestos, resVotantes] = await Promise.all([
                _SUPA.from('PUESTOS_VOTACION').select('*'),
                _SUPA.from('VOTANTES').select('*').order('created_at', { ascending: false })
            ]);

            if(resPuestos.error) throw resPuestos.error;
            if(resVotantes.error) throw resVotantes.error;

            PUESTOS_REF = resPuestos.data || [];
            // Aplicamos auditoría de datos obligatorios
            GLOBAL_DATA = (resVotantes.data || []).filter(auditDataIntegrity);
            
            console.log(`SYNC COMPLETE: ${GLOBAL_DATA.length} RECORDS AUDITED.`);
            coreEngineExecution();
        } catch (error) {
            console.error("CRITICAL SYNC ERROR:", error);
            Swal.fire('ERROR DE CONEXIÓN', 'REINTENTANDO EN 5 SEGUNDOS...', 'warning');
            setTimeout(triggerDataSync, 5000);
        }
    }

    /**
     * Motor de procesamiento jerárquico
     */
    function coreEngineExecution() {
        const totalAudited = GLOBAL_DATA.length || 1;
        document.getElementById('valCenso').innerText = GLOBAL_DATA.length;
        
        // Estructuras de acumulación
        let stats = { 
            comunas: {}, 
            puestos: {}, 
            mesas: {}, 
            lideres: {}, 
            genero: { h: 0, m: 0 } 
        };

        GLOBAL_DATA.forEach(reg => {
            // Lógica de Género (Inferencia por terminación y nombres comunes)
            const nombre = (reg["Nombres y apellidos"] || "").toUpperCase();
            if(nombre.endsWith('A') || nombre.includes('MARIA') || nombre.includes('ANA') || nombre.includes('ISABEL')) {
                stats.genero.m++;
            } else {
                stats.genero.h++;
            }

            // Conteo de Liderazgo
            const lid = (reg.lider || "ACCESO DIRECTO").toUpperCase();
            stats.lideres[lid] = (stats.lideres[lid] || 0) + 1;

            // Mapeo Territorial
            const puestoObj = PUESTOS_REF.find(p => p.nombre_puesto.toUpperCase() === (reg.puesto||"").toUpperCase());
            if(puestoObj) {
                const cNum = puestoObj.comuna;
                stats.comunas[cNum] = (stats.comunas[cNum] || 0) + 1;
                
                // Rama de Puestos
                stats.puestos[cNum] = stats.puestos[cNum] || {};
                stats.puestos[cNum][reg.puesto] = (stats.puestos[cNum][reg.puesto] || 0) + 1;
                
                // Rama de Mesas
                stats.mesas[reg.puesto] = stats.mesas[reg.puesto] || {};
                const mNum = reg.mesa || "0";
                stats.mesas[reg.puesto][mNum] = (stats.mesas[reg.puesto][mNum] || 0) + 1;
            }
        });

        document.getElementById('valLideres').innerText = Object.keys(stats.lideres).length;

        // RENDER LOG ACTIVIDAD
        document.getElementById('bodyRealTime').innerHTML = GLOBAL_DATA.slice(0, 15).map(v => `
            <tr>
                <td>
                    <div style="display:flex; flex-direction:column">
                        <span style="color:var(--core-dark)">${v["Nombres y apellidos"]}</span>
                        <small style="color:var(--accent-blue)">ID: ${v.cedula} | LÍDER: ${v.lider || 'N/A'}</small>
                    </div>
                </td>
                <td align="right" style="color:var(--text-secondary)">${new Date(v.created_at).toLocaleTimeString()}</td>
            </tr>
        `).join('');

        // RENDER JERARQUÍA HTML (EXPANDIBLE)
        renderHierarchyHTML(stats, totalAudited);

        // RENDER RANKING
        document.getElementById('bodyRanking').innerHTML = Object.entries(stats.lideres)
            .sort((a,b) => b[1] - a[1])
            .map(([nombre, votos]) => `
                <tr>
                    <td style="text-align:left; padding-left:40px">${nombre}</td>
                    <td style="color:var(--accent-blue)">${votos}</td>
                    <td>${((votos/totalAudited)*100).toFixed(1)}%</td>
                </tr>
            `).join('');

        // RENDER BASE MAESTRA
        document.getElementById('bodyMaster').innerHTML = GLOBAL_DATA.map(v => {
            const pInfo = PUESTOS_REF.find(x => x.nombre_puesto.toUpperCase() === (v.puesto||"").toUpperCase());
            return `
                <tr>
                    <td>${v["Nombres y apellidos"]}</td>
                    <td>${v.cedula}</td>
                    <td>${v.telefono}</td>
                    <td style="font-size:0.85rem">${v.puesto}</td>
                    <td align="center">${pInfo ? pInfo.comuna : '-'}</td>
                </tr>
            `;
        }).join('');

        // GESTIÓN DE ALERTAS (CRITERIO: 0 + 5 MENORES)
        executeAlertProtocol(stats);

        // ACTUALIZACIÓN DE GRÁFICAS Y MAPA
        refreshVisualModules(stats, totalAudited);
    }

    /**
     * Construye la tabla jerárquica con lógica de colapso
     */
    function renderHierarchyHTML(stats, total) {
        let html = "";
        Object.keys(GEOPOS).sort((a,b) => a - b).forEach(comunaID => {
            const valComuna = stats.comunas[comunaID] || 0;
            const percComuna = ((valComuna/total)*100).toFixed(1);
            
            html += `
                <tr class="row-lvl-1" onclick="toggleHierarchyRow('c-${comunaID}')">
                    <td>COMUNA ${comunaID}</td>
                    <td align="center">${valComuna}</td>
                    <td align="center">${percComuna}%</td>
                </tr>
            `;

            if(stats.puestos[comunaID]) {
                Object.entries(stats.puestos[comunaID]).forEach(([puestoNom, valPuesto]) => {
                    const cleanPID = `p-${puestoNom.replace(/\s+/g, '')}`;
                    html += `
                        <tr class="c-${comunaID} row-lvl-2" data-child-group="${cleanPID}" onclick="toggleHierarchyRow('${cleanPID}')">
                            <td>&nbsp;&nbsp;&nbsp;&nbsp;<i class="fas fa-caret-right"></i> ${puestoNom}</td>
                            <td align="center">${valPuesto}</td>
                            <td align="center">${((valPuesto/total)*100).toFixed(1)}%</td>
                        </tr>
                    `;
                    
                    if(stats.mesas[puestoNom]) {
                        Object.entries(stats.mesas[puestoNom]).forEach(([mesaNum, valMesa]) => {
                            html += `
                                <tr class="c-${comunaID} ${cleanPID} row-lvl-3">
                                    <td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MESA ${mesaNum}</td>
                                    <td align="center">${valMesa}</td>
                                    <td align="center">${((valMesa/total)*100).toFixed(1)}%</td>
                                </tr>
                            `;
                        });
                    }
                });
            }
        });
        document.getElementById('bodyHierarchy').innerHTML = html;
    }

    /**
     * Lógica de colapso/expansión de filas
     */
    function toggleHierarchyRow(className) {
        const targetRows = document.getElementsByClassName(className);
        if(!targetRows.length) return;
        
        const isCurrentlyVisible = targetRows[0].style.display === 'table-row';
        
        for(let row of targetRows) {
            row.style.display = isCurrentlyVisible ? 'none' : 'table-row';
            // Si ocultamos, también ocultamos recursivamente a los hijos
            if(isCurrentlyVisible && row.dataset.childGroup) {
                const subChildren = document.getElementsByClassName(row.dataset.childGroup);
                for(let sub of subChildren) sub.style.display = 'none';
            }
        }
    }

    /**
     * Protocolo de detección de zonas críticas
     */
    function executeAlertProtocol(stats) {
        const rankingAlertas = Object.keys(GEOPOS).map(cID => ({
            id: cID, 
            votos: stats.comunas[cID] || 0
        })).sort((a,b) => a.votos - b.votos);

        // Unimos las comunas en 0 y las 5 con menos registros que no sean 0
        const seleccionAlertas = [
            ...rankingAlertas.filter(x => x.votos === 0),
            ...rankingAlertas.filter(x => x.votos > 0).slice(0, 5)
        ];

        document.getElementById('valAlerts').innerText = seleccionAlertas.length;
        document.getElementById('alertTerminal').innerHTML = seleccionAlertas.map(a => `
            <div class="alert-tactical-box ${a.votos === 0 ? 'alert-crit' : 'alert-warn'}">
                <span>COMUNA ${a.id}</span>
                <span style="font-family:'JetBrains Mono'">${a.votos} REGISTROS</span>
            </div>
        `).join('');
    }

    /**
     * Actualiza el Mapa y las Gráficas
     */
    function refreshVisualModules(stats, total) {
        // MAPA
        LAYER_MARKERS.clearLayers();
        Object.keys(GEOPOS).forEach(cKey => {
            const vCount = stats.comunas[cKey] || 0;
            const colorBase = vCount === 0 ? '#be123c' : '#2563eb';
            
            L.circle(GEOPOS[cKey], {
                color: colorBase,
                fillColor: colorBase,
                fillOpacity: 0.5,
                radius: 400 + (vCount * 18)
            }).addTo(LAYER_MARKERS).bindTooltip(`COMUNA ${cKey}: ${vCount} VOTOS`);
        });

        // DONA DE COMUNAS
        const labelsD = Object.keys(stats.comunas).sort((a,b) => a - b);
        const dataD = labelsD.map(l => stats.comunas[l]);
        
        if(CH_DONA) CH_DONA.destroy();
        CH_DONA = new Chart(document.getElementById('donaAnalytics'), {
            type: 'doughnut',
            data: {
                labels: labelsD,
                datasets: [{
                    data: dataD,
                    backgroundColor: CORE_COLORS,
                    borderWidth: 4,
                    borderColor: '#ffffff'
                }]
            },
            options: {
                maintainAspectRatio: false,
                cutout: '72%',
                plugins: {
                    legend: { display: false },
                    datalabels: {
                        display: true,
                        color: '#fff',
                        font: { weight: 'bold', size: 11 },
                        formatter: (val) => ((val/total)*100).toFixed(0) + '%'
                    }
                }
            }
        });

        // BARRAS DE GÉNERO
        if(CH_GENDER) CH_GENDER.destroy();
        CH_GENDER = new Chart(document.getElementById('genderAnalytics'), {
            type: 'bar',
            data: {
                labels: ['HOMBRES', 'MUJERES'],
                datasets: [{
                    data: [stats.genero.h, stats.genero.m],
                    backgroundColor: ['#2563eb', '#d946ef'],
                    borderRadius: 12
                }]
            },
            options: {
                indexAxis: 'y',
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    datalabels: { color: '#fff', font: { weight: 'bold' } }
                },
                scales: {
                    x: { display: false },
                    y: { display: false }
                }
            }
        });
    }

    /**
     * Sistema de Exportación Jerárquica Binaria Perfecta
     */
    function executeMegaExport() {
        let dataMatrix = [["NIVEL ESTRATÉGICO", "NOMBRE", "VOTOS", "PORCENTAJE DE PESO"]];
        let stats = { com: {}, pue: {}, mes: {} };
        
        GLOBAL_DATA.forEach(r => {
            const pObj = PUESTOS_REF.find(x => x.nombre_puesto.toUpperCase() === (r.puesto||"").toUpperCase());
            if(pObj) {
                const c = pObj.comuna;
                stats.com[c] = (stats.com[c] || 0) + 1;
                stats.pue[c] = stats.pue[c] || {};
                stats.pue[c][r.puesto] = (stats.pue[c][r.puesto] || 0) + 1;
                stats.mes[r.puesto] = stats.mes[r.puesto] || {};
                const m = r.mesa || "0";
                stats.mes[r.puesto][m] = (stats.mes[r.puesto][m] || 0) + 1;
            }
        });

        const total = GLOBAL_DATA.length || 1;
        
        Object.keys(GEOPOS).sort((a,b) => a - b).forEach(c => {
            const vC = stats.com[c] || 0;
            dataMatrix.push(["COMUNA", `COMUNA ${c}`, vC, `${((vC/total)*100).toFixed(2)}%`]);
            if(stats.pue[c]) {
                Object.entries(stats.pue[c]).forEach(([pNom, vP]) => {
                    dataMatrix.push(["   - PUESTO", pNom, vP, `${((vP/total)*100).toFixed(2)}%`]);
                    if(stats.mes[pNom]) {
                        Object.entries(stats.mes[pNom]).forEach(([mNum, vM]) => {
                            dataMatrix.push(["      -- MESA", `MESA ${mNum}`, vM, `${((vM/total)*100).toFixed(2)}%`]);
                        });
                    }
                });
            }
        });

        const worksheet = XLSX.utils.aoa_to_sheet(dataMatrix);
        const workbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(workbook, worksheet, "ESTRUCTURA_JERARQUICA");
        XLSX.writeFile(workbook, `REPORTE_CALI_2026_MASTER.xlsx`);
    }

    /**
     * Motor de Búsqueda Global
     */
    function performGlobalSearch() {
        const query = document.getElementById('globalSearch').value.toUpperCase();
        const rows = document.getElementById('bodyMaster').rows;
        for (let row of rows) {
            row.style.display = row.innerText.toUpperCase().includes(query) ? '' : 'none';
        }
    }

    // DISPARO INICIAL
    window.onload = initializeSystem;
</script>
</body>
</html>
