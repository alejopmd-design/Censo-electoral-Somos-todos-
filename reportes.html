<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GESTIÓN 2026 | UNIDAD DE MANDO CENTRAL</title>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800;900&family=JetBrains+Mono:wght@500;800&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        /* =============================================================================================
           DISEÑO DE INTERFAZ: ALTA DENSIDAD Y CONTROL TOTAL DE ESPACIOS
           ============================================================================================= */
        :root {
            --primary: #2563eb;
            --primary-dark: #1e40af;
            --bg-master: #0f172a;
            --bg-interface: #f1f5f9;
            --panel-white: #ffffff;
            --text-bold: #020617;
            --text-soft: #64748b;
            --danger: #be123c;
            --success: #10b981;
            --warning: #f59e0b;
            --border: #e2e8f0;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; outline: none; }
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-interface);
            color: var(--text-bold);
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            overflow-x: hidden;
        }

        /* COMPONENTES DE CARGA CRÍTICOS */
        #loader-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg-master); display: flex; flex-direction: column;
            justify-content: center; align-items: center; z-index: 9999; color: white;
            transition: opacity 0.5s ease;
        }

        .spinner {
            width: 70px; height: 70px; border: 8px solid rgba(255,255,255,0.1);
            border-top-color: var(--primary); border-radius: 50%;
            animation: spin 0.8s linear infinite; margin-bottom: 25px;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        /* HEADER DE GESTIÓN */
        .system-header {
            background: linear-gradient(135deg, var(--bg-master) 0%, #1e293b 100%);
            padding: 25px 45px;
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 10px solid var(--primary);
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            position: sticky; top: 0; z-index: 1000;
        }

        .brand-zone { display: flex; align-items: center; gap: 20px; }
        .brand-zone i { font-size: 3rem; color: var(--primary); }
        .brand-zone h1 { color: white; font-size: 2.5rem; font-weight: 900; letter-spacing: 8px; line-height: 1; }
        .brand-zone p { color: var(--primary); font-size: 0.8rem; font-weight: 800; letter-spacing: 3px; }

        .clock-zone {
            font-family: 'JetBrains Mono', monospace;
            background: rgba(255,255,255,0.07);
            padding: 15px 30px; border-radius: 12px;
            border: 1px solid rgba(255,255,255,0.1);
            text-align: right;
        }
        .clock-zone #time { color: white; font-size: 1.6rem; font-weight: 800; display: block; }

        /* CONTENEDOR PRINCIPAL - AJUSTADO PARA EVITAR HUECOS */
        .main-wrapper { 
            display: none; padding: 30px; max-width: 1900px; margin: 0 auto; 
        }

        /* DASHBOARD GRID */
        .kpi-row {
            display: grid; grid-template-columns: repeat(4, 1fr);
            gap: 25px; margin-bottom: 30px;
        }

        .kpi-box {
            background: var(--panel-white); padding: 30px; border-radius: 20px;
            border: 1px solid var(--border); border-top: 8px solid var(--primary);
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05);
            transition: all 0.3s ease;
        }
        .kpi-box:hover { transform: translateY(-5px); box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); }
        .kpi-box.danger { border-top-color: var(--danger); }
        .kpi-box.success { border-top-color: var(--success); }

        .kpi-label { color: var(--text-soft); font-size: 0.85rem; font-weight: 800; margin-bottom: 15px; display: block; }
        .kpi-val { font-size: 3.5rem; font-weight: 900; color: var(--bg-master); line-height: 1; }

        /* GRID ESTRATÉGICO CON ALINEACIÓN AL INICIO PARA ELIMINAR ESPACIOS */
        .content-grid {
            display: grid; grid-template-columns: 1.3fr 0.7fr;
            gap: 30px; align-items: start;
        }

        .card {
            background: var(--panel-white); border-radius: 25px;
            padding: 30px; margin-bottom: 30px; border: 1px solid var(--border);
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.05);
        }

        .card-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 25px; padding-bottom: 20px; border-bottom: 4px solid var(--bg-interface);
        }
        .card-title { font-size: 1.2rem; font-weight: 900; display: flex; align-items: center; gap: 15px; }

        /* MAPA INDUSTRIAL */
        #map-container {
            height: 600px; width: 100%; border-radius: 20px;
            z-index: 1; border: 6px solid var(--bg-interface);
        }

        /* TABLAS Y MOTOR DE ORDENAMIENTO */
        .table-responsive { width: 100%; overflow-x: auto; border-radius: 15px; }
        table { width: 100%; border-collapse: collapse; }
        
        th {
            background: #f8fafc; padding: 20px; text-align: left;
            font-weight: 900; color: var(--text-soft);
            border-bottom: 5px solid var(--border);
            cursor: pointer; position: relative;
            transition: 0.3s;
        }
        th:hover { background: var(--primary); color: white; }
        th.sort-asc::after { content: " ▲"; font-size: 0.8rem; color: white; }
        th.sort-desc::after { content: " ▼"; font-size: 0.8rem; color: white; }

        td { padding: 16px 20px; border-bottom: 1px solid #f1f5f9; font-weight: 700; color: var(--text-bold); font-size: 13px; }

        /* FILAS JERÁRQUICAS */
        .r-comuna { background: #f8fafc; border-left: 12px solid var(--bg-master); cursor: pointer; }
        .r-puesto { display: none; background: white; border-left: 35px solid var(--primary); cursor: pointer; }
        .r-mesa { display: none; background: #fafafa; border-left: 65px solid #cbd5e1; font-size: 0.9em; }

        /* BOTONES */
        .btn {
            padding: 14px 26px; border-radius: 12px; border: none;
            font-weight: 900; cursor: pointer; display: flex;
            align-items: center; gap: 12px; transition: 0.3s;
        }
        .btn-excel { background: var(--success); color: white; }
        .btn-dark { background: var(--bg-master); color: white; }
        .btn:hover { transform: scale(1.05); filter: brightness(1.1); box-shadow: 0 10px 15px rgba(0,0,0,0.1); }

        /* ALERTAS REGLA 24/01 */
        .alert-zone { display: flex; flex-direction: column; gap: 15px; }
        .alert-card {
            padding: 20px 25px; border-radius: 15px; font-weight: 900;
            display: flex; justify-content: space-between; align-items: center;
            border-left: 20px solid; box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        }
        .al-crit { background: #fee2e2; color: #991b1b; border-color: var(--danger); }
        .al-warn { background: #ffedd5; color: #9a3412; border-color: var(--warning); }

        /* BUSQUEDA */
        .search-container { position: relative; margin-bottom: 25px; }
        .search-input {
            width: 100%; padding: 22px 30px; border-radius: 15px;
            border: 4px solid var(--border); font-size: 1.1rem; font-weight: 800;
            transition: all 0.3s ease; background: #fcfcfc;
        }
        .search-input:focus { border-color: var(--primary); box-shadow: 0 0 0 8px rgba(37,99,235,0.1); background: white; }

        /* AUDITORÍA MAESTRA */
        .audit-scroll { max-height: 500px; overflow-y: auto; border-radius: 10px; border: 1px solid var(--border); }

    </style>
</head>
<body>

    <div id="loader-overlay">
        <div class="spinner"></div>
        <h2 style="letter-spacing: 15px; font-weight: 900;">GESTIÓN 2026</h2>
        <p id="load-msg" style="margin-top: 20px; opacity: 0.7; font-weight: 800; color: var(--primary);">ESTABLECIENDO CONEXIÓN SEGURA...</p>
    </div>

    <div id="app-root" class="main-wrapper">
        <header class="system-header">
            <div class="brand-zone">
                <i class="fas fa-shield-halved"></i>
                <div>
                    <h1>GESTIÓN 2026</h1>
                    <p>MANDO ESTRATÉGICO Y CONTROL TERRITORIAL</p>
                </div>
            </div>
            <div class="clock-zone">
                <span id="time">00:00:00</span>
                <span style="color: var(--success); font-weight: 900; font-size: 0.75rem; letter-spacing: 2px;">SISTEMA EN LÍNEA</span>
            </div>
        </header>

        <div class="kpi-row">
            <div class="kpi-box">
                <span class="kpi-label"><i class="fas fa-users-check"></i> CENSO DEPOSITADO (VÁLIDO 16/01)</span>
                <span class="kpi-val" id="totalVotos">0</span>
            </div>
            <div class="kpi-box danger">
                <span class="kpi-label"><i class="fas fa-radiation"></i> ALERTAS DE INTERVENCIÓN (24/01)</span>
                <span class="kpi-val" id="totalAlerts">0</span>
            </div>
            <div class="kpi-box success">
                <span class="kpi-label"><i class="fas fa-user-shield"></i> LÍDERES OPERATIVOS</span>
                <span class="kpi-val" id="totalLideres">0</span>
            </div>
            <div class="kpi-box">
                <span class="kpi-label"><i class="fas fa-venus-mars"></i> BALANCE DE GÉNERO</span>
                <div style="height: 60px; margin-top: 10px;"><canvas id="chartMini"></canvas></div>
            </div>
        </div>

        <div class="content-grid">
            <div class="view-left">
                <div class="card">
                    <div class="card-header">
                        <span class="card-title"><i class="fas fa-map-location-dot"></i> DESPLIEGUE TERRITORIAL CALI</span>
                    </div>
                    <div id="map-container"></div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <span class="card-title"><i class="fas fa-network-wired"></i> ESTRUCTURA JERÁRQUICA DE VOTACIÓN</span>
                        <button class="btn btn-excel" onclick="exportHierarchicalExcel()">
                            <i class="fas fa-file-excel"></i> EXCEL JERARQUÍA INDENTADA
                        </button>
                    </div>
                    <div class="table-responsive">
                        <table id="hierarchyTable">
                            <thead>
                                <tr>
                                    <th onclick="sortTable('hierarchyTable', 0)">NIVEL ESTRUCTURAL</th>
                                    <th onclick="sortTable('hierarchyTable', 1)" style="text-align:center">VOTOS TOTALES</th>
                                    <th onclick="sortTable('hierarchyTable', 2)" style="text-align:center">% PESO</th>
                                </tr>
                            </thead>
                            <tbody id="hierarchyBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="view-right">
                <div class="card">
                    <div class="card-header"><span class="card-title"><i class="fas fa-chart-pie"></i> RENDIMIENTO POR COMUNAS</span></div>
                    <div style="height: 400px;"><canvas id="mainDona"></canvas></div>
                    <div id="legendDona" style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 20px;"></div>
                </div>

                <div class="card" style="border-top: 10px solid var(--danger);">
                    <div class="card-header" style="color: var(--danger);">
                        <span class="card-title"><i class="fas fa-bell"></i> FOCOS ROJOS PRIORITARIOS (24/01)</span>
                    </div>
                    <div id="alertBox" class="alert-zone"></div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <span class="card-title"><i class="fas fa-database"></i> AUDITORÍA DE DATOS MAESTRA</span>
                        <button class="btn btn-dark" onclick="exportMasterTable()">
                            <i class="fas fa-file-csv"></i>
                        </button>
                    </div>
                    <div class="search-container">
                        <input type="text" id="searchInput" class="search-input" placeholder="FILTRAR POR NOMBRE, CÉDULA O LÍDER..." onkeyup="filterMasterTable()">
                    </div>
                    <div class="audit-scroll">
                        <table id="masterTable">
                            <thead>
                                <tr>
                                    <th onclick="sortTable('masterTable', 0)">NOMBRE COMPLETO</th>
                                    <th onclick="sortTable('masterTable', 1)">IDENTIFICACIÓN</th>
                                    <th onclick="sortTable('masterTable', 2)">LÍDER ENCARGADO</th>
                                </tr>
                            </thead>
                            <tbody id="masterBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        /**
         * CONFIGURACIÓN DE NÚCLEO Y CREDENCIALES
         */
        const SB_URL = 'https://pmwlkdariynhaqbqursp.supabase.co';
        const SB_KEY = 'sb_publishable_zCu9cBa2qf9HqQuZ2YufzA_yTmwfiHv';
        const _db = supabase.createClient(SB_URL, SB_KEY);

        let GLOBAL_VOTANTES = [];
        let GLOBAL_PUESTOS = [];
        let MAP_ENGINE, MARKERS;
        let CHART_DONA, CHART_MINI;

        const PALETTE = ['#2563eb', '#10b981', '#f59e0b', '#d946ef', '#06b6d4', '#f43f5e', '#8b5cf6', '#14b8a6', '#f97316', '#475569', '#ec4899', '#6366f1'];

        // Geometría de Cali por Comunas
        const COORDS_CALI = {
            "1":[3.450,-76.550],"2":[3.475,-76.525],"3":[3.452,-76.533],"4":[3.468,-76.508],"5":[3.478,-76.492],
            "6":[3.485,-76.485],"7":[3.458,-76.488],"8":[3.445,-76.500],"9":[3.440,-76.515],"10":[3.428,-76.520],
            "11":[3.415,-76.510],"12":[3.428,-76.495],"13":[3.410,-76.485],"14":[3.415,-76.470],"15":[3.400,-76.475],
            "16":[3.410,-76.500],"17":[3.385,-76.520],"18":[3.375,-76.545],"19":[3.425,-76.545],"20":[3.415,-76.555],
            "21":[3.425,-76.465],"22":[3.355,-76.535],"24":[3.350,-76.510],"25":[3.370,-76.570],"33":[3.480,-76.570]
        };

        /**
         * ARRANQUE SEGURO
         */
        window.onload = async () => {
            const { value: accessKey } = await Swal.fire({
                title: 'SEGURIDAD GESTIÓN 2026',
                input: 'password',
                inputPlaceholder: 'INGRESE LLAVE MAESTRA',
                confirmButtonColor: '#0f172a',
                allowOutsideClick: false
            });

            if (accessKey === 'ADMIN2026') {
                const loader = document.getElementById('loader-overlay');
                loader.style.opacity = '0';
                setTimeout(() => {
                    loader.style.display = 'none';
                    document.getElementById('app-root').style.display = 'block';
                    bootstrap();
                }, 600);
            } else {
                location.reload();
            }
        };

        function bootstrap() {
            MAP_ENGINE = L.map('map-container').setView([3.42, -76.52], 12);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png').addTo(MAP_ENGINE);
            MARKERS = L.layerGroup().addTo(MAP_ENGINE);
            
            fetchData();
            setInterval(() => {
                document.getElementById('time').innerText = new Date().toLocaleTimeString();
            }, 1000);
        }

        /**
         * GESTIÓN DE DATOS (REGLA 16/01)
         */
        async function fetchData() {
            try {
                const [p, v] = await Promise.all([
                    _db.from('PUESTOS_VOTACION').select('*'),
                    _db.from('VOTANTES').select('*').order('created_at', { ascending: false })
                ]);

                GLOBAL_PUESTOS = p.data || [];
                
                // Aplicación estricta Regla 16/01: Cédula, Nombre, Teléfono
                GLOBAL_VOTANTES = (v.data || []).filter(reg => {
                    return reg.cedula && reg["Nombres y apellidos"] && reg.telefono;
                });

                processData();
            } catch (err) {
                Swal.fire('ERROR DE SINCRONIZACIÓN', 'No se pudo conectar con el núcleo de Supabase', 'error');
            }
        }

        /**
         * PROCESAMIENTO ANALÍTICO MASIVO
         */
        function processData() {
            const total = GLOBAL_VOTANTES.length || 1;
            document.getElementById('totalVotos').innerText = GLOBAL_VOTANTES.length;

            const stats = { 
                comunas: {}, puestos: {}, mesas: {}, lideres: {},
                genero: { h: 0, m: 0 } 
            };

            GLOBAL_VOTANTES.forEach(v => {
                // Cálculo de Género
                const n = (v["Nombres y apellidos"] || "").toUpperCase();
                if(n.endsWith('A') || n.includes('MARIA') || n.includes('ANA') || n.includes('LUZ')) stats.genero.m++; else stats.genero.h++;

                // Líderes
                const lid = (v.lider || "ASIGNACIÓN DIRECTA").toUpperCase();
                stats.lideres[lid] = (stats.lideres[lid] || 0) + 1;

                // Estructura Geográfica
                const pInfo = GLOBAL_PUESTOS.find(p => p.nombre_puesto.toUpperCase() === (v.puesto||"").toUpperCase());
                if(pInfo) {
                    const c = pInfo.comuna;
                    stats.comunas[c] = (stats.comunas[c] || 0) + 1;
                    stats.puestos[c] = stats.puestos[c] || {};
                    stats.puestos[c][v.puesto] = (stats.puestos[c][v.puesto] || 0) + 1;
                    stats.mesas[v.puesto] = stats.mesas[v.puesto] || {};
                    const m = v.mesa || "PENDIENTE";
                    stats.mesas[v.puesto][m] = (stats.mesas[v.puesto][m] || 0) + 1;
                }
            });

            document.getElementById('totalLideres').innerText = Object.keys(stats.lideres).length;
            
            renderHierarchy(stats, total);
            renderAlerts(stats);
            renderVisuals(stats, total);
            renderMasterBody();
        }

        /**
         * TABLA JERÁRQUICA EXPANDIBLE
         */
        function renderHierarchy(stats, total) {
            const container = document.getElementById('hierarchyBody');
            let rowsHtml = "";
            const idsComunas = Object.keys(COORDS_CALI).sort((a,b) => a-b);

            idsComunas.forEach(id => {
                const v = stats.comunas[id] || 0;
                const p = ((v/total)*100).toFixed(1);

                rowsHtml += `
                    <tr class="r-comuna" onclick="toggleView('c-${id}')">
                        <td><i class="fas fa-folder-open" style="margin-right:15px"></i> COMUNA ${id}</td>
                        <td align="center">${v}</td>
                        <td align="center">${p}%</td>
                    </tr>
                `;

                if(stats.puestos[id]) {
                    Object.entries(stats.puestos[id]).forEach(([nomP, vP]) => {
                        const rowId = `p-${nomP.replace(/\W/g, '')}`;
                        rowsHtml += `
                            <tr class="r-puesto c-${id}" data-sub="${rowId}" onclick="toggleView('${rowId}')">
                                <td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <i class="fas fa-map-pin"></i> ${nomP}</td>
                                <td align="center">${vP}</td>
                                <td align="center">${((vP/total)*100).toFixed(1)}%</td>
                            </tr>
                        `;

                        if(stats.mesas[nomP]) {
                            Object.entries(stats.mesas[nomP]).forEach(([nM, vM]) => {
                                rowsHtml += `
                                    <tr class="r-mesa c-${id} ${rowId}">
                                        <td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; MESA N° ${nM}</td>
                                        <td align="center">${vM}</td>
                                        <td align="center">${((vM/total)*100).toFixed(2)}%</td>
                                    </tr>
                                `;
                            });
                        }
                    });
                }
            });
            container.innerHTML = rowsHtml;
        }

        function toggleView(cls) {
            const elements = document.getElementsByClassName(cls);
            if(!elements.length) return;
            const state = elements[0].style.display === 'table-row';
            
            for(let el of elements) {
                el.style.display = state ? 'none' : 'table-row';
                if(state && el.dataset.sub) {
                    const subs = document.getElementsByClassName(el.dataset.sub);
                    for(let s of subs) s.style.display = 'none';
                }
            }
        }

        /**
         * ALERTAS REGLA 24/01
         */
        function renderAlerts(stats) {
            const box = document.getElementById('alertBox');
            const data = Object.keys(COORDS_CALI).map(id => ({ id, v: stats.comunas[id] || 0 }));
            
            const criticas = data.filter(x => x.v === 0);
            const bajas = data.filter(x => x.v > 0).sort((a,b) => a.v - b.v).slice(0, 5);
            
            document.getElementById('totalAlerts').innerText = criticas.length + bajas.length;

            let h = "";
            criticas.forEach(c => h += `<div class="alert-card al-crit"><span>COMUNA ${c.id}</span><span>SIN REGISTROS</span></div>`);
            bajas.forEach(c => h += `<div class="alert-card al-warn"><span>COMUNA ${c.id}</span><span>${c.v} VOTOS</span></div>`);
            
            box.innerHTML = h || `<p style="text-align:center; padding:20px; opacity:0.5;">META TERRITORIAL AL 100%</p>`;
        }

        /**
         * MOTOR DE ORDENAMIENTO DINÁMICO
         */
        function sortTable(tableId, n) {
            const table = document.getElementById(tableId);
            const header = table.querySelectorAll('th')[n];
            const isAsc = header.classList.contains('sort-asc');
            let rows, switching, i, x, y, shouldSwitch, dir, switchcount = 0;
            
            switching = true;
            dir = isAsc ? "desc" : "asc";
            
            table.querySelectorAll('th').forEach(h => h.classList.remove('sort-asc', 'sort-desc'));

            while (switching) {
                switching = false;
                rows = table.rows;
                for (i = 1; i < (rows.length - 1); i++) {
                    shouldSwitch = false;
                    x = rows[i].getElementsByTagName("TD")[n];
                    y = rows[i + 1].getElementsByTagName("TD")[n];
                    
                    let valX = x.innerText.toLowerCase();
                    let valY = y.innerText.toLowerCase();

                    // Detectar si es número o porcentaje
                    const numX = parseFloat(valX.replace('%',''));
                    const numY = parseFloat(valY.replace('%',''));

                    if (!isNaN(numX) && !isNaN(numY)) {
                        if (dir == "asc" ? numX > numY : numX < numY) { shouldSwitch = true; break; }
                    } else {
                        if (dir == "asc" ? valX > valY : valX < valY) { shouldSwitch = true; break; }
                    }
                }
                if (shouldSwitch) {
                    rows[i].parentNode.insertBefore(rows[i + 1], rows[i]);
                    switching = true;
                    switchcount++;
                } else {
                    if (switchcount == 0 && dir == "asc") { dir = "desc"; switching = true; }
                }
            }
            header.classList.add(dir === 'asc' ? 'sort-asc' : 'sort-desc');
        }

        /**
         * EXPORTACIÓN DE EXCEL JERÁRQUICO (CON INDENTACIÓN)
         */
        function exportHierarchicalExcel() {
            const wb = XLSX.utils.book_new();
            const ws_data = [["NIVEL", "LOCALIZACIÓN", "TOTAL VOTOS", "PESO %"]];
            
            const rows = document.getElementById('hierarchyBody').rows;
            for(let row of rows) {
                let padding = "";
                let tipo = "COMUNA";
                
                if(row.classList.contains('r-puesto')) { padding = "   "; tipo = "PUESTO"; }
                if(row.classList.contains('r-mesa')) { padding = "      "; tipo = "MESA"; }

                ws_data.push([
                    tipo,
                    padding + row.cells[0].innerText.trim(),
                    row.cells[1].innerText,
                    row.cells[2].innerText
                ]);
            }

            const ws = XLSX.utils.aoa_to_sheet(ws_data);
            XLSX.utils.book_append_sheet(wb, ws, "JERARQUÍA_CALI_2026");
            XLSX.writeFile(wb, `ESTRUCTURA_GESTION_2026.xlsx`);
        }

        function exportMasterTable() {
            const table = document.getElementById('masterTable');
            const wb = XLSX.utils.table_to_book(table);
            XLSX.writeFile(wb, "DATA_MAESTRA_GESTION_2026.xlsx");
        }

        /**
         * VISUALES (MAPA Y GRÁFICOS)
         */
        function renderVisuals(stats, total) {
            MARKERS.clearLayers();
            Object.keys(COORDS_CALI).forEach(id => {
                const v = stats.comunas[id] || 0;
                const rad = 300 + (v * 15);
                L.circle(COORDS_CALI[id], {
                    color: v === 0 ? '#be123c' : '#2563eb',
                    fillColor: v === 0 ? '#be123c' : '#60a5fa',
                    fillOpacity: 0.6,
                    radius: rad
                }).addTo(MARKERS).bindTooltip(`COMUNA ${id}<br>VOTOS: ${v}`);
            });

            const ctxD = document.getElementById('mainDona').getContext('2d');
            const sortedLabs = Object.keys(stats.comunas).sort((a,b) => a-b);
            const sortedData = sortedLabs.map(l => stats.comunas[l]);

            if(CHART_DONA) CHART_DONA.destroy();
            CHART_DONA = new Chart(ctxD, {
                type: 'doughnut',
                data: { labels: sortedLabs.map(l => `C-${l}`), datasets: [{ data: sortedData, backgroundColor: PALETTE }] },
                options: { maintainAspectRatio: false, cutout: '75%', plugins: { legend: { display: false } } }
            });

            document.getElementById('legendDona').innerHTML = sortedLabs.map((l, i) => `
                <div style="font-size:11px; font-weight:900; border-left:6px solid ${PALETTE[i%PALETTE.length]}; padding-left:10px;">
                    C-${l}: ${((stats.comunas[l]/total)*100).toFixed(1)}%
                </div>
            `).join('');

            const ctxM = document.getElementById('chartMini').getContext('2d');
            if(CHART_MINI) CHART_MINI.destroy();
            CHART_MINI = new Chart(ctxM, {
                type: 'bar',
                data: { labels: ['H', 'M'], datasets: [{ data: [stats.genero.h, stats.genero.m], backgroundColor: ['#2563eb', '#f472b6'] }] },
                options: { indexAxis: 'y', maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { display: false }, y: { display: false } } }
            });
        }

        function renderMasterBody() {
            const b = document.getElementById('masterBody');
            b.innerHTML = GLOBAL_VOTANTES.slice(0, 500).map(v => `
                <tr>
                    <td>${v["Nombres y apellidos"]}</td>
                    <td>${v.cedula}</td>
                    <td>${v.lider || 'CALI'}</td>
                </tr>
            `).join('');
        }

        function filterMasterTable() {
            const q = document.getElementById('searchInput').value.toUpperCase();
            const rows = document.getElementById('masterBody').rows;
            for(let r of rows) r.style.display = r.innerText.toUpperCase().includes(q) ? '' : 'none';
        }
    </script>
</body>
</html>
