<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TABLERO OPERATIVO CALI 2026</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        :root { --blue: #0f172a; --green: #10b981; --bg: #f8fafc; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); margin: 0; padding: 15px; text-transform: uppercase; overflow: hidden; }
        .container { max-width: 100%; height: 95vh; display: none; flex-direction: column; gap: 15px; }
        .top-row { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; flex-shrink: 0; }
        .mid-row { display: grid; grid-template-columns: 0.8fr 1.4fr 0.8fr; gap: 15px; flex-grow: 1; min-height: 0; }
        .card { background: white; border-radius: 12px; padding: 15px; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1); border: 1px solid #e2e8f0; display: flex; flex-direction: column; }
        .stat-num { font-size: 2.2rem; font-weight: 800; color: var(--blue); text-align: center; }
        .stat-lab { text-align: center; color: #64748b; font-size: 0.7rem; font-weight: 700; }
        .scroll { flex-grow: 1; overflow-y: auto; border: 1px solid #f1f5f9; border-radius: 8px; margin-top: 10px; }
        table { width: 100%; border-collapse: collapse; font-size: 0.75rem; }
        th { background: #f8fafc; padding: 10px; text-align: left; position: sticky; top: 0; border-bottom: 2px solid #e2e8f0; cursor: pointer; z-index: 10; }
        td { padding: 8px 10px; border-bottom: 1px solid #f1f5f9; }
        #buscador { width: 100%; padding: 12px; border-radius: 8px; border: 2px solid var(--blue); font-weight: 800; outline: none; }
        .badge { padding: 3px 6px; border-radius: 4px; font-weight: 800; font-size: 0.6rem; }
        .bg-comuna { background: #e0f2fe; color: #0369a1; }
        .bg-directo { background: #dcfce7; color: #166534; }
        .btn-excel { background: var(--blue); color: white; padding: 10px; border: none; border-radius: 6px; cursor: pointer; font-weight: 700; width: 100%; margin-top: 5px; }
    </style>
</head>
<body>

<div id="app" class="container">
    <div class="top-row">
        <div class="card"><div class="stat-lab">CENSO TOTAL</div><div class="stat-num" id="tC">0</div></div>
        <div class="card"><div class="stat-lab">VOTOS DIRECTOS</div><div class="stat-num" id="tD" style="color:var(--green)">0</div></div>
        <div class="card"><div class="stat-lab">RED INDIRECTA</div><div class="stat-num" id="tI" style="color:#6366f1">0</div></div>
    </div>

    <div class="mid-row">
        <div class="card">
            <strong>‚≠ê RANKING L√çDERES</strong>
            <div class="scroll">
                <table>
                    <thead><tr><th onclick="sortL('n')">L√çDER</th><th onclick="sortL('v')">VOTOS</th></tr></thead>
                    <tbody id="cL"></tbody>
                </table>
            </div>
        </div>

        <div class="card">
            <input type="text" id="buscador" oninput="filtrar()" placeholder="üîç BUSCAR POR NOMBRE, C√âDULA O PUESTO...">
            <div class="scroll">
                <table id="tP">
                    <thead>
                        <tr>
                            <th onclick="sortM('Nombres y apellidos')">NOMBRE</th>
                            <th onclick="sortM('cedula')">C√âDULA</th>
                            <th onclick="sortM('puesto')">PUESTO</th>
                            <th onclick="sortM('comuna')">UBIC.</th>
                        </tr>
                    </thead>
                    <tbody id="cM"></tbody>
                </table>
            </div>
            <button onclick="descargar()" class="btn-excel">üì• EXPORTAR REPORTE</button>
        </div>

        <div class="card">
            <strong>üìç GEOPOL√çTICA</strong>
            <div style="flex-grow:1;"><canvas id="chartD"></canvas></div>
        </div>
    </div>
</div>

<script>
    const SB_URL = 'https://pmwlkdariynhaqbqursp.supabase.co';
    const SB_KEY = 'sb_publishable_zCu9cBa2qf9HqQuZ2YufzA_yTmwfiHv';
    const _supabase = supabase.createClient(SB_URL, SB_KEY);

    let base = [], lideres = [], chart;
    let sM = {c:'Nombres y apellidos', a:true}, sL = {c:'v', a:false};

    // MATRIZ DE PUESTOS CON ABREVIATURAS DE TUS IM√ÅGENES
    const MAPA = {
        "1": ["ACEVEDO", "GOMEZ", "MUTIS", "CELESTINO", "GARCES", "TERRON", "VISTA HERMOSA", "AGUACATAL"],
        "2": ["NAVIA", "FRANCIA", "MERCED", "VIPASA", "LA FLORA", "ALAMOS", "GONZAGA", "GRANADA", "VERSALLES", "SENA SALOMIA", "ESTACION"],
        "3": ["SANTA LIBRADA", "SAN ANTONIO", "SAN PASCUAL", "SAN NICOLAS", "PILOTO", "FRAY DAMIAN", "EL PE√ëON"],
        "4": ["ISAACS", "SANTANDER", "OLAYA", "PORVENIR", "POPULAR", "VALENCIA", "METROPOLITANO", "FLORENCIA", "BERLIN"],
        "5": ["INEM", "CAYZEDO", "VIVAS BALCAZAR", "ZAMORANO", "RIVERA", "VERACRUZ", "CONFENALCO", "CHIMINANGOS", "SALOMIA"],
        "6": ["FLORALIA", "CALIMA", "GUAYACANES", "ALCAZARES", "PETECUY", "PUEBLO NUEVO", "GAITAN"],
        "7": ["ALFONSO LOPEZ", "10 DE MAYO", "DIEZ DE MAYO", "MALLARINO", "FUENMAYOR", "BELISARIO", "7 DE AGOSTO"],
        "8": ["MARIANO RAMOS", "CAMACHO", "AMERICAS", "INDUSTRIAL", "MUNICIPAL", "PRIMAVERAS", "SANTA MONICA", "URIBE"],
        "9": ["CALDAS", "FRANCISCO J", "AMPUDIA", "TAFUR", "ARANJUEZ", "GUAYAQUIL", "BRETA√ëA", "JUNIN", "ALAMEDA", "CHAMPAGNAT"],
        "10": ["DEPARTAMENTAL", "GUABAL", "SAN CRISTOBAL", "LLOREDA", "PASOANCHO", "COLSEGUROS", "SELVA", "PANAMERICANO"],
        "11": ["ISRAEL", "CIUDAD DE CALI", "SAN CARLOS", "ESPERANZA", "INDEPENDENCIA", "LA CASCADA", "PRADOS DE ORIENTE"],
        "12": ["VILLA DEL SUR", "SANTA FE", "SINDICAL", "VILLANUEVA", "RODEO", "FLORESTA", "ASTURIAS", "FENALCO", "DOCE DE OCTUBRE"],
        "13": ["EL DIAMANTE", "RICARDO NIETO", "POBLADO", "CHARCO AZUL", "PONDAJE", "CALIPSO", "AMAZONAS", "VILLA DEL LAGO"],
        "14": ["CALIXTO", "ALVAREZ", "TALANGA", "ALIRIO MORA", "PUERTA DEL SOL", "ORQUIDEAS", "MANUELA BELTRAN", "MARROQUIN"],
        "15": ["LLANO VERDE", "ISAURA", "RODRIGUEZ", "MOJICA", "VALLADO", "LAUREANO", "MORICHAL", "CDI", "DIAMANTE 2"],
        "16": ["ESTEBAN ROJAS", "HERNANDO NAVIA", "CRISTOBAL COLON", "UNION DE VIVIENDA", "GRAN COLOMBIA"],
        "17": ["UNIVALLE", "NUEVO LATIR", "EL INGENIO", "CANEY", "LIMONAR", "CAPRI", "MAYOTTE", "LACORDAIRE", "VALLE DEL LILI", "BOCHALEMA"],
        "18": ["POLITECNICO", "CARVAJAL", "MELENDEZ", "JORDAN", "ALTOS", "CUARTA BRIGADA", "SANTA ANITA", "CHORROS"],
        "19": ["CIEGOS", "SORDOS", "COLISEO", "PASCUAL", "ESTADIO", "EUSTAQUIO", "LIDO", "TEQUENDAMA", "SANTIAGO", "CUARTO DE LEGUA"],
        "20": ["MULTIPROPOSITO", "SILOE", "LLERAS", "BRISAS", "SULTANA"],
        "21": ["DESEPAZ", "CALIMIO", "SANTA ISABEL", "HUNGRIA", "COMPARTIR", "VALLE GRANDE", "POTRERO GRANDE"],
        "22": ["ICESI", "JAVERIANA", "PANCE", "JARDIN", "BUENAVENTURA", "ALEMAN", "LUMEN", "BERCHMANS", "BENNETT", "CA√ëASGORDAS"],
        "RURAL": ["MONTEBELLO", "FELIDIA", "SALADITO", "ELVIRA", "LEONERA", "PICHINDE", "ANDES", "VILLACARMELO", "BUITRERA", "HORMIGUERO", "CASCAJAL", "GOLONDRINAS", "LA PAZ"]
    };

    function nrm(t) { return t ? t.toString().normalize("NFD").replace(/[\u0300-\u036f]/g, "").toUpperCase().trim() : ""; }

    function getU(p) {
        const t = nrm(p); if(!t || t === "NO APLICA") return "S.D";
        for(let [c, ks] of Object.entries(MAPA)) {
            if(ks.some(k => t.includes(k))) return c === "RURAL" ? "RURAL" : "C" + c;
        }
        return "OTRA";
    }

    async function login() {
        const { value: p } = await Swal.fire({ title: 'ACCESO PRIVADO', input: 'password', confirmButtonColor: '#0f172a' });
        if(p === 'ADMIN2026') { document.getElementById('app').style.display = 'flex'; await load(); }
    }

    async function load() {
        const { data } = await _supabase.from('VOTANTES').select('*');
        base = data.map(v => ({...v, comuna: getU(v.puesto), origen: v.lider === "Rosse Mary Cabal Franco" ? "DIRECTO" : "INDIRECTO"}));
        
        const r = base.filter(v => v.lider === "Rosse Mary Cabal Franco");
        lideres = r.map(l => ({ n: l["Nombres y apellidos"], v: base.filter(x => x.lider === l["Nombres y apellidos"]).length }));
        
        upd();
    }

    function upd() {
        document.getElementById('tC').innerText = base.length;
        document.getElementById('tD').innerText = base.filter(v => v.origen === "DIRECTO").length;
        document.getElementById('tI').innerText = base.filter(v => v.origen === "INDIRECTO").length;
        renderL(); renderM(); renderC();
    }

    function filtrar() {
        const val = nrm(document.getElementById('buscador').value);
        const filas = document.getElementById('cM').getElementsByTagName('tr');
        for(let r of filas) {
            r.style.display = nrm(r.innerText).includes(val) ? "" : "none";
        }
    }

    function renderL() {
        lideres.sort((a,b) => sL.a ? a[sL.c] > b[sL.c] ? 1:-1 : a[sL.c] < b[sL.c] ? 1:-1);
        document.getElementById('cL').innerHTML = lideres.map(l => `<tr><td><b>${l.n}</b></td><td><span class="badge bg-directo">${l.v}</span></td></tr>`).join('');
    }

    function renderM() {
        base.sort((a,b) => sM.a ? nrm(a[sM.c]) > nrm(b[sM.c]) ? 1:-1 : nrm(a[sM.c]) < nrm(b[sM.c]) ? 1:-1);
        document.getElementById('cM').innerHTML = base.map(v => `<tr><td><b>${v["Nombres y apellidos"]}</b></td><td>${v.cedula}</td><td>${v.puesto||'S.D'}</td><td><span class="badge bg-comuna">${v.comuna}</span></td></tr>`).join('');
    }

    function renderC() {
        const ctx = document.getElementById('chartD');
        const d = {}; base.forEach(v => d[v.comuna] = (d[v.comuna]||0)+1);
        if(chart) chart.destroy();
        chart = new Chart(ctx, { type:'doughnut', data:{ labels:Object.keys(d), datasets:[{data:Object.values(d), backgroundColor:['#0f172a','#10b981','#6366f1','#f59e0b','#ec4899','#ef4444','#8b5cf6']}]}, options:{maintainAspectRatio:false, plugins:{legend:{position:'bottom', labels:{boxWidth:8, font:{size:9}}}}}});
    }

    function sortM(c) { sM.a = sM.c === c ? !sM.a : true; sM.c = c; renderM(); }
    function sortL(c) { sL.a = sL.c === c ? !sL.a : true; sL.c = c; renderL(); }

    function descargar() {
        const ws = XLSX.utils.json_to_sheet(base);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "DATOS");
        XLSX.writeFile(wb, "ESTRUCTURA_2026.xlsx");
    }

    login();
</script>
</body>
</html>
