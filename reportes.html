<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SISTEMA ELECTORAL CALI 2026</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        :root { --blue: #0f172a; --green: #10b981; --bg: #f1f5f9; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); margin: 0; padding: 20px; text-transform: uppercase; }
        .container { max-width: 1600px; margin: auto; display: none; }
        .card { background: white; border-radius: 12px; padding: 25px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .grid-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; }
        .stat-card { text-align: center; border-left: 5px solid var(--blue); }
        .stat-val { font-size: 2.5rem; font-weight: 900; color: var(--blue); }
        table { width: 100%; border-collapse: collapse; }
        th { background: #f8fafc; padding: 15px; text-align: left; font-size: 0.75rem; border-bottom: 2px solid #e2e8f0; cursor: pointer; position: sticky; top: 0; z-index: 10; }
        td { padding: 12px 15px; border-bottom: 1px solid #f1f5f9; font-size: 0.85rem; }
        .scroll { max-height: 500px; overflow-y: auto; border: 1px solid #e2e8f0; border-radius: 8px; }
        .badge { padding: 4px 10px; border-radius: 6px; font-weight: 800; font-size: 0.65rem; }
        .urbano { background: #e0f2fe; color: #0369a1; }
        .rural { background: #fef3c7; color: #92400e; }
        .directo { background: #dcfce7; color: #166534; }
        /* BARRA DE B√öSQUEDA DESTACADA */
        .search-container { position: sticky; top: 0; z-index: 20; background: white; padding: 10px 0; }
        input#buscador { width: 100%; padding: 20px; border-radius: 12px; border: 3px solid var(--blue); font-size: 1.2rem; font-weight: 800; box-sizing: border-box; outline: none; }
        input#buscador:focus { border-color: var(--green); box-shadow: 0 0 15px rgba(16, 185, 129, 0.2); }
        .btn { background: #1D6F42; color: white; padding: 15px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; width: 100%; margin-top: 10px; }
    </style>
</head>
<body>

<div id="app" class="container">
    <div class="grid-3">
        <div class="card stat-card"><div style="color:#64748b; font-weight:bold">POTENCIAL TOTAL</div><div class="stat-val" id="tC">0</div></div>
        <div class="card stat-card" style="border-color:var(--green)"><div style="color:#64748b; font-weight:bold">VOTOS DIRECTOS</div><div class="stat-val" id="tD">0</div></div>
        <div class="card stat-card" style="border-color:#6366f1"><div style="color:#64748b; font-weight:bold">VOTOS INDIRECTOS</div><div class="stat-val" id="tI">0</div></div>
    </div>

    <div class="card">
        <div class="search-container">
            <input type="text" id="buscador" placeholder="üîç ESCRIBE AQU√ç PARA BUSCAR (NOMBRE, C√âDULA, PUESTO O COMUNA)...">
        </div>
        <div class="grid-3" style="grid-template-columns: 1fr 2fr;">
            <div>
                <h4>üìç DISTRIBUCI√ìN</h4>
                <canvas id="chartZonas" height="250"></canvas>
            </div>
            <div>
                <h4>‚≠ê RANKING DE LIDERAZGO DIRECTO</h4>
                <div class="scroll" style="max-height: 250px;">
                    <table>
                        <thead>
                            <tr><th onclick="sortL('nombre')">L√çDER ‚Üï</th><th onclick="sortL('cantidad')">VOTOS ‚Üï</th></tr>
                        </thead>
                        <tbody id="resumenLideres"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div class="card">
        <h4>üìã CONSOLIDADO MAESTRO DE VOTACI√ìN</h4>
        <div class="scroll">
            <table id="tablaPrincipal">
                <thead>
                    <tr>
                        <th onclick="sortM('Nombres y apellidos')">VOTANTE ‚Üï</th>
                        <th onclick="sortM('cedula')">C√âDULA ‚Üï</th>
                        <th onclick="sortM('puesto')">PUESTO OFICIAL ‚Üï</th>
                        <th onclick="sortM('comuna')">COMUNA/ZONA ‚Üï</th>
                        <th onclick="sortM('relacion')">TIPO ‚Üï</th>
                    </tr>
                </thead>
                <tbody id="tablaCuerpo"></tbody>
            </table>
        </div>
        <button class="btn" onclick="descargar()">üì• DESCARGAR BASE DE DATOS COMPLETA (EXCEL)</button>
    </div>
</div>

<script>
    const SB_URL = 'https://pmwlkdariynhaqbqursp.supabase.co';
    const SB_KEY = 'sb_publishable_zCu9cBa2qf9HqQuZ2YufzA_yTmwfiHv';
    const _supabase = supabase.createClient(SB_URL, SB_KEY);

    let dataRaw = [];
    let dataLideres = [];
    let chartObj;
    let sM = { c: null, a: true }, sL = { c: 'cantidad', a: false };

    // MATRIZ MEJORADA 2026
    const MAPA_PUESTOS = {
        "1": ["ACEVEDO", "GOMEZ", "MUTIS", "CELESTINO", "GARCES", "DELFINA", "TERRON", "VISTA HERMOSA", "AGUACATAL", "ESTRELLA", "SANTUARIO"],
        "2": ["NAVIA VARON", "FRANCIA", "LA MERCED", "VIPASA", "LA FLORA", "ALAMOS", "GONZAGA", "GRANADA", "VERSALLES", "JUANAMBU", "CHIPICHAPE", "MENA", "ATENAS", "CENTENARIO", "NORMANDIA", "BENALCAZAR", "SAGRADA", "LANS", "SENA SALOMIA", "ESTACION", "PRADOS DEL NORTE", "V. DEL LILI 2"],
        "3": ["LIBRADA", "ANTONIO", "PASCUAL", "NICOLAS", "ELOY", "PILOTO", "FRAY DAMIAN", "PE√ëON", "MERCED", "ROSA", "CORAJE", "JUSTICIA"],
        "4": ["ISAACS", "SANTANDER", "OLAYA", "PORVENIR", "POPULAR", "VALENCIA", "METROPOLITANO", "FLORENCIA", "BERLIN", "MANUELA B 2"],
        "5": ["INEM", "CAYZEDO", "VIVAS BALCAZAR", "ZAMORANO", "RIVERA", "VERACRUZ", "CONFENALCO", "CHIMINANGOS 1", "SALOMIA", "BARRANQUILLA"],
        "6": ["FLORALIA", "CALIMA", "GUAYACANES", "CHIMINANGOS", "ALCAZARES", "PETECUY", "COMFANDI CALIMA", "PUEBLO NUEVO", "GAITAN"],
        "7": ["LOPEZ", "PUMAREJO", "10 DE MAYO", "MALLARINO", "FUENMAYOR", "VILLAMAGRE", "BELISARIO", "7 DE AGOSTO", "GALAN"],
        "8": ["RAMOS", "CAMACHO", "AMERICAS", "INDUSTRIAL", "MUNICIPAL", "PRIMAVERAS", "MONICA", "URIBE", "HERRERA", "LOPEZ DE MESA", "ACACIAS"],
        "9": ["CALDAS", "FRANCISCO J", "AMPUDIA", "TAFUR", "ARANJUEZ", "GUAYAQUIL", "BRETA√ëA", "JUNIN", "ALAMEDA", "CHAMPAGNAT", "CA√ëIZARES", "CENTRO"],
        "10": ["DEPARTAMENTAL", "GUABAL", "CRISTOBAL", "LLOREDA", "PASOANCHO", "COLSEGUROS", "SELVA", "PANAMERICANO", "HELENA", "DOMINGO"],
        "11": ["ISRAEL", "CIUDAD DE CALI", "SAN CARLOS", "ESPERANZA", "INDEPENDENCIA", "CASCADA", "PRADOS ORIENTE", "LA LUISA", "MOLINA"],
        "12": ["VILLA DEL SUR", "SANTA FE", "SINDICAL", "VILLANUEVA", "RODEO", "FLORESTA", "ASTURIAS", "FENALCO", "EDUARDO SANTOS", "PROVIVIENDA", "12 OCTUBRE"],
        "13": ["DIAMANTE", "NIETO", "TRIANA", "POBLADO", "CHARCO AZUL", "PONDAJE", "CALIPSO", "AMAZONAS", "VILLA DEL LAGO", "LLOREDA"],
        "14": ["CALIXTO", "ALVAREZ", "TALANGA", "ALIRIO MORA", "PUERTA SOL", "ORQUIDEAS", "MANUELA BELTRAN", "PROSPERO", "MARROQUIN", "RETIRO"],
        "15": ["LLANO VERDE", "ISAURA", "RODRIGUEZ", "MOJICA", "VALLADO", "LAUREANO", "MORICHAL", "CORDOBA", "CDI", "DIAMANTE 2"],
        "16": ["ROJAS", "NAVIA", "COLON", "UNION VIVIENDA", "GRAN COLOMBIA", "VILLA HERMOSA", "CARCEL"],
        "17": ["UNIVALLE", "LATIR", "INGENIO", "CANEY", "LIMONAR", "CAPRI", "MAYOTTE", "LACORDAIRE", "VALLE DEL LILI", "CIUDADELA", "HACIENDA", "BOCHALEMA"],
        "18": ["POLITECNICO", "CARVAJAL", "MELENDEZ", "JORDAN", "ALTOS", "4 BRIGADA", "ANITA", "CHORROS", "MAMPUESTO"],
        "19": ["CIEGOS", "SORDOS", "COLISEO", "PASCUAL", "ESTADIO", "EUSTAQUIO", "LIDO", "TEQUENDAMA", "SANTIAGO", "4 LEGUA", "CA√ëAVERALEJO", "FERNANDO"],
        "20": ["MULTIPROPOSITO", "SILOE", "LLERAS", "BRISAS", "SULTANA"],
        "21": ["DESEPAZ", "CALIMIO", "SANTA ISABEL", "HUNGRIA", "COMPARTIR", "VALLE GRANDE", "POTRERO", "REMIGIO"],
        "22": ["ICESI", "JAVERIANA", "PANCE", "JARDIN", "BUENAVENTURA", "ALEMAN", "LUMEN", "BERCHMANS", "BENNETT", "CANDELARIA", "CA√ëASGORDAS"],
        "RURAL": ["MONTEBELLO", "FELIDIA", "SALADITO", "KM 18", "ELVIRA", "LEONERA", "PICHINDE", "ANDES", "VILLACARMELO", "BUITRERA", "NAVARRO", "HORMIGUERO", "CASCAJAL", "GOLONDRINAS", "PAZ", "CASEY", "KM 30", "VORAGINE"]
    };

    function norm(t) { return t ? t.toString().normalize("NFD").replace(/[\u0300-\u036f]/g, "").toUpperCase().trim() : ""; }

    function getUbi(p) {
        const t = norm(p); if(!t) return "POR ASIGNAR";
        for(let [c, ks] of Object.entries(MAPA_PUESTOS)) {
            if(ks.some(k => t.includes(k))) return c === "RURAL" ? "RURAL" : "COMUNA " + c;
        }
        return "OTRA / REVISAR";
    }

    async function auth() {
        const { value: p } = await Swal.fire({ title: 'SISTEMA ANGIE 2026', input: 'password', confirmButtonColor: '#0f172a' });
        if(p === 'ADMIN2026') { document.getElementById('app').style.display = 'block'; await load(); }
    }

    async function load() {
        const { data } = await _supabase.from('VOTANTES').select('*');
        dataRaw = data.map(v => ({
            ...v,
            comuna: getUbi(v.puesto),
            relacion: v.lider === "Rosse Mary Cabal Franco" ? "DIRECTO" : "INDIRECTO"
        }));
        
        const r = dataRaw.filter(v => v.lider === "Rosse Mary Cabal Franco");
        dataLideres = r.map(l => ({
            nombre: l["Nombres y apellidos"],
            cantidad: dataRaw.filter(v => v.lider === l["Nombres y apellidos"]).length
        }));
        update();
    }

    function update() {
        document.getElementById('tC').innerText = dataRaw.length;
        document.getElementById('tD').innerText = dataRaw.filter(v => v.relacion === "DIRECTO").length;
        document.getElementById('tI').innerText = dataRaw.filter(v => v.relacion === "INDIRECTO").length;
        renderL(); renderM(); renderC();
    }

    // FUNCI√ìN DE B√öSQUEDA CORREGIDA
    function filtrar() {
        const input = document.getElementById('buscador');
        const filtro = norm(input.value);
        const tabla = document.getElementById('tablaCuerpo');
        const filas = tabla.getElementsByTagName('tr');

        for (let i = 0; i < filas.length; i++) {
            const textoFila = norm(filas[i].textContent || filas[i].innerText);
            filas[i].style.display = textoFila.indexOf(filtro) > -1 ? "" : "none";
        }
    }

    function sortM(col) {
        sM.a = sM.c === col ? !sM.a : true; sM.c = col;
        dataRaw.sort((a,b) => {
            let v1 = a[col]||"", v2 = b[col]||"";
            return sM.a ? v1.toString().localeCompare(v2) : v2.toString().localeCompare(v1);
        });
        renderM();
    }

    function sortL(col) {
        sL.a = sL.c === col ? !sL.a : true; sL.c = col;
        dataLideres.sort((a,b) => {
            if(col === 'cantidad') return sL.a ? a.cantidad - b.cantidad : b.cantidad - a.cantidad;
            return sL.a ? a.nombre.localeCompare(b.nombre) : b.nombre.localeCompare(a.nombre);
        });
        renderL();
    }

    function renderL() {
        document.getElementById('resumenLideres').innerHTML = dataLideres.map(l => `<tr><td><b>${l.nombre}</b></td><td><span class="badge directo">${l.cantidad}</span></td></tr>`).join('');
    }

    function renderM() {
        document.getElementById('tablaCuerpo').innerHTML = dataRaw.map(v => `<tr><td><b>${v["Nombres y apellidos"]}</b></td><td>${v.cedula}</td><td>${v.puesto||'S.D'}</td><td><span class="badge ${v.comuna==='RURAL'?'rural':'urbano'}">${v.comuna}</span></td><td><span class="badge ${v.relacion==='DIRECTO'?'directo':''}">${v.relacion}</span></td></tr>`).join('');
        // Aplicar filtro despu√©s de renderizar si hay algo escrito
        if(document.getElementById('buscador').value) filtrar();
    }

    function renderC() {
        const ctx = document.getElementById('chartZonas');
        const cont = {}; dataRaw.forEach(v => cont[v.comuna] = (cont[v.comuna]||0)+1);
        if(chartObj) chartObj.destroy();
        chartObj = new Chart(ctx, { type: 'pie', data: { labels: Object.keys(cont), datasets: [{ data: Object.values(cont), backgroundColor: ['#0f172a','#10b981','#6366f1','#f59e0b','#ec4899','#ef4444','#8b5cf6','#06b6d4','#94a3b8'] }] }, options: { maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { boxWidth: 12, font: { size: 10 } } } } }});
    }

    function descargar() {
        const ws = XLSX.utils.json_to_sheet(dataRaw);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "CENSO_2026");
        XLSX.writeFile(wb, "DATOS_ESTRUCTURA_CALI.xlsx");
    }

    auth();
</script>
</body>
</html>
