<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reportes Censo Electoral</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <style>
        body { font-family: 'Segoe UI', Arial, sans-serif; background-color: #f0f2f5; padding: 20px; }
        .container { max-width: 1100px; margin: auto; background: white; padding: 30px; border-radius: 15px; box-shadow: 0 5px 20px rgba(0,0,0,0.1); }
        h1 { text-align: center; color: #1a3a5a; margin-bottom: 5px; }
        .meta-texto { text-align: center; color: #666; font-size: 1.2rem; margin-bottom: 25px; }
        
        /* Contenedor de Botones */
        .seccion-acciones { display: flex; gap: 15px; justify-content: center; margin-bottom: 30px; }
        
        button { 
            padding: 12px 25px; 
            border: none; 
            border-radius: 8px; 
            cursor: pointer; 
            font-weight: 600; 
            display: flex; 
            align-items: center; 
            gap: 8px;
            transition: transform 0.2s;
        }
        button:active { transform: scale(0.95); }

        .btn-excel { background-color: #1D6F42; color: white; } /* Verde Excel */
        .btn-pdf { background-color: #E74C3C; color: white; }   /* Rojo PDF */
        
        /* Dashboard */
        .grid-reportes { display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 25px; }
        .tarjeta-grafica { border: 1px solid #e1e4e8; padding: 20px; border-radius: 12px; background: #fff; }
        h3 { margin-top: 0; color: #2c3e50; border-bottom: 2px solid #f0f2f5; padding-bottom: 10px; }

        @media (max-width: 600px) {
            .grid-reportes { grid-template-columns: 1fr; }
            .seccion-acciones { flex-direction: column; }
        }
    </style>
</head>
<body>

<div class="container" id="contenido-a-exportar">
    <h1>Panel de Control de Votaci칩n</h1>
    <div class="meta-texto" id="contador-texto">Cargando registros de la base de datos...</div>

    <div class="seccion-acciones" data-html2canvas-ignore="true">
        <button onclick="descargarExcel()" class="btn-excel">
            <span>游늵</span> Descargar Base Completa (Excel)
        </button>
        <button onclick="descargarPDF()" class="btn-pdf">
            <span>游늯</span> Descargar Reporte Gr치fico (PDF)
        </button>
    </div>

    <div class="grid-reportes">
        <div class="tarjeta-grafica">
            <h3>Distribuci칩n por L칤der</h3>
            <canvas id="graficaLideres"></canvas>
        </div>
        <div class="tarjeta-grafica">
            <h3>Cumplimiento de Meta (5,000 Votos)</h3>
            <canvas id="graficaMeta"></canvas>
        </div>
    </div>
</div>

<script>
    // --- CONFIGURACI칍N DE CONEXI칍N ---
    const URL_PROYECTO = "https://pmwlkdariynhaqbqursp.supabase.co";
    const KEY_ANON = "TU_KEY_ANON_REAL_AQUI"; // REEMPLAZA ESTO
    const _supabase = supabase.createClient(URL_PROYECTO, KEY_ANON);

    let datosVotantes = [];

    // --- CARGA DE DATOS ---
    async function cargarDatos() {
        try {
            // Reemplaza 'censo_electoral' si tu tabla se llama distinto
            const { data, error } = await _supabase
                .from('censo_electoral') 
                .select('*');

            if (error) throw error;

            datosVotantes = data;
            actualizarInterfaz(data);
        } catch (err) {
            console.error("Error cargando datos:", err);
            document.getElementById('contador-texto').innerText = "Error al conectar con la base de datos.";
        }
    }

    function actualizarInterfaz(data) {
        const total = data.length;
        document.getElementById('contador-texto').innerText = `Total Registrados: ${total.toLocaleString()} de 5,000`;

        // Procesar datos para gr치fica de L칤deres
        const conteo = {};
        data.forEach(v => {
            const nombreLider = v.lider || 'Sin L칤der';
            conteo[nombreLider] = (conteo[nombreLider] || 0) + 1;
        });

        renderizarGraficas(conteo, total);
    }

    function renderizarGraficas(conteoLideres, total) {
        // Gr치fica de Barras (L칤deres)
        new Chart(document.getElementById('graficaLideres'), {
            type: 'bar',
            data: {
                labels: Object.keys(conteoLideres),
                datasets: [{
                    label: 'Registros',
                    data: Object.values(conteoLideres),
                    backgroundColor: '#3498db',
                    borderRadius: 5
                }]
            },
            options: { responsive: true }
        });

        // Gr치fica de Dona (Meta)
        new Chart(document.getElementById('graficaMeta'), {
            type: 'doughnut',
            data: {
                labels: ['Logrado', 'Pendiente'],
                datasets: [{
                    data: [total, Math.max(0, 5000 - total)],
                    backgroundColor: ['#27ae60', '#ecf0f1']
                }]
            },
            options: { cutout: '70%' }
        });
    }

    // --- FUNCIONES DE DESCARGA ---

    function descargarExcel() {
        if(datosVotantes.length === 0) return alert("No hay datos para descargar");
        
        const worksheet = XLSX.utils.json_to_sheet(datosVotantes);
        const workbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(workbook, worksheet, "Censo_Completo");
        XLSX.writeFile(workbook, "Base_Datos_Censo.xlsx");
    }

    function descargarPDF() {
        const elemento = document.getElementById('contenido-a-exportar');
        const config = {
            margin: 1,
            filename: 'Reporte_Votacion_General.pdf',
            image: { type: 'jpeg', quality: 0.98 },
            html2canvas: { scale: 2 },
            jsPDF: { unit: 'cm', format: 'letter', orientation: 'portrait' }
        };
        html2pdf().set(config).from(elemento).save();
    }

    // Iniciar al cargar la p치gina
    window.onload = cargarDatos;
</script>

</body>
</html>
