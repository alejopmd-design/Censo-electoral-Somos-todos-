<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Reportes - Censo Electoral</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f4f7f6; margin: 0; padding: 20px; }
        .container { max-width: 1000px; margin: auto; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        h1 { text-align: center; color: #2c3e50; }
        
        /* Estilos de los Botones de Acci칩n */
        .botones-exportar { display: flex; gap: 10px; justify-content: center; margin-bottom: 20px; flex-wrap: wrap; }
        button { padding: 12px 20px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; color: white; transition: 0.3s; }
        .btn-excel { background-color: #27ae60; }
        .btn-excel:hover { background-color: #1e8449; }
        .btn-pdf { background-color: #c0392b; }
        .btn-pdf:hover { background-color: #922b21; }
        
        .dashboard-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px; }
        @media (max-width: 768px) { .dashboard-grid { grid-template-columns: 1fr; } }
        
        .chart-container { border: 1px solid #eee; padding: 15px; border-radius: 8px; }
        .resumen-numerico { text-align: center; font-size: 24px; margin: 20px 0; color: #34495e; }
    </style>
</head>
<body>

<div class="container" id="reporte-total">
    <h1>Panel de Control Electoral</h1>
    
    <div class="resumen-numerico" id="total-registros">
        Cargando datos...
    </div>

    <div class="botones-exportar" data-html2canvas-ignore="true">
        <button onclick="descargarExcel()" class="btn-excel">游닌 Descargar Base Excel</button>
        <button onclick="descargarPDF()" class="btn-pdf">游늯 Descargar Reporte PDF</button>
    </div>

    <div class="dashboard-grid">
        <div class="chart-container">
            <h3>Registros por L칤der</h3>
            <canvas id="graficaLideres"></canvas>
        </div>
        <div class="chart-container">
            <h3>Progreso hacia la Meta (5,000)</h3>
            <canvas id="graficaMeta"></canvas>
        </div>
    </div>
</div>

<script>
    // 1. CONFIGURACI칍N SUPABASE
    const SUPABASE_URL = "https://pmwlkdariynhaqbqursp.supabase.co";
    const SUPABASE_KEY = "TU_KEY_ANON_AQUI"; // REEMPLAZA CON TU KEY REAL
    const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    let datosGlobales = [];

    // 2. CARGAR DATOS Y CREAR GR츼FICAS
    async function inicializarReportes() {
        const { data, error } = await _supabase.from('censo_electoral').select('*');
        
        if (error) {
            console.error("Error:", error);
            return;
        }

        datosGlobales = data;
        document.getElementById('total-registros').innerText = `Total Registrados: ${data.length} / 5,000`;

        actualizarGraficas(data);
    }

    function actualizarGraficas(data) {
        // Conteo por l칤der
        const conteoLideres = {};
        data.forEach(item => {
            conteoLideres[item.lider] = (conteoLideres[item.lider] || 0) + 1;
        });

        // Gr치fica L칤deres
        new Chart(document.getElementById('graficaLideres'), {
            type: 'bar',
            data: {
                labels: Object.keys(conteoLideres),
                datasets: [{
                    label: 'Votantes',
                    data: Object.values(conteoLideres),
                    backgroundColor: '#3498db'
                }]
            }
        });

        // Gr치fica de Meta
        new Chart(document.getElementById('graficaMeta'), {
            type: 'doughnut',
            data: {
                labels: ['Registrados', 'Faltantes'],
                datasets: [{
                    data: [data.length, 5000 - data.length],
                    backgroundColor: ['#2ecc71', '#ecf0f1']
                }]
            }
        });
    }

    // 3. FUNCIONES DE EXPORTACI칍N
    async function descargarExcel() {
        if (datosGlobales.length === 0) return alert("No hay datos para exportar");
        
        const hoja = XLSX.utils.json_to_sheet(datosGlobales);
        const libro = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(libro, hoja, "Base Completa");
        XLSX.writeFile(libro, "Censo_Electoral_Completo.xlsx");
    }

    function descargarPDF() {
        const elemento = document.getElementById('reporte-total');
        const opciones = {
            margin: 1,
            filename: 'Reporte_General_Electoral.pdf',
            image: { type: 'jpeg', quality: 0.98 },
            html2canvas: { scale: 2 },
            jsPDF: { unit: 'cm', format: 'letter', orientation: 'portrait' }
        };
        html2pdf().set(opciones).from(elemento).save();
    }

    window.onload = inicializarReportes;
</script>

</body>
</html>
