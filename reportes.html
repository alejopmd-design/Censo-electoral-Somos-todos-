<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SISTEMA DE GESTIÓN TERRITORIAL 2026 | UNIDAD DE MANDO</title>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800;900&family=JetBrains+Mono:wght@500;800&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        /* =============================================================================================
           ESTILOS MAESTROS (ARQUITECTURA VISUAL EXPANDIDA)
           ============================================================================================= */
        :root {
            --primary: #2563eb;
            --primary-glow: rgba(37, 99, 235, 0.4);
            --dark-bg: #0f172a;
            --dark-card: #1e293b;
            --light-bg: #f8fafc;
            --text-main: #1e293b;
            --text-muted: #64748b;
            --danger: #e11d48;
            --success: #10b981;
            --warning: #f59e0b;
            --border-color: #e2e8f0;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; outline: none; }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--light-bg);
            color: var(--text-main);
            font-size: 13px;
            text-transform: uppercase;
            line-height: 1.4;
            overflow-x: hidden;
        }

        /* SISTEMA DE PRE-CARGA ESTRATÉGICO */
        #boot-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--dark-bg); display: flex; flex-direction: column;
            justify-content: center; align-items: center; z-index: 10000;
        }

        .loader-ring {
            width: 110px; height: 110px; border: 10px solid rgba(255,255,255,0.05);
            border-top: 10px solid var(--primary); border-radius: 50%;
            animation: spin-logic 1s linear infinite; filter: drop-shadow(0 0 15px var(--primary-glow));
        }

        @keyframes spin-logic { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* CABECERA DE MANDO CONTROLADO */
        .main-header {
            background: linear-gradient(135deg, var(--dark-bg) 0%, #1e293b 100%);
            padding: 30px 50px; display: flex; justify-content: space-between; align-items: center;
            border-bottom: 10px solid var(--primary); box-shadow: 0 15px 35px rgba(0,0,0,0.2);
            position: sticky; top: 0; z-index: 999;
        }

        .header-info h1 {
            color: white; font-size: 2.8rem; font-weight: 900; letter-spacing: 12px; line-height: 1;
        }

        .header-info p {
            color: var(--primary); font-weight: 800; font-size: 0.9rem; letter-spacing: 5px; margin-top: 8px;
        }

        .clock-display {
            font-family: 'JetBrains Mono', monospace; font-size: 1.7rem; color: white;
            background: rgba(255,255,255,0.08); padding: 12px 25px; border-radius: 12px;
            border: 1px solid rgba(255,255,255,0.1); letter-spacing: 2px;
        }

        /* CONTENEDOR DE APLICACIÓN */
        .app-shell { display: none; padding: 30px; max-width: 1950px; margin: 0 auto; flex-direction: column; }

        /* INDICADORES KPI EXPANDIDOS */
        .kpi-container { display: grid; grid-template-columns: repeat(4, 1fr); gap: 25px; margin-bottom: 30px; }
        
        .kpi-item {
            background: white; padding: 35px; border-radius: 20px; border: 1px solid var(--border-color);
            border-top: 8px solid var(--primary); box-shadow: 0 10px 15px -3px rgba(0,0,0,0.05);
            transition: all 0.3s ease;
        }

        .kpi-item:hover { transform: translateY(-8px); box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); }
        .kpi-item.alert { border-top-color: var(--danger); }
        .kpi-item.success { border-top-color: var(--success); }

        .kpi-label { color: var(--text-muted); font-size: 0.85rem; font-weight: 800; display: block; margin-bottom: 12px; }
        .kpi-value { font-size: 4rem; font-weight: 900; color: var(--dark-bg); line-height: 0.8; }

        /* GRID ESTRATÉGICO DE DATOS */
        .data-grid { display: grid; grid-template-columns: 1.3fr 0.7fr; gap: 30px; align-items: start; }

        .module-card {
            background: white; border-radius: 25px; padding: 30px; margin-bottom: 30px;
            border: 1px solid var(--border-color); box-shadow: 0 15px 35px rgba(0,0,0,0.05);
        }

        .module-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 25px; padding-bottom: 20px; border-bottom: 4px solid var(--light-bg);
        }

        .module-title { font-size: 1.4rem; font-weight: 900; display: flex; align-items: center; gap: 15px; }

        /* CARTOGRAFÍA */
        #map-engine { height: 600px; width: 100%; border-radius: 20px; border: 8px solid var(--light-bg); z-index: 10; }

        /* TABLAS DE ALTA COMPLEJIDAD */
        .table-viewport { width: 100%; overflow-x: auto; border-radius: 15px; }
        table { width: 100%; border-collapse: collapse; background: white; }
        
        th {
            background: #f1f5f9; padding: 22px; text-align: left; font-weight: 900;
            color: var(--text-muted); border-bottom: 5px solid var(--border-color);
            cursor: pointer; position: relative; transition: all 0.3s;
        }

        th:hover { background: var(--primary); color: white; }
        th.active-sort::after { content: "\f0dc"; font-family: "Font Awesome 6 Free"; position: absolute; right: 10px; opacity: 0.5; }

        td { padding: 18px 22px; border-bottom: 1px solid #f1f5f9; font-weight: 700; font-size: 14px; }

        /* JERARQUÍA VISUAL */
        .row-master { background: #f8fafc; cursor: pointer; border-left: 12px solid var(--dark-bg); }
        .row-sub { display: none; background: white; cursor: pointer; border-left: 40px solid var(--primary); }
        .row-detail { display: none; background: #fafafa; border-left: 70px solid #cbd5e1; font-size: 0.9em; color: var(--text-muted); }

        /* SISTEMA DE ALERTAS (REGLA 24/01) */
        .alert-stack { display: flex; flex-direction: column; gap: 15px; }
        .alert-box {
            padding: 22px; border-radius: 18px; display: flex; justify-content: space-between;
            align-items: center; font-weight: 900; border-left: 20px solid;
            animation: alert-pulse 2s infinite;
        }

        .critical { background: #fff1f2; color: #9f1239; border-color: var(--danger); }
        .warning { background: #fffbeb; color: #92400e; border-color: var(--warning); }

        @keyframes alert-pulse { 0% { opacity: 1; } 50% { opacity: 0.8; } 100% { opacity: 1; } }

        /* BUSCADOR DE AUDITORÍA */
        .search-engine {
            width: 100%; padding: 22px 30px; border-radius: 20px; border: 4px solid var(--border-color);
            font-size: 1.2rem; font-weight: 800; margin-bottom: 25px; transition: all 0.3s ease;
        }

        .search-engine:focus { border-color: var(--primary); background: white; box-shadow: 0 0 20px rgba(37, 99, 235, 0.1); }

        /* BOTONES DE ACCIÓN */
        .btn-group { display: flex; gap: 15px; }
        .btn-action {
            padding: 15px 28px; border-radius: 15px; border: none; cursor: pointer;
            font-weight: 900; display: flex; align-items: center; gap: 12px;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .btn-success { background: var(--success); color: white; }
        .btn-dark { background: var(--dark-bg); color: white; }
        .btn-action:hover { transform: translateY(-4px) scale(1.03); filter: brightness(1.1); box-shadow: 0 12px 20px rgba(0,0,0,0.1); }

    </style>
</head>
<body>

    <div id="boot-screen">
        <div class="loader-ring"></div>
        <h2 style="color: white; letter-spacing: 15px; font-weight: 900; margin-top: 35px;">GESTIÓN 2026</h2>
        <p style="color: var(--primary); font-weight: 800; margin-top: 12px; letter-spacing: 5px;">CARGANDO LÓGICA TERRITORIAL...</p>
    </div>

    <div id="app-root" class="app-shell">
        <header class="main-header">
            <div class="header-info">
                <h1>GESTIÓN 2026</h1>
                <p>CENTRO DE CONTROL ESTRATÉGICO Y AUDITORÍA</p>
            </div>
            <div class="clock-display" id="digital-clock">00:00:00</div>
        </header>

        <div class="kpi-container">
            <div class="kpi-item">
                <span class="kpi-label"><i class="fas fa-id-card"></i> CENSO VÁLIDO (REGLA 16/01)</span>
                <span id="kpi-total-v" class="kpi-value">0</span>
            </div>
            <div class="kpi-item alert">
                <span class="kpi-label"><i class="fas fa-exclamation-circle"></i> ALERTAS DE INTERVENCIÓN</span>
                <span id="kpi-alerts" class="kpi-value" style="color: var(--danger);">0</span>
            </div>
            <div class="kpi-item success">
                <span class="kpi-label"><i class="fas fa-user-shield"></i> LÍDERES TERRITORIALES</span>
                <span id="kpi-lideres" class="kpi-value" style="color: var(--success);">0</span>
            </div>
            <div class="kpi-item">
                <span class="kpi-label"><i class="fas fa-chart-line"></i> BALANCE DE GÉNERO</span>
                <div style="height: 65px; margin-top: 10px;"><canvas id="chart-mini-g"></canvas></div>
            </div>
        </div>

        <div class="data-grid">
            <div class="col-main">
                <div class="module-card">
                    <div class="module-header">
                        <span class="module-title"><i class="fas fa-map-marked-alt"></i> DESPLIEGUE GEOGRÁFICO CALI</span>
                    </div>
                    <div id="map-engine"></div>
                </div>

                <div class="module-card">
                    <div class="module-header">
                        <span class="module-title"><i class="fas fa-layer-group"></i> ESTRUCTURA JERÁRQUICA</span>
                        <div class="btn-group">
                            <button class="btn-action btn-success" onclick="exportHierarchicalExcel()">
                                <i class="fas fa-file-excel"></i> DESCARGAR ESTRUCTURA
                            </button>
                        </div>
                    </div>
                    <div class="table-viewport">
                        <table id="hierarchy-table">
                            <thead>
                                <tr>
                                    <th onclick="sortEngine('hierarchy-table', 0)">LOCALIZACIÓN TERRITORIAL</th>
                                    <th onclick="sortEngine('hierarchy-table', 1)" style="text-align:center;">REGISTROS</th>
                                    <th onclick="sortEngine('hierarchy-table', 2)" style="text-align:center;">PESO %</th>
                                </tr>
                            </thead>
                            <tbody id="hierarchy-body">
                                </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="col-side">
                <div class="module-card">
                    <div class="module-header">
                        <span class="module-title"><i class="fas fa-chart-pie"></i> DISTRIBUCIÓN COMUNAS</span>
                    </div>
                    <div style="height: 400px;"><canvas id="chart-main-dona"></canvas></div>
                    <div id="dona-legend" style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 25px;"></div>
                </div>

                <div class="module-card" style="border-top: 10px solid var(--danger);">
                    <div class="module-header" style="color: var(--danger);">
                        <span class="module-title"><i class="fas fa-bullhorn"></i> ALERTAS DE ACCIÓN (REGLA 24/01)</span>
                    </div>
                    <div id="alert-stack-container" class="alert-stack">
                        </div>
                </div>

                <div class="module-card">
                    <div class="module-header">
                        <span class="module-title"><i class="fas fa-database"></i> AUDITORÍA MAESTRA</span>
                        <button class="btn-action btn-dark" onclick="exportMasterTable()">
                            <i class="fas fa-file-download"></i>
                        </button>
                    </div>
                    <input type="text" id="global-search" class="search-engine" placeholder="FILTRAR POR NOMBRE, CÉDULA O LÍDER..." onkeyup="executeGlobalFilter()">
                    <div class="table-viewport" style="max-height: 500px;">
                        <table id="master-audit-table">
                            <thead>
                                <tr>
                                    <th onclick="sortEngine('master-audit-table', 0)">IDENTIDAD</th>
                                    <th onclick="sortEngine('master-audit-table', 1)">IDENTIFICACIÓN</th>
                                    <th onclick="sortEngine('master-audit-table', 2)">LÍDER</th>
                                </tr>
                            </thead>
                            <tbody id="master-audit-body">
                                </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        /**
         * CONFIGURACIÓN DE NÚCLEO
         */
        const SB_URL = 'https://pmwlkdariynhaqbqursp.supabase.co';
        const SB_KEY = 'sb_publishable_zCu9cBa2qf9HqQuZ2YufzA_yTmwfiHv';
        const _sb = supabase.createClient(SB_URL, SB_KEY);

        let GLOBAL_VOTANTES = [];
        let GLOBAL_PUESTOS = [];
        let MAP_INSTANCE;
        let MARKER_GROUP;
        let DONA_CHART;
        let MINI_CHART;

        const PALETA_COLORES = ['#2563eb', '#10b981', '#f59e0b', '#d946ef', '#06b6d4', '#f43f5e', '#8b5cf6', '#14b8a6', '#f97316', '#475569', '#ec4899', '#6366f1'];

        const COORDENADAS_CALI = {
            "1": [3.450, -76.550], "2": [3.475, -76.525], "3": [3.452, -76.533], "4": [3.468, -76.508], "5": [3.478, -76.492],
            "6": [3.485, -76.485], "7": [3.458, -76.488], "8": [3.445, -76.500], "9": [3.440, -76.515], "10": [3.428, -76.520],
            "11": [3.415, -76.510], "12": [3.428, -76.495], "13": [3.410, -76.485], "14": [3.415, -76.470], "15": [3.400, -76.475],
            "16": [3.410, -76.500], "17": [3.385, -76.520], "18": [3.375, -76.545], "19": [3.425, -76.545], "20": [3.415, -76.555],
            "21": [3.425, -76.465], "22": [3.355, -76.535], "24": [3.350, -76.510], "25": [3.370, -76.570], "33": [3.480, -76.570]
        };

        /**
         * SECUENCIA DE ARRANQUE (BOOT SEQUENCE)
         */
        window.onload = async () => {
            const { value: pass } = await Swal.fire({
                title: 'SEGURIDAD GESTIÓN 2026',
                input: 'password',
                inputPlaceholder: 'INGRESE LLAVE MAESTRA',
                confirmButtonColor: '#0f172a',
                allowOutsideClick: false,
                background: '#ffffff'
            });

            if (pass === 'ADMIN2026') {
                const loader = document.getElementById('boot-screen');
                loader.style.opacity = '0';
                setTimeout(() => {
                    loader.style.display = 'none';
                    document.getElementById('app-root').style.display = 'flex';
                    initializeCore();
                }, 800);
            } else {
                location.reload();
            }
        };

        function initializeCore() {
            // Inicializar Mapa
            MAP_INSTANCE = L.map('map-engine').setView([3.42, -76.52], 12);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png').addTo(MAP_INSTANCE);
            MARKER_GROUP = L.layerGroup().addTo(MAP_INSTANCE);

            // Reloj en tiempo real
            setInterval(() => {
                document.getElementById('digital-clock').innerText = new Date().toLocaleTimeString();
            }, 1000);

            syncDatabase();
        }

        /**
         * SINCRONIZACIÓN Y REGLA 16/01
         */
        async function syncDatabase() {
            try {
                const [puestosRes, votantesRes] = await Promise.all([
                    _sb.from('PUESTOS_VOTACION').select('*'),
                    _sb.from('VOTANTES').select('*').order('created_at', { ascending: false })
                ]);

                GLOBAL_PUESTOS = puestosRes.data || [];
                
                // REGLA 16/01: Filtrado estricto por campos obligatorios
                GLOBAL_VOTANTES = (votantesRes.data || []).filter(v => {
                    return v.cedula && v["Nombres y apellidos"] && v.telefono;
                });

                processStrategicAnalytics();
            } catch (error) {
                Swal.fire('ERROR DE CONEXIÓN', 'No se pudo sincronizar con el núcleo de datos.', 'error');
            }
        }

        /**
         * ANALÍTICA TERRITORIAL EXPANDIDA
         */
        function processStrategicAnalytics() {
            const totalCenso = GLOBAL_VOTANTES.length || 1;
            document.getElementById('kpi-total-v').innerText = GLOBAL_VOTANTES.length;

            const analytics = {
                comunas: {},
                puestos: {},
                mesas: {},
                lideres: {},
                genero: { h: 0, m: 0 }
            };

            GLOBAL_VOTANTES.forEach(v => {
                // Cálculo de Género Fonético/Explícito
                const nombre = (v["Nombres y apellidos"] || "").toUpperCase();
                if(nombre.endsWith('A') || nombre.includes('MARIA') || nombre.includes('ANA') || nombre.includes('LUZ')) analytics.genero.m++; else analytics.genero.h++;

                // Conteo de Líderes
                const lider = (v.lider || "DIRECTO").toUpperCase();
                analytics.lideres[lider] = (analytics.lideres[lider] || 0) + 1;

                // Estructura Geográfica (Cruze con Tabla Puestos)
                const puestoInfo = GLOBAL_PUESTOS.find(p => p.nombre_puesto.toUpperCase() === (v.puesto||"").toUpperCase());
                if(puestoInfo) {
                    const com = puestoInfo.comuna;
                    analytics.comunas[com] = (analytics.comunas[com] || 0) + 1;

                    analytics.puestos[com] = analytics.puestos[com] || {};
                    analytics.puestos[com][v.puesto] = (analytics.puestos[com][v.puesto] || 0) + 1;

                    analytics.mesas[v.puesto] = analytics.mesas[v.puesto] || {};
                    const mesaId = v.mesa || "X";
                    analytics.mesas[v.puesto][mesaId] = (analytics.mesas[v.puesto][mesaId] || 0) + 1;
                }
            });

            document.getElementById('kpi-lideres').innerText = Object.keys(analytics.lideres).length;

            renderHierarchicalTable(analytics, totalCenso);
            renderAlertSystem(analytics);
            renderCharts(analytics, totalCenso);
            renderMapMarkers(analytics);
            renderMasterAudit();
        }

        /**
         * RENDERIZADO DE JERARQUÍA (EXPANDIBLE PASO A PASO)
         */
        function renderHierarchicalTable(data, total) {
            const body = document.getElementById('hierarchy-body');
            let html = "";
            const idsComunas = Object.keys(COORDENADAS_CALI).sort((a,b) => a-b);

            idsComunas.forEach(id => {
                const votos = data.comunas[id] || 0;
                const perc = ((votos/total)*100).toFixed(1);

                html += `
                    <tr class="row-master" onclick="toggleHierarchy('c-${id}')">
                        <td><i class="fas fa-folder-open" style="margin-right:12px;"></i> COMUNA ${id}</td>
                        <td align="center">${votos}</td>
                        <td align="center">${perc}%</td>
                    </tr>
                `;

                if(data.puestos[id]) {
                    Object.entries(data.puestos[id]).forEach(([nomP, vP]) => {
                        const pid = `p-${nomP.replace(/\s+/g, '')}`;
                        html += `
                            <tr class="row-sub c-${id}" data-parent="${pid}" onclick="toggleHierarchy('${pid}')">
                                <td><i class="fas fa-map-pin" style="margin-right:12px;"></i> ${nomP}</td>
                                <td align="center">${vP}</td>
                                <td align="center">${((vP/total)*100).toFixed(1)}%</td>
                            </tr>
                        `;

                        if(data.mesas[nomP]) {
                            Object.entries(data.mesas[nomP]).forEach(([mId, vM]) => {
                                html += `
                                    <tr class="row-detail c-${id} ${pid}">
                                        <td>MESA DE VOTACIÓN N° ${mId}</td>
                                        <td align="center">${vM}</td>
                                        <td align="center">${((vM/total)*100).toFixed(2)}%</td>
                                    </tr>
                                `;
                            });
                        }
                    });
                }
            });
            body.innerHTML = html;
        }

        function toggleHierarchy(cls) {
            const elements = document.getElementsByClassName(cls);
            if(!elements.length) return;
            const isVisible = elements[0].style.display === 'table-row';
            
            for(let el of elements) {
                el.style.display = isVisible ? 'none' : 'table-row';
                if(isVisible && el.dataset.parent) {
                    const subElements = document.getElementsByClassName(el.dataset.parent);
                    for(let sub of subElements) sub.style.display = 'none';
                }
            }
        }

        /**
         * MOTOR DE ALERTAS (REGLA 24/01)
         */
        function renderAlertSystem(data) {
            const container = document.getElementById('alert-stack-container');
            const metrics = Object.keys(COORDENADAS_CALI).map(id => ({ id, v: data.comunas[id] || 0 }));
            
            const ceros = metrics.filter(x => x.v === 0);
            const bajos = metrics.filter(x => x.v > 0).sort((a,b) => a.v - b.v).slice(0, 5);
            
            document.getElementById('kpi-alerts').innerText = ceros.length + bajos.length;

            let alertHtml = "";
            ceros.forEach(z => alertHtml += `<div class="alert-box critical"><span>COMUNA ${z.id}</span><span><i class="fas fa-biohazard"></i> 0 REGISTROS</span></div>`);
            bajos.forEach(b => alertHtml += `<div class="alert-box warning"><span>COMUNA ${b.id}</span><span><i class="fas fa-exclamation"></i> ${b.v} VOTOS</span></div>`);
            
            container.innerHTML = alertHtml || `<p style="text-align:center; padding:20px; opacity:0.4;">META TERRITORIAL CUMPLIDA</p>`;
        }

        /**
         * MOTOR DE ORDENAMIENTO (SORT ENGINE)
         */
        function sortEngine(tableId, colIndex) {
            const table = document.getElementById(tableId);
            const tbody = table.tBodies[0];
            const rows = Array.from(tbody.rows);
            const header = table.querySelectorAll('th')[colIndex];
            const isAsc = header.classList.contains('sort-asc');

            table.querySelectorAll('th').forEach(th => th.classList.remove('sort-asc', 'sort-desc', 'active-sort'));
            header.classList.add('active-sort');

            const sortedRows = rows.sort((a, b) => {
                let valA = a.cells[colIndex].innerText.trim();
                let valB = b.cells[colIndex].innerText.trim();
                
                const numA = parseFloat(valA.replace('%', ''));
                const numB = parseFloat(valB.replace('%', ''));

                if (!isNaN(numA) && !isNaN(numB)) return isAsc ? numB - numA : numA - numB;
                return isAsc ? valB.localeCompare(valA) : valA.localeCompare(valB);
            });

            header.classList.toggle('sort-asc', !isAsc);
            header.classList.toggle('sort-desc', isAsc);
            tbody.append(...sortedRows);
        }

        /**
         * EXPORTACIÓN JERÁRQUICA (ALGORITMO DE INDENTACIÓN)
         */
        function exportHierarchicalExcel() {
            const wb = XLSX.utils.book_new();
            const dataMatrix = [["ESTRUCTURA", "UBICACIÓN DETALLADA", "VOTOS", "PESO %"]];
            
            const rows = document.getElementById('hierarchy-body').rows;
            for(let r of rows) {
                let prefix = "";
                let type = "COMUNA";
                if(r.classList.contains('row-sub')) { prefix = "   ↳ "; type = "PUESTO"; }
                if(r.classList.contains('row-detail')) { prefix = "      • "; type = "MESA"; }

                dataMatrix.push([
                    type,
                    prefix + r.cells[0].innerText.trim(),
                    r.cells[1].innerText,
                    r.cells[2].innerText
                ]);
            }

            const ws = XLSX.utils.aoa_to_sheet(dataMatrix);
            XLSX.utils.book_append_sheet(wb, ws, "OPERACIONES_2026");
            XLSX.writeFile(wb, `REPORTE_JERARQUICO_CALI_${new Date().getTime()}.xlsx`);
        }

        /**
         * VISUALIZACIÓN GRÁFICA Y CARTOGRÁFICA
         */
        function renderCharts(data, total) {
            // Dona Principal
            const ctxD = document.getElementById('chart-main-dona').getContext('2d');
            const labs = Object.keys(data.comunas).sort((a,b) => a-b);
            const vals = labs.map(l => data.comunas[l]);

            if(DONA_CHART) DONA_CHART.destroy();
            DONA_CHART = new Chart(ctxD, {
                type: 'doughnut',
                data: {
                    labels: labs.map(x => `COMUNA ${x}`),
                    datasets: [{ data: vals, backgroundColor: PALETA_COLORES }]
                },
                options: { maintainAspectRatio: false, plugins: { legend: { display: false } }, cutout: '75%' }
            });

            document.getElementById('dona-legend').innerHTML = labs.map((l, i) => `
                <div style="font-size:11px; font-weight:900; border-left:5px solid ${PALETA_COLORES[i%PALETA_COLORES.length]}; padding-left:10px;">
                    C-${l}: ${((data.comunas[l]/total)*100).toFixed(1)}%
                </div>
            `).join('');

            // Gráfico Mini Género
            const ctxG = document.getElementById('chart-mini-g').getContext('2d');
            if(MINI_CHART) MINI_CHART.destroy();
            MINI_CHART = new Chart(ctxG, {
                type: 'bar',
                data: {
                    labels: ['H', 'M'],
                    datasets: [{ data: [data.genero.h, data.genero.m], backgroundColor: ['#2563eb', '#ec4899'] }]
                },
                options: { indexAxis: 'y', maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { display: false }, y: { display: false } } }
            });
        }

        function renderMapMarkers(data) {
            MARKER_GROUP.clearLayers();
            Object.keys(COORDENADAS_CALI).forEach(id => {
                const v = data.comunas[id] || 0;
                const r = 300 + (v * 12);
                L.circle(COORDENADAS_CALI[id], {
                    color: v === 0 ? '#e11d48' : '#2563eb',
                    fillColor: v === 0 ? '#f43f5e' : '#60a5fa',
                    fillOpacity: 0.6,
                    radius: r
                }).addTo(MARKER_GROUP).bindTooltip(`COMUNA ${id}: ${v} REGISTROS`);
            });
        }

        function renderMasterAudit() {
            const body = document.getElementById('master-audit-body');
            body.innerHTML = GLOBAL_VOTANTES.slice(0, 400).map(v => `
                <tr>
                    <td>${v["Nombres y apellidos"]}</td>
                    <td>${v.cedula}</td>
                    <td>${v.lider || 'CALI'}</td>
                </tr>
            `).join('');
        }

        function executeGlobalFilter() {
            const q = document.getElementById('global-search').value.toUpperCase();
            const rows = document.getElementById('master-audit-body').rows;
            for(let r of rows) r.style.display = r.innerText.toUpperCase().includes(q) ? '' : 'none';
        }

        function exportMasterTable() {
            const wb = XLSX.utils.table_to_book(document.getElementById('master-audit-table'));
            XLSX.writeFile(wb, "AUDITORIA_MAESTRA_2026.xlsx");
        }
    </script>
</body>
</html>
