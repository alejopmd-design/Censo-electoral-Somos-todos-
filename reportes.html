<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mapa de Calor Electoral Cali 2026</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        :root { --blue: #0f172a; --white: #ffffff; }
        body { font-family: 'Inter', sans-serif; background: #f1f5f9; margin: 0; padding: 20px; text-transform: uppercase; }
        .container { max-width: 1400px; margin: auto; display: none; }
        .card { background: var(--white); border-radius: 16px; padding: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); margin-bottom: 20px; }
        #map { height: 600px; border-radius: 12px; background: #e2e8f0; border: 2px solid var(--blue); }
        .legend { background: white; padding: 10px; line-height: 18px; color: #555; border-radius: 5px; box-shadow: 0 0 15px rgba(0,0,0,0.2); }
        .legend i { width: 18px; height: 18px; float: left; margin-right: 8px; opacity: 0.7; }
        .info-panel { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        .stat { background: var(--blue); color: white; padding: 20px; border-radius: 12px; text-align: center; }
        .stat h2 { margin: 0; font-size: 2.5rem; }
    </style>
</head>
<body>

<div id="app" class="container">
    <div class="info-panel">
        <div class="stat"><strong>TOTAL CENSO</strong><h2 id="tVotos">0</h2></div>
        <div class="stat" style="background: #10b981;"><strong>ZONA L√çDER</strong><h2 id="topComuna">-</h2></div>
        <div class="stat" style="background: #f59e0b;"><strong>META 5.000</strong><h2 id="pMeta">0%</h2></div>
    </div>

    <div class="card">
        <h3 style="margin-top:0">üó∫Ô∏è MAPA DE CALOR: CONCENTRACI√ìN DE VOTOS POR COMUNA</h3>
        <div id="map"></div>
    </div>
</div>

<script>
    const SB_URL = 'https://pmwlkdariynhaqbqursp.supabase.co';
    const SB_KEY = 'sb_publishable_zCu9cBa2qf9HqQuZ2YufzA_yTmwfiHv';
    const _supabase = supabase.createClient(SB_URL, SB_KEY);

    let baseDatos = [], map, geoJsonLayer;

    // Matriz de resoluci√≥n completa
    const MATRIZ = {
        "1": ["ACEVEDO", "GOMEZ", "MUTIS", "CELESTINO", "TERRON"],
        "2": ["CAM", "FRANCIA", "LA FLORA", "VIPASA", "VERSALLES"],
        "7": ["MALLARINO", "10 DE MAYO", "CELMIRA", "PUMAREJO"],
        "12": ["SANTA FE", "VILLA DEL SUR", "SINDICAL", "FENALCO"],
        "19": ["CIEGOS", "SORDOS", "COLISEO", "PASCUAL", "ESTADIO", "LIDO"],
        "20": ["SILOE", "MULTIPROPOSITO", "LLERAS"],
        "22": ["ICESI", "JAVERIANA", "PANCE", "BERCHMANS"]
    };

    async function iniciar() {
        const { value: pass } = await Swal.fire({ title: 'ACCESO MAPA', input: 'password', confirmButtonColor: '#0f172a' });
        if(pass === 'ADMIN2026') { 
            document.getElementById('app').style.display = 'block'; 
            initMap(); 
            await cargarDatos(); 
        }
    }

    function initMap() {
        map = L.map('map').setView([3.4372, -76.5225], 12);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png').addTo(map);
    }

    async function cargarDatos() {
        const { data } = await _supabase.from('VOTANTES').select('puesto');
        const conteo = {};
        
        data.forEach(v => {
            const p = (v.puesto || "").toUpperCase();
            for(let [c, claves] of Object.entries(MATRIZ)) {
                if(claves.some(k => p.includes(k))) {
                    conteo[c] = (conteo[c] || 0) + 1;
                    break;
                }
            }
        });

        actualizarStats(data.length, conteo);
        cargarPoligonos(conteo);
    }

    function actualizarStats(total, conteo) {
        document.getElementById('tVotos').innerText = total;
        document.getElementById('pMeta').innerText = ((total/5000)*100).toFixed(1) + "%";
        
        let maxC = "-", maxV = 0;
        for(let c in conteo) { if(conteo[c] > maxV) { maxV = conteo[c]; maxC = "COMUNA " + c; } }
        document.getElementById('topComuna').innerText = maxC;
    }

    function getColor(v, max) {
        if (v === 0) return '#f1f5f9';
        return v > max * 0.75 ? '#b91c1c' : // Rojo oscuro (Caliente)
               v > max * 0.50 ? '#f97316' : // Naranja
               v > max * 0.25 ? '#fbbf24' : // Amarillo
                                '#fde68a';   // Amarillo claro
    }

    function cargarPoligonos(conteo) {
        const maxV = Math.max(...Object.values(conteo), 1);
        
        // URL de GeoJSON oficial de Cali (Comunas)
        fetch('https://raw.githubusercontent.com/skatpe/cali-geojson/master/comunas.json')
        .then(res => res.json())
        .then(geojson => {
            geoJsonLayer = L.geoJson(geojson, {
                style: function(feature) {
                    const c = feature.properties.comuna || feature.properties.nombre;
                    // Limpiamos el nombre para que coincida con nuestra matriz (ej: "Comuna 7" -> "7")
                    const idC = c.toString().replace(/\D/g, ""); 
                    return {
                        fillColor: getColor(conteo[idC] || 0, maxV),
                        weight: 2,
                        opacity: 1,
                        color: 'white',
                        fillOpacity: 0.7
                    };
                },
                onEachFeature: function(feature, layer) {
                    const idC = (feature.properties.comuna || "").toString().replace(/\D/g, "");
                    layer.bindPopup(`<b>COMUNA ${idC}</b><br>Votos: ${conteo[idC] || 0}`);
                }
            }).addTo(map);
        });
    }

    iniciar();
</script>
</body>
</html>
